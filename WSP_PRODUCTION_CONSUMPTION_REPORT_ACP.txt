 

ALTER   PROC [dbo].[WSP_PRODUCTION_CONSUMPTION_REPORT_ACP]
	
	--DECLARE
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIVISION VARCHAR(100)='%',
	@WAREHOUSE VARCHAR(1000)='%',
	@PRODUCTIONITEM VARCHAR(100)='%'
	AS

	--SELECT @DATE1='2022-01-01' ,@DATE2='2023-08-10'


		 IF OBJECT_ID('TEMPDB..#DATA') is not null drop table #DATA
		 IF OBJECT_ID('TEMPDB..#RESULT') is not null drop table #RESULT

	SELECT IM.VCHRNO,IM.TRNDATE,IM.BSDATE,IM.REFBILL,IVP.MCODE PRODUCTION_ITEM,IVP.RATE PDRATE,IVP.REALQTY_IN,IVP.BASEUNIT ,IVP.WAREHOUSE PD_WAREHOUSE ,IVC.MCODE CONSUMPTION_ITEM,IVC.WAREHOUSE PC_WAREHOUSE
	 ,IVC.RATE CONS_RATE,IVC.RealQty,
	IVC.BASEUNIT CONS_UNIT ,IVC.REMARKS,ROW_NUMBER() OVER(PARTITION BY IM.VCHRNO,IVP.MCODE ORDER BY IM.VCHRNO,IM.TRNDATE) XNO INTO #DATA FROM INVMAIN IM JOIN INVPROD IVP ON  IM.VCHRNO=IVP.VCHRNO  AND IVP.REALQTY_IN>0
	JOIN INVPROD IVC ON IVC.RealQty>0 AND IVC.VCHRNO=IM.VCHRNO and 
	 ( (ivp.mcode=ivc.MasterMCode) OR (IVC.MasterMCode IS NULL OR 1=1)  )
	 WHERE IM.VoucherType='PD'
	 AND IM.TRNDATE BETWEEN @DATE1 AND @DATE2
	 AND IM.DIVISION LIKE @DIVISION
	 AND IVP.WAREHOUSE LIKE @WAREHOUSE
	 AND IVP.MCODE LIKE @PRODUCTIONITEM
   
	 SELECT    IIF(XNO=1,CONVERT(VARCHAR(100),sn),'')SN,  IIF(XNO=1,VCHRNO ,'')ENTRY_NO ,IIF(XNO=1,FORMAT(TRNDATE,'dd-MM-yyyy'),'')  DATE,
	 IIF(XNO=1,A.BSDATE,'') BSDATE,
IIF(XNO=1,A.REFBILL,'') REFNO,IIF(XNO=1,DESCA,'')  DESCA, IIF(XNO=1,A.PD_WAREHOUSE,'')  PD_WAREHOUSE,  IIF(XNO=1,CONVERT(VARCHAR(100),A.PDRATE),'')  PDRATE ,IIF(XNO=1,CONVERT(VARCHAR(100),A.REALQTY_IN),'') PDQTY,IIF(XNO=1,A.BASEUNIT ,'')PDUNIT,A.CONSUMPTION_ITEM,A.PC_WAREHOUSE,A.CONS_RATE ,A.RealQty CON_QTY ,A.CONS_UNIT,A.REMARKS,count(*) over() ALLCOUNT   FROM
	    
	 (
	 select  RWN.ROWN SN ,A.VCHRNO  ,  A.TRNDATE,A.BSDATE,
	  A.REFBILL ,PDM.DESCA, A.PD_WAREHOUSE, A.PDRATE ,A.REALQTY_IN  ,A.BASEUNIT  ,PDC.DESCA CONSUMPTION_ITEM,A.PC_WAREHOUSE,A.CONS_RATE ,A.RealQty   ,A.CONS_UNIT,A.REMARKS,'A' FLG ,A.XNO from #DATA A JOIN MENUITEM PDM ON PDM.MCODE=A.PRODUCTION_ITEM
	 JOIN MENUITEM PDC ON PDC.MCODE=A.CONSUMPTION_ITEM
	 JOIN (SELECT   DISTINCT ROW_NUMBER() OVER(  ORDER BY VCHRNO) AS ROWN , VCHRNO FROM #DATA GROUP BY VCHRNO)RWN 
	 ON A.VCHRNO=RWN.VCHRNO
	  UNION
	  

	   select DISTINCT   RWN.ROWN   , A.VCHRNO ENTRY_NO ,FORMAT( TRNDATE,'dd-MM-yyyy') DATE,NULL BSDATE,
	NULL REFNO,NULL DESCA,  NULL PD_WAREHOUSE,  NULL PDRATE ,NULL PDQTY, NULL   PDUNIT,NULL CONSUMPTION_ITEM,NULL PC_WAREHOUSE,NULL CONS_RATE ,NULL CON_QTY , NULL  CONS_UNIT, NULL  REMARKS ,'ZZZZZZ' FLG ,'999'XNO from #DATA A  JOIN (SELECT   DISTINCT ROW_NUMBER() OVER(  ORDER BY VCHRNO) AS ROWN , VCHRNO FROM #DATA GROUP BY VCHRNO)RWN  
	 ON A.VCHRNO=RWN.VCHRNO
	  ) A
	
	 ORDER BY VCHRNO ,  FLG,XNO,TRNDATE

	  

	   