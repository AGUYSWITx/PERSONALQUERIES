CREATE OR ALTER PROC WSP_DEPRECIATION_REPORTS
--DECLARE
@PHISCALID VARCHAR(25)='%',
@MODE TINYINT=1 ,-- 1 : POOL WISE || 2 BLOCK WISE 
@SUMMARY BIT =1, --1 SUMMARY,0 DETAIL
@TAXWISE BIT=0 ,
@POOL  VARCHAR(25)='%'

--SELECT @PHISCALID='79/80',@MODE=2,@SUMMARY=0,@TAXWISE=1,@POOL='%'
AS
IF @TAXWISE =1 
SET @POOL='%'
	IF OBJECT_ID('tempdb..#DATA') is not null drop table #DATA
 SELECT AG.GROUPNAME [POOL],AG.DEPRECIATIONRATE,AM.AssetID,AM.ACID ACID,AM.MCODE,   CASE WHEN MON=0 THEN  BOOKVALUE ELSE 0 END  Openingbalance ,    CASE WHEN MON between 1 and 6 THEN   ISNULL(BOOKVALUE,0) ELSE 0 END  UPTOPOUSH,    CASE WHEN MON between 7 and 9 THEN   ISNULL(BOOKVALUE,0) ELSE 0 END  UPTOCHAITRA,   CASE WHEN MON between 10 and 12 THEN   ISNULL(BOOKVALUE,0) ELSE 0 END  UPTOASHAD,   ISNULL(BOOKVALUE,0)  TOTAL    
 ,AD.MON  ,   
 CASE WHEN MON between 1 and 6 THEN   ISNULL((100 *BOOKVALUE)/100,0) ELSE 0 END   AB_UPTOPOUSH,  --ABSORBED
 CASE WHEN MON between 7 and 9 THEN    (66 *isnull(BOOKVALUE,0))/100  ELSE 0 END  AB_UPTOCHAITRA,  
 CASE WHEN MON between 10 and 12 THEN   ISNULL((33 *BOOKVALUE)/100,0) ELSE 0 END   AB_UPTOASHAD, 
 CASE WHEN MON between 1 and 6 THEN   ISNULL(((100-100 ) *BOOKVALUE)/100,0) ELSE 0 END   UN_UPTOPOUSH,  --UNABSORBED
 CASE WHEN MON between 7 and 9 THEN    ((100- 66) *isnull(BOOKVALUE,0))/100  ELSE 0 END  UN_UPTOCHAITRA,  
 CASE WHEN MON between 10 and 12 THEN   ISNULL(((100-33) *BOOKVALUE)/100,0) ELSE 0 END   UN_UPTOASHAD,
 
 CASE WHEN MON between 0 and 6 THEN   ISNULL((100 *BOOKVALUE)/100,0) *AG.DEPRECIATIONRATE/100 ELSE 0 END   DP_UPTOPOUSH,  --DEPRECIATION AC
 CASE WHEN MON between 7 and 9 THEN    (66 *isnull(BOOKVALUE,0))/100*AG.DEPRECIATIONRATE/100  ELSE 0 END  DP_UPTOCHAITRA,  
 CASE WHEN MON between 10 and 12 THEN   ISNULL((33 *BOOKVALUE)/100,0) *AG.DEPRECIATIONRATE/100 ELSE 0 END   DP_UPTOASHAD, 
 RA.ACNAME
 into #DATA
 FROM   ASSETCODE_MASTER AM LEFT JOIN ASSETCODE_DETAIL AD ON AM.ASSETID=AD.ASSETID AND AM.BATCHCODE=AD.BATCHCODE AND AM.MCODE=AD.MCODE
 LEFT JOIN
 ASSET_GROUP_LEDGER AGL WITH(NOLOCK)  ON AGL.ACID=AM.ACID 
 LEFT JOIN ASSET_GROUP AG  WITH(NOLOCK) ON  AG.ASSETGROUPID=AGL.ASSETGROUPID
 LEFT JOIN RMD_ACLIST RA WITH(NOLOCK) ON RA.ACID=AM.ACID 
 LEFT JOIN BATCHPRICE_MASTER_ASSET BMA ON BMA.BATCHCODE=AM.BATCHCODE and BMA.MCODE=AM.MCODE
	WHERE PHISCALID=@PHISCALID
 and    AG.AssetGroupID LIKE @POOL 
    
	--TAXWISE FORMAT
	      IF @TAXWISE= 1
   BEGIN 
 	SELECT  [POOL], 'OPENING WDV' PARTICULARS, DEPRECIATIONRATE,   SUM(  Openingbalance  ) BOOKVALUE_AS_OF_SHRAWAN ,   
	NULL  ADDITION , NULL SALES,  SUM(  Openingbalance  ) DEPRECIATION_BASE_VALUE,
 SUM(DEPRECIATIONRATE* Openingbalance 
/100) DEPRECIATION    ,

SUM(Openingbalance-(DEPRECIATIONRATE* Openingbalance 
/100)) BOOKVALUE,
NULL UNABSORBED,
NULL UNABSORBEDREPAIR,
NULL WDV_NEXTYEAR,'A'FFLG,[POOL] POOLX
 
 FROM #DATA 
	GROUP BY  [POOL], DEPRECIATIONRATE    
	UNION ALL

	SELECT  NULL [POOL], 'SHRAWAN-POUSH' PARTICULARS, DEPRECIATIONRATE,  NULL BOOKVALUE_AS_OF_SHRAWAN ,   
	 SUM(  UPTOPOUSH  )  ADDITION , NULL SALES,  SUM(  AB_UPTOPOUSH  ) DEPRECIATION_BASE_VALUE,
 SUM(DEPRECIATIONRATE* AB_UPTOPOUSH 
/100) DEPRECIATION    ,

SUM(UPTOPOUSH-(DEPRECIATIONRATE* UPTOPOUSH 
/100)) BOOKVALUE,
 NULL UNABSORBED,
NULL UNABSORBEDREPAIR,
NULL WDV_NEXTYEAR,'B'FFLG,[POOL] POOLX
 
 FROM #DATA 
	GROUP BY  [POOL], DEPRECIATIONRATE      
	 
	 	UNION ALL

	SELECT  NULL  [POOL], 'MAGH-CHAITRA' PARTICULARS, DEPRECIATIONRATE,  NULL BOOKVALUE_AS_OF_SHRAWAN ,   
	 SUM(  UPTOCHAITRA  )  ADDITION , NULL SALES,  SUM(  AB_UPTOCHAITRA  ) DEPRECIATION_BASE_VALUE,
 SUM(DEPRECIATIONRATE* AB_UPTOCHAITRA 
/100) DEPRECIATION    ,

SUM(AB_UPTOCHAITRA-(DEPRECIATIONRATE* AB_UPTOCHAITRA 
/100)) BOOKVALUE,
SUM(UN_UPTOPOUSH+UN_UPTOCHAITRA+UN_UPTOASHAD) UNABSORBED,
NULL UNABSORBEDREPAIR,
SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  WDV_NEXTYEAR ,'C' FFLG,[POOL] POOLX
 
 FROM #DATA 
	GROUP BY  [POOL], DEPRECIATIONRATE      
	UNION ALL

	SELECT  NULL  [POOL], 'BAISAKH-ASHAD' PARTICULARS, DEPRECIATIONRATE,  NULL BOOKVALUE_AS_OF_SHRAWAN ,   
	 SUM(  UPTOASHAD  )  ADDITION , NULL SALES,  SUM(  AB_UPTOASHAD ) DEPRECIATION_BASE_VALUE,
 SUM(DEPRECIATIONRATE* AB_UPTOASHAD 
/100) DEPRECIATION    ,

SUM(AB_UPTOASHAD-(DEPRECIATIONRATE* AB_UPTOASHAD 
/100)) BOOKVALUE,
NULL UNABSORBED,
NULL UNABSORBEDREPAIR,
NULL WDV_NEXTYEAR,'D' FFLG,[POOL] POOLX
 
 FROM #DATA 
	GROUP BY  [POOL], DEPRECIATIONRATE      


	UNION ALL

	SELECT   NULL [POOL],  NULL PARTICULARS, DEPRECIATIONRATE,  SUM(Openingbalance) BOOKVALUE_AS_OF_SHRAWAN ,   
	 SUM(  UPTOPOUSH+UPTOCHAITRA+UPTOASHAD  )  ADDITION , NULL SALES,  SUM( AB_UPTOPOUSH+AB_UPTOCHAITRA+ AB_UPTOASHAD ) DEPRECIATION_BASE_VALUE,
SUM(DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION    ,

SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  BOOKVALUE,
SUM(UN_UPTOPOUSH+UN_UPTOCHAITRA+UN_UPTOASHAD)  UNABSORBED,
NULL UNABSORBEDREPAIR,
SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  WDV_NEXTYEAR,'E' FFLG,[POOL] POOLX
 
 FROM #DATA 
	GROUP BY  [POOL], DEPRECIATIONRATE      
	UNION ALL

		SELECT   'TOTAL' [POOL],  NULL PARTICULARS, NULL DEPRECIATIONRATE,  SUM(Openingbalance) BOOKVALUE_AS_OF_SHRAWAN ,   
	 SUM(  UPTOPOUSH+UPTOCHAITRA+UPTOASHAD  )  ADDITION , NULL SALES,  SUM( AB_UPTOPOUSH+AB_UPTOCHAITRA+ AB_UPTOASHAD ) DEPRECIATION_BASE_VALUE,
SUM(DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION    ,

SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  BOOKVALUE,
SUM(UN_UPTOPOUSH+UN_UPTOCHAITRA+UN_UPTOASHAD)  UNABSORBED,
NULL UNABSORBEDREPAIR,
SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  WDV_NEXTYEAR,'Z' FFLG,'ZZZZZZZZZ' POOLX
 
 FROM #DATA 

 
	 select null
	 END


	 ELSE
	 BEGIN

	 
	 IF (@MODE=1 AND @SUMMARY=0)
BEGIN
	SELECT  [POOL], DEPRECIATIONRATE,   SUM(  Openingbalance  ) Openingbalance ,   
	SUM(UPTOPOUSH)  UPTOPOUSH, 
	SUM(UPTOCHAITRA)   UPTOCHAITRA,
	SUM(UPTOASHAD) UPTOASHAD, 
	SUM (TOTAL) TOTAL  ,
	SUM(AB_UPTOPOUSH)  AB_UPTOPOUSH, 
	SUM(AB_UPTOCHAITRA)   AB_UPTOCHAITRA,
	SUM(AB_UPTOASHAD) AB_UPTOASHAD,
	SUM(UN_UPTOPOUSH)  UN_UPTOPOUSH, 
	SUM(UN_UPTOCHAITRA)   UN_UPTOCHAITRA,
	SUM(UN_UPTOASHAD) UN_UPTOASHAD ,SUM(DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION_FOR_THE_YEAR ,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  CLOSING_BALANCE FROM #DATA 
	GROUP BY  [POOL], DEPRECIATIONRATE      


		SELECT  NULL [POOL], NULL DEPRECIATIONRATE,   SUM(  Openingbalance  ) Openingbalance ,   
	SUM(UPTOPOUSH)  UPTOPOUSH, 
	SUM(UPTOCHAITRA)   UPTOCHAITRA,
	SUM(UPTOASHAD) UPTOASHAD, 
	SUM (TOTAL) TOTAL  ,
	SUM(AB_UPTOPOUSH)  AB_UPTOPOUSH, 
	SUM(AB_UPTOCHAITRA)   AB_UPTOCHAITRA,
	SUM(AB_UPTOASHAD) AB_UPTOASHAD,
	SUM(UN_UPTOPOUSH)  UN_UPTOPOUSH, 
	SUM(UN_UPTOCHAITRA)   UN_UPTOCHAITRA,
	SUM(UN_UPTOASHAD) UN_UPTOASHAD ,SUM(DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION_FOR_THE_YEAR ,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) CLOSING_BALANCE FROM #DATA 
	     

	END

	 IF (@MODE=1 AND @SUMMARY=1)
	 BEGIN
	SELECT  [POOL], DEPRECIATIONRATE,   SUM(  Openingbalance  ) Openingbalance ,   
	SUM(UPTOPOUSH+UPTOCHAITRA+UPTOASHAD)  ADDITION ,
	SUM (TOTAL) TOTAL  ,
	SUM(AB_UPTOPOUSH+AB_UPTOCHAITRA+AB_UPTOASHAD)  ABSORBED, 
	SUM(UN_UPTOPOUSH+UN_UPTOCHAITRA+UN_UPTOASHAD)   UNABSORBED   ,
	SUM(DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION_FOR_THE_YEAR ,
	SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  CLOSING_BALANCE FROM #DATA 
	GROUP BY  [POOL], DEPRECIATIONRATE      
	
	SELECT NULL  [POOL], NULL DEPRECIATIONRATE,   SUM(  Openingbalance  ) Openingbalance ,   
	SUM(UPTOPOUSH+UPTOCHAITRA+UPTOASHAD)  ADDITION ,
	SUM (TOTAL) TOTAL  ,
	SUM(AB_UPTOPOUSH+AB_UPTOCHAITRA+AB_UPTOASHAD)  ABSORBED, 
	SUM(UN_UPTOPOUSH+UN_UPTOCHAITRA+UN_UPTOASHAD)   UNABSORBED   ,
	SUM(DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION_FOR_THE_YEAR 
	,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  CLOSING_BALANCE FROM #DATA 
	 
	END
	 IF (@MODE=2 AND @SUMMARY=1)
   BEGIN
  SELECT POOL,POOL ACNAME,NULL ACID,DepreciationRate,SUM(Openingbalance)Openingbalance,SUM(UPTOASHAD+UPTOCHAITRA+UPTOPOUSH)  ADDITION,NULL SALES, SUM(TOTAL)TOTAL ,SUM(AB_UPTOASHAD+AB_UPTOCHAITRA+AB_UPTOPOUSH) ABSORBED,SUM(UN_UPTOASHAD+UN_UPTOCHAITRA+UN_UPTOPOUSH)UNABSORBED,SUM (DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION_FOR_THE_YEAR,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) CLOSING_BALANCE,'A' FFLG FROM #DATA GROUP BY POOL ,DepreciationRate
	 UNION ALL
  SELECT POOL	,ACNAME,ACID,	DepreciationRate,	SUM(Openingbalance)Openingbalance,	SUM(UPTOASHAD+UPTOCHAITRA+UPTOPOUSH) ADDITION	,NULL SALES	,SUM(TOTAL) TOTAL,	SUM(AB_UPTOASHAD+AB_UPTOCHAITRA+AB_UPTOPOUSH) ABSORBED	,SUM(UN_UPTOASHAD+UN_UPTOCHAITRA+UN_UPTOPOUSH) UNABSORBED,SUM (DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  	DEPRECIATION_FOR_THE_YEAR	,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  CLOSING_BALANCE ,'B' FFLG
  FROM #DATA GROUP BY POOL	,ACNAME,ACID,	DepreciationRate
  ORDER BY POOL,FFLG
	

	 SELECT NULL POOL,NULL ACNAME,NULL ACID,NULL DepreciationRate,SUM(Openingbalance)Openingbalance,SUM(UPTOASHAD+UPTOCHAITRA+UPTOPOUSH)  ADDITION,NULL SALES, SUM(TOTAL)TOTAL ,SUM(AB_UPTOASHAD+AB_UPTOCHAITRA+AB_UPTOPOUSH) ABSORBED,SUM(UN_UPTOASHAD+UN_UPTOCHAITRA+UN_UPTOPOUSH)UNABSORBED,SUM (DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION_FOR_THE_YEAR,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) CLOSING_BALANCE,'A' FFLG FROM #DATA  
	  
  ORDER BY POOL,FFLG
	END



   IF  (@MODE=2 AND @SUMMARY=0)
   BEGIN
  SELECT POOL,POOL ACNAME,NULL ACID,DepreciationRate,SUM(Openingbalance)Openingbalance,SUM(UPTOASHAD)UPTOASHAD,sum(UPTOCHAITRA)UPTOCHAITRA,sum(UPTOPOUSH)UPTOPOUSH,    NULL SALES, SUM(TOTAL)TOTAL ,SUM(AB_UPTOASHAD)AB_UPTOASHAD,sum(AB_UPTOCHAITRA)AB_UPTOCHAITRA,sum(AB_UPTOPOUSH) AB_UPTOPOUSH,SUM(UN_UPTOASHAD) UN_UPTOASHAD,sum(UN_UPTOCHAITRA)UN_UPTOCHAITRA,sum(UN_UPTOPOUSH)UN_UPTOPOUSH,SUM (DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) DEPRECIATION_FOR_THE_YEAR,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD) CLOSING_BALANCE,'A' FFLG FROM #DATA GROUP BY POOL ,DepreciationRate
	 UNION ALL
  SELECT POOL	,ACNAME,ACID,	DepreciationRate,	SUM(Openingbalance)Openingbalance,SUM(UPTOASHAD)UPTOASHAD,sum(UPTOCHAITRA)UPTOCHAITRA,sum(UPTOPOUSH)UPTOPOUSH,    NULL SALES, SUM(TOTAL)TOTAL ,SUM(AB_UPTOASHAD)AB_UPTOASHAD,sum(AB_UPTOCHAITRA)AB_UPTOCHAITRA,sum(AB_UPTOPOUSH) AB_UPTOPOUSH,SUM(UN_UPTOASHAD) UN_UPTOASHAD,sum(UN_UPTOCHAITRA)UN_UPTOCHAITRA,sum(UN_UPTOPOUSH)UN_UPTOPOUSH,SUM (DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  	DEPRECIATION_FOR_THE_YEAR	,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  CLOSING_BALANCE ,'B' FFLG
  FROM #DATA GROUP BY POOL	,ACNAME,ACID,	DepreciationRate
  ORDER BY POOL,FFLG
 

 SELECT  NULL POOL	, NULL ACNAME, NULL ACID,	 NULL DepreciationRate,	SUM(Openingbalance)Openingbalance,SUM(UPTOASHAD)UPTOASHAD,sum(UPTOCHAITRA)UPTOCHAITRA,sum(UPTOPOUSH)UPTOPOUSH,    NULL SALES, SUM(TOTAL)TOTAL ,SUM(AB_UPTOASHAD)AB_UPTOASHAD,sum(AB_UPTOCHAITRA)AB_UPTOCHAITRA,sum(AB_UPTOPOUSH) AB_UPTOPOUSH,SUM(UN_UPTOASHAD) UN_UPTOASHAD,sum(UN_UPTOCHAITRA)UN_UPTOCHAITRA,sum(UN_UPTOPOUSH)UN_UPTOPOUSH,SUM (DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  	DEPRECIATION_FOR_THE_YEAR	,SUM (TOTAL-DP_UPTOPOUSH+DP_UPTOCHAITRA+ DP_UPTOASHAD)  CLOSING_BALANCE ,'B' FFLG
  FROM #DATA  
 
 END
   
	 END
