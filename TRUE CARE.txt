 
ALTER TABLE BATCHPRICEMASTER ADD SUPCODE VARCHAR(100)

----
ALTER   PROCEDURE [dbo].[RSP_PROFITIBILITYSALESANALYSIS]
--declare
	@MGROUP VARCHAR(25) = '%',
	@DIVISION VARCHAR(3) = '%',
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@SUPPLIER_ACID VARCHAR(25) = '%',
	@SCHEME VARCHAR(15) = '%',
	@CHK_EXCLUDEVAT TINYINT = 0,          --ExcludeVat:1:0
	@OPT_WISE TINYINT = 0,              --Mgroup:0,Item:1,Date:2,Customer:3,MCat:4  
	@FYID VARCHAR(10) = '',
	@CHK_OLDFORMAT TINYINT = 0,                       --OldFomrat:1:0
	@SALESTERMINAL VARCHAR(3) ='%',
	@TRNMODE VARCHAR(50) = '%'
AS
--select  @MGROUP=N'%',@DIVISION=N'%',@DATE1='2023-06-01 00:00:00',@DATE2='2023-06-15 00:00:00',@SUPPLIER_ACID=N'%' ,@FYID='79/80' ,@OPT_WISE=4


IF @TRNMODE = 'ALL' 
	SET @TRNMODE = '%'
	DECLARE @BATCH TINYINT =(SELECT ENABLEBATCH FROM SETTING)
 
IF (@BATCH=1 )
BEGIN
DECLARE @REPORTYTYPE TINYINT

SET @REPORTYTYPE=(CASE @OPT_WISE WHEN 0 
THEN   1
WHEN 1 THEN    0
WHEN 2 THEN    4
WHEN 4 THEN    2
END)


EXEC [dbo].[WSP_PROFITABILITY_SALES_ANALYSIS_REPORT]
@MGROUP=@MGROUP,
@DIV=@DIVISION,
@DATE1 = @DATE1,
@DATE2 = @DATE2, 
@ACID=@SUPPLIER_ACID,
@PHISCALID='%',
@REPORTYTYPE=@REPORTYTYPE
 
 END
 ELSE
 BEGIN
IF @CHK_OLDFORMAT = 0
	EXEC [dbo].[NSP_PROFITIBILITYSALESANALYSIS_COGS]
		@MGROUP = @MGROUP,
		@DIV = @DIVISION,
		@DATE1 = @DATE1,
		@DATE2 = @DATE2,
		@SCHEME = @SCHEME,
		@PARTY = @SUPPLIER_ACID,
		@EXVAT = @CHK_EXCLUDEVAT,
		@Flg = @OPT_WISE,
		@SALESTERMINAL = @SALESTERMINAL,
		@TRNMODE = @TRNMODE
ELSE
	EXEC [dbo].[NSP_PROFITIBILITYSALESANALYSIS]
		@MGROUP = @MGROUP,
		@DIV = @DIVISION,
		@DATE1 = @DATE1,
		@DATE2 = @DATE2,
		@SCHEME = @SCHEME,
		@PARTY = @SUPPLIER_ACID,
		@EXVAT = @CHK_EXCLUDEVAT,
		@Flg = @OPT_WISE
 END





CREATE OR ALTER       PROCEDURE [dbo].[WSP_PROFITABILITY_SALES_ANALYSIS_REPORT]
 --DECLARE
	@DATE1 DATE ,
	@DATE2 DATE ,
	@DIV VARCHAR(3) = '%',
	@COMID VARCHAR(25) = '%',
	@PHISCALID VARCHAR(25) = '%',
	@MGROUP VARCHAR(25) = '%',
	@MCAT VARCHAR(50) = '%',
	@PTYPE INT = 100,
	@ACID VARCHAR(25) = '%',
	@REPORTYTYPE TINYINT = 0,	--0 ITEM WISE, 1 MAJOR GROUP, 2 CATEGORY WISE , 3 SUPPLIER WISE,  4 DAY WISE
	@SHOWITEMDETAIL TINYINT = 0,   -- 0 WITHOUT ITEM DETAIL, 1 WITH ITEM DETAIL
	@SALESMAN NUMERIC = 0,
	@SALESTYPE TINYINT = 0		-- 0 ALL | 1 RETAIL ONLY | 2 WHOLESALES ONLY 
AS
 --select  @MGROUP=N'%',@DIV=N'%',@DATE1='2023-06-01 00:00:00',@DATE2='2023-06-15 00:00:00',@ACID=N'%'   


set nocount on
 

--SET @DATE1=N'2022-12-01' ; SET @DATE2=N'2023-12-23' ; SET @PHISCALID=N'79/80' ; SET @COMID=N' ' ; SET @DIV=N'%' ; SET @ACID=N'%' ; SET @PTYPE=100 ; SET @MCAT=N'%' ; SET @MGROUP=N'%' ; SET @SHOWITEMDETAIL=0 ; SET @REPORTYTYPE=N'0' ; SET @SALESMAN=0 ; SET @SALESTYPE=N'0'

	DECLARE @SINGLEBATCH INT = 0
	SELECT @SINGLEBATCH = ISNULL(ENABLESINGLEBATCHMODE,0) FROM SETTING

	IF OBJECT_ID('TEMPDB..#PROFITABILITY') IS NOT NULL DROP TABLE #PROFITABILITY
	CREATE TABLE #PROFITABILITY (MGROUP varchar(100),MCODE varchar(100),MENUCODE varchar(50),ITEMNAME varchar(600),UNIT VARCHAR(25),SALESQTY numeric(30,4),RETURNQTY  numeric(30,4),NETSALESQTY  numeric(30,4),SALESAMOUNT  numeric(30,12),SALESRETURNAMOUNT  numeric(30,12),DISCOUNT  numeric(30,12),NETSALESAMOUNT  numeric(30,12),COSTPRICE   numeric(30,12),TRNDATE datetime,PARAC varchar(50),MCAT varchar(50))

	if (@REPORTYTYPE<3)
	    begin
				IF OBJECT_ID('TEMPDB..#SALESRECORD') IS NOT NULL DROP TABLE #SALESRECORD

				SELECT B.MCODE,SUM(B.AMOUNT)AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(B.TAXABLE)TAXABLE,SUM(B.NONTAXABLE)NONTAXABLE,SUM(B.REALQTY_IN) REALQTY_IN,SUM(B.REALQTY)REALQTY,B.BATCH,B.VoucherType,X.VNO,B.PRATE,B.SALESMANID INTO #SALESRECORD FROM RMD_TRNMAIN A WITH(NOLOCK) INNER JOIN RMD_tRNPROD B WITH(NOLOCK) ON A.VCHRNO = B.VCHRNO 

				LEFT JOIN (SELECT DISTINCT VNO FROM BILLTENDER WITH(NOLOCK)) X ON A.VCHRNO = X.VNO WHERE LEFT(A.VCHRNO,2) IN ('SI','TI','CN','RE','RR') AND A.DIVISION LIKE @DIV AND A.TRNDATE BETWEEN @DATE1 AND @DATE2  AND A.PHISCALID LIKE @PHISCALID

				GROUP BY B.MCODE,B.BATCH,B.VoucherType,X.VNO,B.PRATE,B.SALESMANID


				insert INTO #PROFITABILITY (MGROUP,MCODE,MENUCODE,ITEMNAME,UNIT,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,MCAT)
				select  MGROUP,A.MCODE,MENUCODE,DESCA,BASEUNIT,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,
				SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT) NETSALESAMOUNT,
				COSTPRICE = SUM(A.NETSALESQTY * CASE WHEN A.PTYPE <> 9 AND @SINGLEBATCH <> 1 THEN A.LANDINGCOST ELSE CASE WHEN ISNULL(A.PRATE,0) = 0 THEN A.CRATE ELSE ISNULL(A.PRATE,0) END END),MCAT
				from (
					SELECT A.MCODE,D.MENUCODE,D.DESCA,D.BASEUNIT,
						SALESQTY = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RE') THEN REALQTY - REALQTY_IN ELSE 0 END),
						RETURNQTY = SUM(CASE WHEN A.VOUCHERTYPE IN ('CN','RR') THEN REALQTY_IN - REALQTY ELSE 0 END),
						NETSALESQTY= SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RR','CN','RE') THEN REALQTY - REALQTY_IN ELSE 0 END) ,
						SALESAMOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RE') THEN CASE WHEN A.VOUCHERTYPE IN ('SI','TI') THEN (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL(A.DISCOUNT,0)) ELSE (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL(A.DISCOUNT,0))*-1 END ELSE 0 END),
						SALESRETURNAMOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('CN','RR') THEN CASE WHEN A.VOUCHERTYPE = 'CN' THEN (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL(A.DISCOUNT,0)) ELSE (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL (A.DISCOUNT,0))*-1 END ELSE 0 END),
						DISCOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RR') THEN A.DISCOUNT ELSE A.DISCOUNT*-1 END),
						NETSALESAMOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RR') THEN ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0) ELSE (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0))*-1 END),
						ISNULL(D.MGROUP,'')MGROUP,ISNULL(D.MCAT,'')MCAT,D.CRATE,A.PRATE,D.PTYPE,C.LANDINGCOST	
					FROM #SALESRECORD A  					
					LEFT JOIN BATCHPRICE_MASTER C WITH(NOLOCK) ON A.MCODE = C.MCODE AND A.BATCH = C.BATCHCODE INNER JOIN MENUITEM D WITH(NOLOCK) ON A.MCODE = D.MCODE
					WHERE ((D.PTYPE >= 9 AND ISNULL(D.SUPCODE,'') LIKE @ACID) OR (D.PTYPE < 9 AND ISNULL(C.SUPCODE,'') LIKE @ACID))
					AND ((@SALESTYPE=0 AND ISNULL(A.VNO,'') LIKE '%') OR (@SALESTYPE=1 AND ISNULL(A.VNO,'')<>'') OR (@SALESTYPE=2 AND ISNULL(A.VNO,'')=''))
					AND ISNULL(D.MGROUP,'') LIKE @MGROUP AND ISNULL(D.MCAT,'') LIKE @MCAT AND	((@PTYPE = 100 AND ISNULL(D.PTYPE,0) < @PTYPE) OR (@PTYPE <> 100 AND ISNULL(D.PTYPE,0) = @PTYPE))
					AND ((@SALESMAN = 0 AND ISNULL(A.SALESMANID,0)<=1000000) OR  (@SALESMAN <> 0 AND ISNULL(A.SALESMANID,0)= @SALESMAN))
					GROUP BY A.MCODE,C.LANDINGCOST,A.PRATE,ISNULL(D.MGROUP,''),D.DESCA,D.BASEUNIT,ISNULL(D.MGROUP,''),ISNULL(D.MCAT,''),D.CRATE,D.PTYPE,C.LANDINGCOST,D.MENUCODE,D.DESCA,D.BASEUNIT
					HAVING SUM(REALQTY) - SUM(REALQTY_IN) <> 0
				) A GROUP BY MGROUP,A.MCODE,MENUCODE,DESCA,BASEUNIT,MCAT
	         
			 
	    end
		
	else
		begin
			IF OBJECT_ID('TEMPDB..#SALESRECORD1') IS NOT NULL DROP TABLE #SALESRECORD1

			SELECT A.TRNDATE,B.MCODE,SUM(B.AMOUNT)AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(B.TAXABLE)TAXABLE,SUM(B.NONTAXABLE)NONTAXABLE,SUM(B.REALQTY_IN) REALQTY_IN,SUM(B.REALQTY)REALQTY,B.BATCH,B.VoucherType,X.VNO,B.PRATE,B.SALESMANID INTO #SALESRECORD1 FROM RMD_TRNMAIN A WITH(NOLOCK) INNER JOIN RMD_tRNPROD B WITH(NOLOCK) ON A.VCHRNO = B.VCHRNO 


			LEFT JOIN (SELECT DISTINCT VNO FROM BILLTENDER WITH(NOLOCK)) X ON A.VCHRNO = X.VNO WHERE LEFT(A.VCHRNO,2) IN ('SI','TI','CN','RE','RR') AND A.DIVISION LIKE @DIV AND A.TRNDATE BETWEEN @DATE1 AND @DATE2  AND A.PHISCALID = @PHISCALID
			GROUP BY B.MCODE,B.BATCH,B.VoucherType,X.VNO,B.PRATE,B.SALESMANID,A.TRNDATE

			--SELECT * FROM #SALESRECORD1


			insert into #PROFITABILITY(TRNDATE,PARAC,MCODE,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE)
			select  A.TRNDATE,A.PARAC,A.MCODE,A.MENUCODE,A.DESCA,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(a.DISCOUNT)DISCOUNT,
			SUM(NETSALESAMOUNT) NETSALESAMOUNT,
			COSTPRICE = SUM(A.NETSALESQTY * CASE WHEN A.PTYPE <> 9 AND @SINGLEBATCH <> 1 THEN A.LANDINGCOST ELSE CASE WHEN ISNULL(A.PRATE,0) = 0 THEN A.CRATE ELSE ISNULL(A.PRATE,0) END END)
			from (
					SELECT A.TRNDATE,A.MCODE,D.MENUCODE,D.DESCA,D.BASEUNIT,CASE WHEN D.PTYPE= 9 THEN ISNULL(D.SUPCODE,'') ELSE ISNULL(C.SUPCODE,'') END PARAC,
					SALESQTY = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RE') THEN REALQTY - REALQTY_IN ELSE 0 END),
					RETURNQTY = SUM(CASE WHEN A.VOUCHERTYPE IN ('CN','RR') THEN REALQTY_IN - REALQTY ELSE 0 END),
					NETSALESQTY= SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RR','CN','RE') THEN REALQTY - REALQTY_IN ELSE 0 END) ,
					SALESAMOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RE') THEN CASE WHEN A.VOUCHERTYPE IN ('SI','TI') THEN (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL(A.DISCOUNT,0)) ELSE (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL(A.DISCOUNT,0))*-1 END ELSE 0 END),
					SALESRETURNAMOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('CN','RR') THEN CASE WHEN A.VOUCHERTYPE = 'CN' THEN (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL(A.DISCOUNT,0)) ELSE (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0)+ISNULL (A.DISCOUNT,0))*-1 END ELSE 0 END),
					DISCOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RR') THEN A.DISCOUNT ELSE A.DISCOUNT*-1 END),
					NETSALESAMOUNT = SUM(CASE WHEN A.VOUCHERTYPE IN ('SI','TI','RR') THEN ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0) ELSE (ISNULL(A.TAXABLE,0)+ISNULL(A.NONTAXABLE,0))*-1 END),
					ISNULL(D.MGROUP,'')MGROUP,ISNULL(D.MCAT,'')MCAT,D.CRATE,A.PRATE,D.PTYPE,C.LANDINGCOST,D.TYPE		
					FROM #SALESRECORD1 A  					
					LEFT JOIN BATCHPRICE_MASTER C WITH(NOLOCK) ON A.MCODE = C.MCODE AND A.BATCH = C.BATCHCODE INNER JOIN MENUITEM D WITH(NOLOCK) ON A.MCODE = D.MCODE
					WHERE ((D.PTYPE >= 9 AND ISNULL(D.SUPCODE,'') LIKE @ACID) OR (D.PTYPE < 9 AND ISNULL(C.SUPCODE,'') LIKE @ACID))
					AND ((@SALESTYPE=0 AND ISNULL(A.VNO,'') LIKE '%') OR (@SALESTYPE=1 AND ISNULL(A.VNO,'')<>'') OR (@SALESTYPE=2 AND ISNULL(A.VNO,'')=''))
					AND ISNULL(D.MGROUP,'') LIKE @MGROUP AND ISNULL(D.MCAT,'') LIKE @MCAT AND	((@PTYPE = 100 AND ISNULL(D.PTYPE,0) < @PTYPE) OR (@PTYPE <> 100 AND ISNULL(D.PTYPE,0) = @PTYPE))
					AND ((@SALESMAN = 0 AND ISNULL(A.SALESMANID,0)<=1000000) OR  (@SALESMAN <> 0 AND ISNULL(A.SALESMANID,0)= @SALESMAN))
					GROUP BY A.MCODE,C.LANDINGCOST,A.PRATE,ISNULL(D.MGROUP,''),D.DESCA,D.BASEUNIT,ISNULL(D.MGROUP,''),ISNULL(D.MCAT,''),D.CRATE,D.PTYPE,C.LANDINGCOST,D.MENUCODE,D.DESCA,D.BASEUNIT, A.TRNDATE,
					CASE WHEN D.PTYPE= 9 THEN ISNULL(D.SUPCODE,'') ELSE ISNULL(C.SUPCODE,'') END,D.TYPE
					HAVING SUM(REALQTY) - SUM(REALQTY_IN) <> 0
				) A group by A.MCODE,A.MENUCODE,A.DESCA,A.trndate,A.parac
	    end

		--SELECT * FROM #PROFITABILITY

		
		IF OBJECT_ID('TEMPDB..#RESULT') IS NOT NULL DROP TABLE #RESULT
		IF OBJECT_ID('TEMPDB..#TOTAL') IS NOT NULL DROP TABLE #TOTAL

		CREATE TABLE #RESULT (MGROUP varchar(100),MCODE varchar(100),MENUCODE varchar(50),ITEMNAME varchar(600),UNIT VARCHAR(25), SALESQTY NUMERIC(30,4), RETURNQTY NUMERIC(30,4),NETSALESQTY numeric(30,4),SALESAMOUNT numeric(30,12),SALESRETURNAMOUNT numeric(30,12),DISCOUNT numeric(30,12),NETSALESAMOUNT numeric(30,12),COSTPRICE numeric(30,12),PROFIT numeric(30,12),trndate datetime,parac varchar(50),[MARGIN ON COST%] numeric(30,12),[MARGIN ON SALES%] numeric(30,12),MGROUP_NAME  varchar(500),ACNAME varchar(500),MCAT VARCHAR(1000))
		CREATE TABLE #TOTAL (SALESQTY NUMERIC(30,4), RETURNQTY NUMERIC(30,4),NETSALESQTY numeric(30,4),SALESAMOUNT numeric(30,12),SALESRETURNAMOUNT numeric(30,12),DISCOUNT numeric(30,12),NETSALESAMOUNT numeric(30,12),COSTPRICE numeric(30,12),PROFIT numeric(30,12),[MARGIN ON COST%] numeric(30,12),[MARGIN ON SALES%] numeric(30,12))

        IF @REPORTYTYPE=0		-------------ITEM WISE----------------------------------------
			begin	      
				insert into  #RESULT(MGROUP,MCODE,MENUCODE,ITEMNAME,UNIT,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
				select MGROUP,MCODE,MENUCODE,ITEMNAME,UNIT,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,NETSALESAMOUNT-COSTPRICE PROFIT,
				CASE WHEN COSTPRICE = 0 THEN 0 ELSE ((NETSALESAMOUNT-COSTPRICE)/COSTPRICE)*100.00 END [MARGIN ON COST%],
				CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE ((NETSALESAMOUNT-COSTPRICE)/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%] FROM #PROFITABILITY 
	            
				INSERT into #TOTAL
				select  SUM(SALESQTY)SALESQTY, SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE ,
						SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
				from #RESULT
			
				--RESULT
				select MENUCODE [ITEM CODE],ITEMNAME [ITEM NAME],UNIT,R.SALESQTY,R.RETURNQTY,R.NETSALESQTY [SALES QTY],FORMAT(ROUND((R.NETSALESQTY/T.NETSALESQTY)*100,2),'N2') [SALES CONTRIBUTION],FORMAT(r.SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(R.SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(R.DISCOUNT,'N2')DISCOUNT,
				FORMAT(R.NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(ROUND((R.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,2),'N2') [SALES AMOUNT CONTRIBUTION],FORMAT(R.COSTPRICE,'N2') COST,FORMAT(R.PROFIT,'N2')PROFIT,FORMAT(R.[MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT(R.[MARGIN ON SALES%],'N2')[MARGIN ON SALES%],
				FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,2) END,'N2') MARGIN_CONTRIBUTION_ON_COST,
				FORMAT(CASE WHEN T.[MARGIN ON SALES%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,2) END,'N2') MARGIN_CONTRIBUTION_ON_SALES
				from #RESULT R,#TOTAL T
			    
				SELECT '   TOTAL >> ' [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL
			end
				
		ELSE if @REPORTYTYPE=1		------GROUP WISE REPORT ------------------------------------------
	        begin                    
				IF (@SHOWITEMDETAIL  = 0 )	------------GROUPWISE SUMMARY REPORT-----------------------------
				BEGIN
        			INSERT INTO #RESULT (MGROUP,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
        	        select  *,CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [MARGIN ON COST%],CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%]
					from(
        			    SELECT B.MCODE,B.MENUCODE,B.DESCA ITEMNAME,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM    (COSTPRICE)COSTPRICE,SUM(NETSALESAMOUNT-COSTPRICE)PROFIT
					    FROM #PROFITABILITY A LEFT JOIN MENUITEM B WITH(NOLOCK) ON A.MGROUP = B.MCODE GROUP BY B.MENUCODE,B.DESCA,B.MCODE
						)A
				
                    INSERT into #TOTAL
	                select SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY, SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE,
	                SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%]  from #RESULT

					--RESULT

					select MENUCODE [ITEM CODE],ITEMNAME [ITEM NAME],R.SALESQTY,R.RETURNQTY,R.NETSALESQTY [SALES QTY],FORMAT(ROUND((R.NETSALESQTY/T.NETSALESQTY)*100,2),'N2') [SALES CONTRIBUTION],FORMAT(r.SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(R.SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(R.DISCOUNT,'N2')DISCOUNT,
					FORMAT(R.NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(ROUND((R.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,2),'N2') [SALES AMOUNT CONTRIBUTION],FORMAT(R.COSTPRICE,'N2') COST,FORMAT(R.PROFIT,'N2')PROFIT,FORMAT(R.[MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT(R.[MARGIN ON SALES%],'N2')[MARGIN ON SALES%],
					FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,2) END,'N2') MARGIN_CONTRIBUTION_ON_COST,
					FORMAT(CASE WHEN T.[MARGIN ON SALES%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,2) END,'N2') MARGIN_CONTRIBUTION_ON_SALES
					from #RESULT R,#TOTAL T ORDER BY ITEMNAME	

					SELECT '   TOTAL >> ' [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL

				END										
					IF (@SHOWITEMDETAIL  = 1)	------GROUPWISE ITEM DETAIL REPORT---------------------------------------
					BEGIN
					     insert INTO #RESULT (MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,MGROUP,MGROUP_NAME,[MARGIN ON COST%],[MARGIN ON SALES%])
					     select MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,MGROUP,MGROUP_NAME,
						 CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [MARGIN ON COST%],CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN  ON SALES%]
					     from (
        			         SELECT a.MENUCODE,a.ITEMNAME,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM(COSTPRICE)     COSTPRICE,SUM(NETSALESAMOUNT-COSTPRICE)PROFIT,B.MCODE MGROUP,B.DESCA  MGROUP_NAME
					         FROM #PROFITABILITY A LEFT JOIN MENUITEM B WITH(NOLOCK) ON A.MGROUP = B.MCODE GROUP BY a.MENUCODE,a.ITEMNAME,B.DESCA,B.MCODE
							  )A
				    
                         insert into #TOTAL
	                     select  SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY),SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE,SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
	                     from #RESULT
				    
					    SELECT MGROUP_NAME [ITEM CODE],ITEMNAME [ITEM NAME], SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],FORMAT([SALES CONTRIBUTION],'N2')[SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,
						FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT([SALES AMOUNT CONTRIBUTION],'N2')[SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,
						FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(MARGIN_CONTRIBUTION_ON_COST,'N2')MARGIN_CONTRIBUTION_ON_COST, 
						FORMAT(MARGIN_CONTRIBUTION_ON_SALES,'N2')MARGIN_CONTRIBUTION_ON_SALES,MCODE,MG_NAME,FLG,FFLG 
						FROM 
        			     (
        			     SELECT DISTINCT NULL MGROUP_NAME, MGROUP_NAME ITEMNAME, NULL SALESQTY,NULL RETURNQTY, NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,MGROUP MCODE, MGROUP_NAME MG_NAME,'A' FLG, 'B' FFLG FROM #RESULT
        			     UNION ALL
        			     SELECT A.MENUCODE,' ' +  A.ITEMNAME DESCA,A.SALESQTY,A.RETURNQTY,A.NETSALESQTY,ROUND((A.NETSALESQTY/T.NETSALESQTY)*100,3) [SALES CONTRIBUTION],A.SALESAMOUNT,A.SALESRETURNAMOUNT,A.DISCOUNT,A.NETSALESAMOUNT,
						 CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND ((A.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3) END [SALES AMOUNT CONTRIBUTION],A.COSTPRICE,A.PROFIT,A.[MARGIN ON COST%],A.[MARGIN ON SALES%],
						 CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((a.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END  MARGIN_CONTRIBUTION_ON_COST,
						 CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND  ((a.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END MARGIN_CONTRIBUTION_ON_SALES,
						 MGROUP MCODE,MGROUP_NAME MG_NAME,'B' FLG,'R' FFLG FROM #RESULT A,#TOTAL T
        			     UNION ALL
        			     SELECT NULL MENUCODE,'           GROUP TOTAL :' DESCA,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,NULL SALES_CONTRIBUTION,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT),SUM(A.DISCOUNT)DISCOUNT,
        			     SUM(NETSALESAMOUNT)NETSALESAMOUNT,NULL SALES__AMOUNT_CONTRIBUTION,SUM(COSTPRICE)COSTPRICE,SUM(PROFIT)PROFIT,case when SUM(COSTPRICE) = 0 then 0 else sum(profit) / SUM(COSTPRICE) * 100 end as MarginCost,
									    case when SUM(NETSALESAMOUNT) = 0 then 0 else sum(profit) / SUM(NETSALESAMOUNT) * 100 end as MarginSales,NULL MARGIN_CONTRI_COST,NULL MARGIN_CONTRI_SALES,MGROUP MCODE,MGROUP_NAME MG_NAME,'C' FLG, 'B' FFLG FROM #RESULT A GROUP BY MGROUP,MGROUP_NAME
						 UNION ALL
						 SELECT DISTINCT NULL MGROUP_NAME, NULL ITEMNAME,NULL,NULL, NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,MGROUP MCODE, MGROUP_NAME MG_NAME,'D' FLG, 'R' FFLG FROM #RESULT
        			    ) A ORDER BY MG_NAME,FLG,ITEMNAME
        		    
					   
					   SELECT '   TOTAL >> ' [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL


					END
					IF(@SHOWITEMDETAIL=2)	--ITEM WITH GROUPWISE HIERARCHY
					BEGIN
						--insert into  #RESULT(MGROUP,MCODE,MENUCODE,ITEMNAME,UNIT,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
						IF OBJECT_ID('TEMPDB..#DATA') IS NOT NULL DROP TABLE #DATA

						select MGCode ,MENUCODE,ITEMS [ITEM NAME],UNIT,B.ID,B.LEVELS,B.PARENT,B.TYPE,ISNULL(SALESQTY,0) SALESQTY,ISNULL(RETURNQTY,0) RETURNQTY,ISNULL(NETSALESQTY,0) NETSALESQTY,ISNULL(SALESAMOUNT,0) SALESAMOUNT,ISNULL(SALESRETURNAMOUNT,0) SALESRETURNAMOUNT,ISNULL(DISCOUNT,0) DISCOUNT,ISNULL(NETSALESAMOUNT,0) NETSALESAMOUNT,ISNULL(COSTPRICE,0) COSTPRICE,ISNULL(NETSALESAMOUNT-COSTPRICE,0) PROFIT,	CASE WHEN COSTPRICE = 0 THEN 0 ELSE ((NETSALESAMOUNT-COSTPRICE)/COSTPRICE)*100.00 END [MARGIN ON COST%],CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE ((NETSALESAMOUNT-COSTPRICE)/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%] INTO #DATA FROM FN_ITEMHIERARCHY(@MGROUP,0) B LEFT JOIN #PROFITABILITY A    ON B.MGCode=A.MCODE 

						--SELECT * FROM #DATA ORDER BY ID
				
				--SUMMING GROUP
				DECLARE @LVL INT
				SELECT @LVL= MAX(LEVELS) FROM #DATA

				WHILE @LVL>0
					BEGIN
						UPDATE A SET A.SALESQTY=B.SALESQTY,A.RETURNQTY=B.RETURNQTY,A.NETSALESQTY=B.NETSALESQTY,A.SALESAMOUNT=B.SALESAMOUNT,A.SALESRETURNAMOUNT=B.SALESRETURNAMOUNT,A.DISCOUNT=B.DISCOUNT,A.NETSALESAMOUNT=B.NETSALESAMOUNT,A.COSTPRICE=B.COSTPRICE,A.PROFIT=B.PROFIT
							FROM #DATA A INNER JOIN
						(SELECT PARENT,SUM(SALESQTY) SALESQTY,SUM(RETURNQTY) RETURNQTY,SUM(NETSALESQTY) NETSALESQTY,SUM(SALESAMOUNT) SALESAMOUNT, SUM(SALESRETURNAMOUNT) SALESRETURNAMOUNT, SUM(DISCOUNT) DISCOUNT, SUM(NETSALESAMOUNT) NETSALESAMOUNT, SUM(COSTPRICE) COSTPRICE, SUM(PROFIT) PROFIT FROM #DATA
						WHERE LEVELS=@LVL
						GROUP BY PARENT)B ON A.MGCode=B.PARENT
						SET @LVL=@LVL-1;
						END
						--SELECT * FROM #DATA ORDER BY ID
				SELECT MENUCODE ITEMCODE,[ITEM NAME],UNIT,FORMAT(SALESQTY,'N2') SALESQTY, FORMAT(RETURNQTY,'N2') RETURNQTY,FORMAT(NETSALESQTY,'N2') NETSALESQTY,FORMAT(SALESAMOUNT,'N2') SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2') SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2') DISCOUNT,FORMAT(NETSALESAMOUNT,'N2') NETSALESAMOUNT,FORMAT(COSTPRICE,'N2') COSTPRICE,FORMAT(PROFIT,'N2') PROFIT,FORMAT([MARGIN ON COST%],'N2') [MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2') [MARGIN ON SALES %],CASE WHEN TYPE='G' THEN 'B' ELSE 'R' END FFLG,'A' FLG FROM #DATA  WHERE (ISNULL(SALESQTY,0)<>0 OR ISNULL(RETURNQTY,0)<>0 )
				ORDER BY ID

				SELECT 'TOTAL >>' [ITEM NAME],NULL ,FORMAT(SUM(SALESQTY),'N2') SALESQTY,FORMAT(SUM(RETURNQTY),'N2') RETURNQTY,FORMAT(SUM(NETSALESQTY),'N2') NETSALESQTY,FORMAT(SUM(SALESAMOUNT),'N2') SALESAMOUNT,FORMAT(SUM(SALESRETURNAMOUNT),'N2') SALESRETURNAMOUNT,FORMAT(SUM(DISCOUNT),'N2') DISCOUNT,FORMAT(SUM(NETSALESAMOUNT),'N2') NETSALESAMOUNT,FORMAT(SUM(COSTPRICE),'N2') COSTPRICE,FORMAT(SUM(PROFIT),'N2') PROFIT,FORMAT(SUM(ISNULL([MARGIN ON COST%],0)),'N2') [MARGIN ON COST%],FORMAT(SUM(ISNULL([MARGIN ON SALES%],0)),'N2') [MARGIN ON SALES %],'B' FFLG FROM #DATA
					
					END
			END

            ELSE if @REPORTYTYPE=2	-------CATEGORYWISE REPORT--------------------------------------------
	        begin
			    IF (@SHOWITEMDETAIL  = 0 )	 --------CATEGORYWISE SUMMARY REPORT-------------------
					BEGIN
        			    INSERT INTO #RESULT (MCAT,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
        	            select  *,CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [MARGIN ON COST%],CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%]
					    from (
        			    SELECT A.MCAT,SUM(A.SALESQTY)SALESQTY,SUM(A.RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM(COSTPRICE)COSTPRICE,SUM    (NETSALESAMOUNT-COSTPRICE)PROFIT
					    FROM #PROFITABILITY A GROUP BY A.MCAT
                        )a

                        INSERT into #TOTAL
	                    select  SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY, SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE 
	                            ,SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
	                    from #RESULT

        			    SELECT NULL [ITEM CODE],R.MCAT [ITEM NAME], R.SALESQTY,R.RETURNQTY,R.NETSALESQTY  [SALES QTY],FORMAT(CASE WHEN T.NETSALESQTY = 0 THEN 0 ELSE ROUND((R.NETSALESQTY/T.NETSALESQTY)*100,3) END,'N2') [SALES CONTRIBUTION],
						FORMAT(R.SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(R.SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(R.DISCOUNT,'N2')DISCOUNT,FORMAT(R.NETSALESAMOUNT,'N2')NETSALESAMOUNT,
						FORMAT(CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND((R.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3) END,'N2') [SALES AMOUNT CONTRIBUTION],
						FORMAT(R.COSTPRICE,'N2') COST,FORMAT(R.PROFIT,'N2')PROFIT,FORMAT(R.[MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT(R.[MARGIN ON SALES%],'N2')[MARGIN ON SALES%],
						FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END,'N2') MARGIN_CONTRIBUTION_ON_COST,
						FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END,'N2') MARGIN_CONTRIBUTION_ON_SALES
					    FROM #RESULT R,#TOTAL T ORDER BY MCAT	

					   SELECT '   TOTAL >> ' [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL


					END
					-------CATEGORYWISE ITEM DETAILS  REPORT---------------------------------------------------------------------------------------------------
				IF (@SHOWITEMDETAIL  = 1) 
					begin
					     insert INTO #RESULT (MCAT,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
					     select MCAT,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,
						 CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [MARGIN ON COST%],
						 CASE WHEN NETSALESAMOUNT= 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%]
					     from(
        			     SELECT MCAT,a.MENUCODE,a.ITEMNAME,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM    (COSTPRICE) COSTPRICE,SUM(NETSALESAMOUNT-COSTPRICE)PROFIT
					     FROM #PROFITABILITY A GROUP BY MCAT,a.MENUCODE,a.ITEMNAME
                         )a
				    
                         insert into #TOTAL
	                     select SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE 
	                            ,SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
	                     from #RESULT

						SELECT MENUCODE [ITEM CODE],ITEMNAME [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],[SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,
						FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT([SALES AMOUNT CONTRIBUTION],'N2')[SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COSTPRICE,FORMAT(PROFIT,'N2')PROFIT,
						FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(MARGIN_CONTRIBUTION_ON_COST,'N2')MARGIN_CONTRIBUTION_ON_COST, 
						FORMAT(MARGIN_CONTRIBUTION_ON_SALES,'N2')MARGIN_CONTRIBUTION_ON_SALES,MCAT,FLG,FFLG FROM 
        			     (
        			      SELECT DISTINCT NULL MENUCODE, MCAT ITEMNAME,NULL SALESQTY,NULL RETURNQTY, NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,MCAT,'A' FLG, 'B' FFLG FROM #RESULT
        			      UNION ALL
        			      SELECT A.MENUCODE,' ' +  A.ITEMNAME DESCA,A.SALESQTY,A.RETURNQTY,A.NETSALESQTY, CASE WHEN T.NETSALESQTY = 0 THEN 0 ELSE  ROUND((A.NETSALESQTY/T.NETSALESQTY)*100,3) END [SALES CONTRIBUTION],
						  A.SALESAMOUNT,A.SALESRETURNAMOUNT,A.DISCOUNT,A.NETSALESAMOUNT,
						  CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND((A.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3)END [SALES AMOUNT CONTRIBUTION],A.COSTPRICE,A.PROFIT,A.[MARGIN ON COST%],A.[MARGIN ON SALES%],
						  CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((a.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END MARGIN_CONTRIBUTION_ON_COST,
						  CASE WHEN T.[MARGIN ON SALES%] = 0 THEN 0 ELSE ROUND((a.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END MARGIN_CONTRIBUTION_ON_SALES,MCAT,'B' FLG,'R' FFLG 
					      FROM #RESULT A,#TOTAL T
        			      UNION ALL
        			      SELECT NULL MENUCODE,'          GROUP TOTAL :' DESCA,SUM(SALESQTY),SUM(RETURNQTY),SUM(NETSALESQTY),NULL,SUM(SALESAMOUNT),SUM(SALESRETURNAMOUNT),SUM(A.DISCOUNT)DISCOUNT,
        			      SUM(NETSALESAMOUNT),NULL,SUM(COSTPRICE),SUM(PROFIT),case when SUM(COSTPRICE) = 0 then 0 else sum(profit) / SUM(COSTPRICE) * 100 end as MarginCost,
									    case when SUM(NETSALESAMOUNT) = 0 then 0 else sum(profit) / SUM(NETSALESAMOUNT) * 100 end as MarginSales,NULL,NULL,MCAT,'C' FLG, 'B' FFLG FROM #RESULT A GROUP BY MCAT
						  UNION ALL
						  SELECT DISTINCT NULL MENUCODE, NULL ITEMNAME,NULL,NULL, NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,MCAT,'D' FLG, 'R' FFLG FROM #RESULT
        			    ) A ORDER BY MCAT,FLG,ITEMNAME
        		    
						SELECT '   TOTAL >> ' [ITEM NAME] ,SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL

					 END
			END
			ELSE if @REPORTYTYPE=3		-------SUPPLIER  WISE REPORT-----------------------
				begin
					IF (@SHOWITEMDETAIL  = 0 )	--------SUPPLIERWISE SUMMARY-----------------------------
						BEGIN
        					 INSERT INTO #RESULT (PARAC,ACNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
        					 select A.PARAC,RA.ACNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,
							 CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [MARGIN ON COST%],
							 CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%]
							 from(
        					 SELECT a.parac,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM(COSTPRICE)COSTPRICE,SUM(NETSALESAMOUNT-COSTPRICE)PROFIT
							 FROM #PROFITABILITY A  where parac like 'PA%' GROUP BY a.parac
							 )a  join rmd_aclist ra WITH(NOLOCK) on a.parac=ra.acid 

							 INSERT into #TOTAL
							 select  SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY, SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE 
									 ,SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
							 from #RESULT

							SELECT parac [SUPPLIER CODE],ACNAME [SUPPLIER NAME], R.SALESQTY,R.RETURNQTY,R.NETSALESQTY  [SALES QTY],FORMAT(CASE WHEN T.NETSALESQTY = 0 THEN 0 ELSE ROUND((R.NETSALESQTY/T.NETSALESQTY)*100,3) END,'N2') [SALES CONTRIBUTION],
							FORMAT(R.SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(R.SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(R.DISCOUNT,'N2')DISCOUNT,FORMAT(R.NETSALESAMOUNT,'N2')NETSALESAMOUNT,
							FORMAT(CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND((R.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3) END,'N2') [SALES AMOUNT CONTRIBUTION],
							FORMAT(R.COSTPRICE,'N2') COST,FORMAT(R.PROFIT,'N2')PROFIT,FORMAT(R.[MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT(R.[MARGIN ON SALES%],'N2')[MARGIN ON SALES%],
							FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END,'N2') MARGIN_CONTRIBUTION_ON_COST,
							FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END,'N2') MARGIN_CONTRIBUTION_ON_SALES
							FROM #RESULT R,#TOTAL T ORDER BY ACNAME	

							SELECT '   TOTAL >> ' [SUPPLIER NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL

						END
			
					IF (@SHOWITEMDETAIL  = 1) ---------SUPPLIERWISE ITEM DETAILS REPORT-----------------
						begin
							 insert INTO #RESULT (parac,acname,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
							 select parac,ra.acname,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,
							 CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [ MARGIN ON COST%],
							 CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%]
							 from (
        						 SELECT a.parac,MENUCODE,ITEMNAME,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM(COSTPRICE)    COSTPRICE,SUM(NETSALESAMOUNT-COSTPRICE)PROFIT
								 FROM #PROFITABILITY A  where parac like 'PA%' GROUP BY a.parac,MENUCODE,ITEMNAME
							 )a join rmd_aclist ra WITH(NOLOCK) on a.parac=ra.acid
						
							 insert into #TOTAL
							 select  SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE 
									,SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
							 from #RESULT
				    

							SELECT MENUCODE [SUPPLIER CODE],ITEMNAME [SUPPLIER NAME], SALESQTY,RETURNQTY,NETSALESQTY  [SALES QTY],[SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,
							FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT([SALES AMOUNT CONTRIBUTION],'N2')[SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COSTPRICE,FORMAT(PROFIT,'N2')PROFIT,
							FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(MARGIN_CONTRIBUTION_ON_COST,'N2')MARGIN_CONTRIBUTION_ON_COST, 
							FORMAT(MARGIN_CONTRIBUTION_ON_SALES,'N2')MARGIN_CONTRIBUTION_ON_SALES,ACNAME,FLG,FFLG FROM
        					 (
        					   SELECT DISTINCT NULL MENUCODE, ACNAME ITEMNAME,NULL SALESQTY,NULL RETURNQTY,NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,ACNAME,'A' FLG, 'B' FFLG FROM #RESULT
        					   UNION ALL
        					   SELECT A.MENUCODE,' ' +  A.ITEMNAME DESCA,A.SALESQTY,A.RETURNQTY,A.NETSALESQTY,ROUND((A.NETSALESQTY/T.NETSALESQTY)*100,3) [SALES CONTRIBUTION],A.SALESAMOUNT,A.SALESRETURNAMOUNT,A.DISCOUNT,A.NETSALESAMOUNT,
							   CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND((A.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3) END [SALES AMOUNT CONTRIBUTION],A.COSTPRICE,A.PROFIT,A.[MARGIN ON COST%],A.[MARGIN ON SALES%],
							   CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((a.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END MARGIN_CONTRIBUTION_ON_COST,
							   CASE WHEN T.[MARGIN ON SALES%]=0 THEN 0 ELSE ROUND((a.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END MARGIN_CONTRIBUTION_ON_SALES,ACNAME,'B' FLG,'R' FFLG 
							   FROM #RESULT A,#TOTAL T
        					   UNION ALL
        					   SELECT NULL MENUCODE,'              GROUP TOTAL :' DESCA,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY),NULL,SUM(SALESAMOUNT),SUM(SALESRETURNAMOUNT),SUM(A.DISCOUNT)DISCOUNT,
        					   SUM(NETSALESAMOUNT),NULL,SUM(COSTPRICE),SUM(PROFIT),case when SUM(COSTPRICE) = 0 then 0 else sum(profit) / SUM(COSTPRICE) * 100 end as MarginCost,
									    case when SUM(NETSALESAMOUNT) = 0 then 0 else sum(profit) / SUM(NETSALESAMOUNT) * 100 end as MarginSales,NULL,NULL,ACNAME,'C' FLG, 'B' FFLG FROM #RESULT A GROUP BY ACNAME
							   UNION ALL
							   SELECT DISTINCT NULL MENUCODE, NULL ITEMNAME,NULL,NULL, NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,ACNAME,'D' FLG, 'R' FFLG FROM #RESULT
        					  ) A ORDER BY ACNAME,FLG,ITEMNAME
        		    
							 SELECT '   TOTAL >> '  [SUPPLIER NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL

						 END
				END
			ELSE if @REPORTYTYPE=4	-------DAYWISE REPORT--------------------------------
				begin
					IF (@SHOWITEMDETAIL  = 0 )	----DAYWISE SUMMARY REPORT------------
						BEGIN
        					 INSERT INTO #RESULT (TRNDATE,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
        					 select TRNDATE,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,
							 CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [MARGIN ON COST%],
							 CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES%]
							 from(
        					 SELECT a.TRNDATE,SUM(SALESQTY)SALESQTY, SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM(COSTPRICE)COSTPRICE,SUM     (NETSALESAMOUNT-COSTPRICE)PROFIT
							 FROM #PROFITABILITY A  GROUP BY a.TRNDATE
							 )a  

							 INSERT into #TOTAL
							 select  SUM(SALESQTY)SALESQTY, SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE 
									 ,SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
							 from #RESULT
					
        --					 SELECT CAST(TRNDATE AS DATE) [DATE],R.SALESQTY,R.RETURNQTY,R.NETSALESQTY [SALES QTY],ROUND((R.NETSALESQTY/T.NETSALESQTY)*100,3) [SALES CONTRIBUTION],r.SALESAMOUNT,R.SALESRETURNAMOUNT,R.DISCOUNT,R.NETSALESAMOUNT,
							 --CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND((R.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3) END [SALES AMOUNT CONTRIBUTION],R.COSTPRICE COST,R.PROFIT,R.[MARGIN ON COST%],R.[MARGIN ON SALES%],
							 --CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END MARGIN_CONTRIBUTION_ON_COST,
							 --CASE WHEN T.[MARGIN ON SALES%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END MARGIN_CONTRIBUTION_ON_SALES
							 --FROM #RESULT R,#TOTAL T ORDER BY TRNDATE	

							SELECT FORMAT(TRNDATE, 'MM-dd-yyyy') [DATE], R.SALESQTY,R.RETURNQTY,R.NETSALESQTY  [SALES QTY],FORMAT(CASE WHEN T.NETSALESQTY = 0 THEN 0 ELSE ROUND((R.NETSALESQTY/T.NETSALESQTY)*100,3) END,'N2') [SALES CONTRIBUTION],
							FORMAT(R.SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(R.SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(R.DISCOUNT,'N2')DISCOUNT,FORMAT(R.NETSALESAMOUNT,'N2')NETSALESAMOUNT,
							FORMAT(CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND((R.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3) END,'N2') [SALES AMOUNT CONTRIBUTION],
							FORMAT(R.COSTPRICE,'N2') COST,FORMAT(R.PROFIT,'N2')PROFIT,FORMAT(R.[MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT(R.[MARGIN ON SALES%],'N2')[MARGIN ON SALES%],
							FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END,'N2') MARGIN_CONTRIBUTION_ON_COST,
							FORMAT(CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((R.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END,'N2') MARGIN_CONTRIBUTION_ON_SALES
							FROM #RESULT R,#TOTAL T ORDER BY ACNAME	

        			     
							SELECT '   TOTAL >> ' [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL

						END
					
					IF (@SHOWITEMDETAIL  = 1)	------DAYWISE ITEM DETAIL REPORT------------------
						begin
							 insert INTO #RESULT (trndate,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%])
							 select TRNDATE,MENUCODE,ITEMNAME,SALESQTY,RETURNQTY,NETSALESQTY,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,COSTPRICE,PROFIT,
							 CASE WHEN COSTPRICE = 0 THEN 0 ELSE (PROFIT/COSTPRICE)*100.00 END [MARGIN ON COST%],
							 CASE WHEN NETSALESAMOUNT = 0 THEN 0 ELSE (PROFIT/NETSALESAMOUNT)*100.00 END [MARGIN ON SALES %]
							 from(
        						  SELECT TRNDATE,MENUCODE,ITEMNAME,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(A.DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,SUM (COSTPRICE)        COSTPRICE,SUM(NETSALESAMOUNT-COSTPRICE)PROFIT
								  FROM #PROFITABILITY A   GROUP BY a.TRNDATE,MENUCODE,ITEMNAME
								  )a  

							  insert into #TOTAL
							  select  SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY, SUM(NETSALESQTY)NETSALESQTY,SUM(SALESAMOUNT)SALESAMOUNT,SUM(SALESRETURNAMOUNT)SALESRETURNAMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(NETSALESAMOUNT)NETSALESAMOUNT,sum(COSTPRICE)COSTPRICE 
									 ,SUM(PROFIT)PROFIT,((SUM(PROFIT)/sum(COSTPRICE)) * 100)[MARGIN ON COST%] ,((SUM(PROFIT)/sum(NETSALESAMOUNT)) * 100)[MARGIN ON SALES%] 
							  from #RESULT
				    
							  --SELECT MENUCODE,ITEMNAME, SALESQTY,RETURNQTY, NETSALESQTY,[SALES CONTRIBUTION],SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,[SALES AMOUNT CONTRIBUTION],COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%], MARGIN_CONTRIBUTION_ON_COST, MARGIN_CONTRIBUTION_ON_SALES,TRNDATE,FLG,FFLG 
							  --FROM 
							
							SELECT MENUCODE [ITEM CODE],ITEMNAME [ITEM NAME], SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],[SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,
							FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT([SALES AMOUNT CONTRIBUTION],'N2')[SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,
							FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(MARGIN_CONTRIBUTION_ON_COST,'N2')MARGIN_CONTRIBUTION_ON_COST, 
							FORMAT(MARGIN_CONTRIBUTION_ON_SALES,'N2')MARGIN_CONTRIBUTION_ON_SALES,TRNDATE,FLG,FFLG FROM

        						 (
        						 SELECT DISTINCT NULL MENUCODE, FORMAT(TRNDATE, 'MM-dd-yyyy') ITEMNAME,NULL SALESQTY,NULL RETURNQTY, NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,TRNDATE,'A' FLG, 'B' FFLG FROM #RESULT
        						 UNION ALL
        						 SELECT A.MENUCODE,' ' +  A.ITEMNAME DESCA,A.SALESQTY,A.RETURNQTY,A.NETSALESQTY,ROUND((A.NETSALESQTY/T.NETSALESQTY)*100,3) [SALES CONTRIBUTION],A.SALESAMOUNT,A.SALESRETURNAMOUNT,A.DISCOUNT,A.NETSALESAMOUNT,
								 CASE WHEN T.NETSALESAMOUNT = 0 THEN 0 ELSE ROUND((A.NETSALESAMOUNT/T.NETSALESAMOUNT)*100,3) END [SALES AMOUNT CONTRIBUTION],A.COSTPRICE,A.PROFIT,A.[MARGIN ON COST%],A.[MARGIN ON SALES%],
								 CASE WHEN T.[MARGIN ON COST%] = 0 THEN 0 ELSE ROUND((a.[MARGIN ON COST%]/T.[MARGIN ON COST%])*100,3) END MARGIN_CONTRIBUTION_ON_COST,
								 CASE WHEN T.[MARGIN ON SALES%] = 0 THEN 0 ELSE ROUND((a.[MARGIN ON SALES%]/T.[MARGIN ON SALES%])*100,3) END MARGIN_CONTRIBUTION_ON_SALES,TRNDATE,'B' FLG,'R' FFLG 
								 FROM #RESULT A,#TOTAL T
        						 UNION ALL
        						 SELECT NULL MENUCODE,'            GROUP TOTAL :' DESCA,SUM(SALESQTY)SALESQTY,SUM(RETURNQTY)RETURNQTY,SUM(NETSALESQTY),NULL,SUM(SALESAMOUNT),SUM(SALESRETURNAMOUNT),SUM(A.DISCOUNT)DISCOUNT,
        							  SUM(NETSALESAMOUNT),NULL,SUM(COSTPRICE),SUM(PROFIT),
									  case when SUM(COSTPRICE) = 0 then 0 else sum(profit) / SUM(COSTPRICE) * 100 end as MarginCost,
									    case when SUM(NETSALESAMOUNT) = 0 then 0 else sum(profit) / SUM(NETSALESAMOUNT) * 100 end as MarginSales,
									  NULL,NULL,TRNDATE,'C' FLG, 'B' FFLG FROM #RESULT A GROUP BY TRNDATE
								UNION ALL
								SELECT DISTINCT NULL MENUCODE, NULL ITEMNAME,NULL,NULL,NULL NETSALESQTY,NULL [SALES CONTRIBUTION],NULL SALESAMOUNT,NULL SALESRETURNAMOUNT,NULL DISCOUNT,NULL NETSALESAMOUNT,NULL [SALES AMOUNT CONTRIBUTION],NULL COSTPRICE,NULL PROFIT,NULL [MARGIN ON COST%],  NULL [MARGIN ON SALES%],NULL MARGIN_CONTRIBUTION_ON_COST,NULL MARGIN_CONTRIBUTION_ON_SALES,TRNDATE,'D' FLG, 'B' FFLG FROM #RESULT

        						) A ORDER BY TRNDATE,FLG,ITEMNAME
        		    
							   --SELECT '','   TOTAL >> ' [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY,100,SALESAMOUNT,SALESRETURNAMOUNT,DISCOUNT,NETSALESAMOUNT,100,COSTPRICE,PROFIT,[MARGIN ON COST%],[MARGIN ON SALES%],100,100,'B' FLG, 'G' FFLG FROM #TOTAL
							  SELECT '   TOTAL >> ' [ITEM NAME],SALESQTY,RETURNQTY,NETSALESQTY [SALES QTY],100.00 [SALES CONTRIBUTION],FORMAT(SALESAMOUNT,'N2')SALESAMOUNT,FORMAT(SALESRETURNAMOUNT,'N2')SALESRETURNAMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,FORMAT(NETSALESAMOUNT,'N2')NETSALESAMOUNT,FORMAT(100,'N2')  [SALES AMOUNT CONTRIBUTION],FORMAT(COSTPRICE,'N2')COST,FORMAT(PROFIT,'N2')PROFIT,FORMAT([MARGIN ON COST%],'N2')[MARGIN ON COST%],FORMAT([MARGIN ON SALES%],'N2')[MARGIN ON SALES%],FORMAT(100,'N2') MARGIN_CONTRIBUTION_ON_COST,FORMAT(100,'N2')  MARGIN_CONTRIBUTION_ON_SALES FROM #TOTAL

						 END
				END

	IF OBJECT_ID('TEMPDB..#RESULT') IS NOT NULL DROP TABLE #RESULT
	IF OBJECT_ID('TEMPDB..#TOTAL') IS NOT NULL DROP TABLE #TOTAL	
	IF OBJECT_ID('TEMPDB..#PROFITABILITY') IS NOT NULL DROP TABLE #PROFITABILITY

set nocount OFF










