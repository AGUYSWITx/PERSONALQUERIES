 
 
 ALTER   PROCEDURE [dbo].[WSP_CUSTOMER_AC_ANALYSIS_SBL]
	--Declare 
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@FYID varchar(100)='79/80',
	@ISSUPPLIER TINYINT =0,
	@AREA_ID VARCHAR(MAX)='%',
	@ACID VARCHAR(MAX)='%'

	AS
		--SELECT @DATE1='2023-05-21',@DATE2='2023-05-29',@ISSUPPLIER   =1
	
	IF OBJECT_ID('tempdb..#DATA') is not null drop table #DATA

	select area_id,a_acid,
		sum(IIF(TRNDATE<@DATE1 ,DRAMNT-cramnt,0)) OPENING,
		SUM(CASE WHEN (  @ISSUPPLIER=0 AND TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='TI')THEN DRAMNT-CRAMNT WHEN (TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='RE')
		THEN -1*(DRAMNT-CRAMNT) ELSE 0 END)SALES,
		SUM(CASE WHEN (   @ISSUPPLIER=1 AND TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='PI')THEN DRAMNT-CRAMNT WHEN (TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='PX')
		THEN -1*(DRAMNT-CRAMNT) ELSE 0 END)PURCHASE,
			SUM(CASE WHEN (  @ISSUPPLIER=0 AND TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='CN')THEN DRAMNT-CRAMNT WHEN (TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='RR')
		THEN -1*(DRAMNT-CRAMNT) ELSE 0 END)SALESRETURN,
		SUM(CASE WHEN (   @ISSUPPLIER=1 AND TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='DN')THEN DRAMNT-CRAMNT WHEN (TRNDATE BETWEEN  @DATE1 and @DATE2 AND VOUCHERTYPE='DX')
		THEN -1*(DRAMNT-CRAMNT) ELSE 0 END)PURCHASERETURN, 
		SUM(IIF(VOUCHERTYPE NOT IN ('TI','SI','CN','RE','PI','DN','PX','DX','RR') AND TRNDATE BETWEEN  @DATE1 and @DATE2,DRAMNT-CRAMNT,0)) CASHBANK
		INTO #DATA
	from RMD_ACLIST a join RMD_TRNTRAN b on a.ACID=b.A_ACID and a.actype='pa'
	JOIN (SELECT VCHRNO ,TRNDATE,TRNMODE FROM RMD_TRNMAIN) M ON M.VCHRNO=B.VCHRNO
	where PhiscalID like @fyid AND
		(@AREA_ID = '%' OR ( @AREA_ID <> '%' AND area_id IN (SELECT * FROM DBO.SPLIT(@AREA_ID,',')))) 
	AND (@ACID = '%' OR ( @ACID <> '%' AND a_acid IN (SELECT * FROM DBO.SPLIT(@ACID,',')))) 
	AND((@ISSUPPLIER=1 AND PTYPE<>'C') OR (@ISSUPPLIER=0 AND PTYPE<>'V'))
	group by area_id, a_acid


 
	SELECT AREA_NAME	,ACNAME, IIF(@ISSUPPLIER =0 ,[OPENING],-1*[OPENING]) [OPENING],
	IIF(@ISSUPPLIER =0 ,[SALES],-1*[SALES]) [SALES],
	IIF(@ISSUPPLIER =0 ,-1*SALESRETURN,SALESRETURN) SALESRETURN,	
	IIF(@ISSUPPLIER =0 ,-1*[CASHBANK],[CASHBANK]) [CASHBANK] ,
	IIF(@ISSUPPLIER =0 ,[PURCHASE],-1*[PURCHASE]) [PURCHASE],
	IIF(@ISSUPPLIER =0 ,-1*[PURCHASERETURN],[PURCHASERETURN]) [PURCHASERETURN] 	 ,
	IIF(@ISSUPPLIER =0 ,[OPENING],-1*[OPENING])   +IIF(@ISSUPPLIER =0 ,[SALES],-1*[SALES]) -IIF(@ISSUPPLIER =0 ,-1*SALESRETURN,SALESRETURN)   +	IIF(@ISSUPPLIER =0 ,[PURCHASE],-1*[PURCHASE]) -	IIF(@ISSUPPLIER =0 ,-1*[PURCHASERETURN],[PURCHASERETURN] ) 	 -		IIF(@ISSUPPLIER =0 ,-1*[CASHBANK],[CASHBANK]) GRANDTOTAL,
	COUNT(*) OVER () ALLCOUNT
	FROM #DATA  DT LEFT JOIN RMD_ACLIST RA ON RA.ACID =DT.A_ACID
	LEFT JOIN TBLAREA TA ON TA.AREA_ID =DT.AREA_ID
 
   