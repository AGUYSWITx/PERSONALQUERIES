CREATE OR ALTER     PROCEDURE [dbo].[WSP_SALESREPORT_ITEMWISE_DETAIL]
--DECLARE 
	@DATE1 DATETIME,
	@DATE2 DATETIME,
	@DIV VARCHAR(3) = '%',
	@COMID VARCHAR(25) = '%',
	@PHISCALID VARCHAR(25) = '%',
	@CCENTER VARCHAR(50) = '%',
	@MCODE VARCHAR(25) = '%',
	@ITEMGROUP VARCHAR(25) = '%',
	@REPORT_TYPE TINYINT =0,		--0 BILL WISE REPORT, 1 DAY WISE REPORT
	@SHOWDETAIL TINYINT = 0,
	@SEGREGATEBYITEM TINYINT = 0,
	@params VARCHAR(MAX) = '',
	@VCHR1 VARCHAR(25)=0,
	@VCHR2 VARCHAR(25)=0,
	@SALESTYPE TINYINT=0, 	-- 0 ALL | 1 RETAIL ONLY | 2 WHOLESALES ONLY 
	@TRNUSER VARCHAR(100)='%',
	@SHOWUSERWISE INT=0,
	@SHOWGROUPING TINYINT = 0 
AS

--select @DATE1='2023-07-17',@DATE2='2023-08-11',@PHISCALID='80/81',@SHOWGROUPING=1,@SHOWDETAIL=1,@SEGREGATEBYITEM=1

--SET @DATE1=N'2023-03-23' ; SET @DATE2=N'2023-03-23' ; SET @PHISCALID=N'79/80' ; SET @COMID=N'PLATINUM' ; SET @DIV=N'%' ; SET @CCENTER=N'%' ; SET @REPORT_TYPE=N'0' ; SET @SHOWDETAIL=0 ; SET @MCODE=N'%' ; SET @ITEMGROUP=N'%' ; SET @params=N'' ; SET @SEGREGATEBYITEM=0 ; SET @SALESTYPE=N'0' ; SET @TRNUSER=N'%' ; SET @SHOWUSERWISE=1

DECLARE @VCHRMODE INT=0
IF @VCHR1=0 AND @VCHR2=0
	SET @VCHRMODE=0
ELSE
	SET @VCHRMODE=1

set nocount on

DECLARE @V2 VARCHAR(2), @V1 VARCHAR(2), @V3 VARCHAR(2),@V4 VARCHAR(2),@V5 VARCHAR(2),@ACID VARCHAR(25)
SET @V2 = 'CN'; SET @V1 = 'TI'; SET @V3 = 'SI'; SET @V4 = 'RE';SET @V5 = 'RR'; SET @ACID = '%'

IF OBJECT_ID('TEMPDB..#TRNPROD') is not null drop table #TRNPROD
IF OBJECT_ID('TEMPDB..#TRNPROD_1') is not null drop table #TRNPROD_1

IF OBJECT_ID('TEMPDB..#SGROUP') is not null drop table #SGROUP
	SELECT MCODE MC,MGCODE,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C],MCATEGORY CATEGORY INTO #SGROUP FROM vwItemHeirarchy WHERE MCODE LIKE CASE WHEN @SHOWGROUPING = 1 THEN '%' ELSE '~~' END	
	 
if @REPORT_TYPE =1
	set @SHOWDETAIL = 0

IF @SHOWDETAIL = 0
	SELECT C.MENUCODE, CASE WHEN C.ISUNKNOWN=1 THEN A.ITEMDESC
	ELSE C.DESCA
	END DESCA,ISNULL(SG.[MAIN GROUP],'')[MAIN GROUP],ISNULL(SG.[SUB GROUP_A],'')[SUB GROUP_A],ISNULL( SG.[SUB GROUP_B],'')[SUB GROUP_B],ISNULL(SG.[SUB GROUP_C],'')[SUB GROUP_C],ISNULL(SG.CATEGORY,'')CATEGORY	
	,C.BASEUNIT,C.In_Rate_A MRP,
	SUM(A.REALQTY) SALESQTY,  SUM(A.REALQTY_IN) RETURNQTY,SUM(REALQTY) - SUM(REALQTY_IN) NETQTY,A.REALRATE AS RATE, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.AMOUNT *-1 ELSE  A.AMOUNT END) AS AMOUNT, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4)THEN A.DISCOUNT *-1 ELSE  A.DISCOUNT END) AS DISCOUNT, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.ECSAMOUNT *-1 ELSE  A.ECSAMOUNT END) AS ECSAMOUNT, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.SERVICETAX *-1 ELSE  A.SERVICETAX END) AS SERVICETAX, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.NONTAXABLE *-1 ELSE  A.NONTAXABLE END) AS NONTAXABLE,
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.TAXABLE *-1 ELSE  A.TAXABLE END) AS TAXABLE,
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.VAT *-1 ELSE  A.VAT END) AS VAT,
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN (A.TAXABLE+A.NONTAXABLE+A.VAT) *-1 ELSE  (A.TAXABLE+A.NONTAXABLE+A.VAT) END) AS NETAMNT,
	B.VCHRNO VNO,A.DIVISION,B.TRNDATE TDATE,B.BSDATE,B.REFBILL,B.VNUM,A.SNO,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.ACNAME ELSE ISNULL(X.CUSTNAME,ISNULL(Y.ACNAME,B.BILLTO)) END CUSTOMERNAME,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.VATNO ELSE ISNULL(X.PANNO,ISNULL(Y.VATNO,B.BILLTOTEL)) END VATNO,
	A.MCODE,C.MGROUP,B.STAMP,ISNULL(Z.costcentername, 'NA') AS CostCenter,ISNULL(B.REMARKS,'')REMARKS,ISNULL(M.ACNAME,'')SUPPLIER,IIF(@SHOWUSERWISE=1,B.TRNUSER,'') TRNUSER INTO #TRNPROD
	FROM RMD_TRNPROD A WITH(NOLOCK)  INNER JOIN RMD_TRNMAIN B WITH(NOLOCK)  ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PHISCALID = B.PHISCALID --AND A.COMPANYID = B.COMPANYID 
	INNER JOIN MENUITEM C  WITH(NOLOCK) ON A.MCODE = C.MCODE LEFT JOIN CUSTOMERPROFILE X  WITH(NOLOCK) ON ISNULL(B.RECEIVEBY,'') = X.CUSTID LEFT JOIN RMD_ACLIST Y  WITH(NOLOCK) ON ISNULL(B.PARAC,'') = Y.ACID
	LEFT JOIN COSTCENTER Z WITH(NOLOCK)  ON ISNULL(B.COSTCENTER,'') = CAST(Z.CCID AS VARCHAR(25))
	LEFT JOIN RMD_ACLIST M WITH(NOLOCK)  ON ISNULL(C.SUPCODE,'') = M.ACID
	LEFT JOIN vwTrnMain_AdditionalInfo E WITH(NOLOCK) ON B.VCHRNO=E.VCHRNO
	LEFT JOIN #SGROUP SG ON SG.MC=C.MCODE
	WHERE A.VOUCHERTYPE IN (@V1,@V2,@V3,@V4,@V5) AND A.DIVISION LIKE @DIV AND A.PhiscalID = @PHISCALID 
	AND ((@VCHRMODE =0 AND 1=1) OR  ((@VCHRMODE<> 0 AND CAST((LEFT(RIGHT(B.VCHRNO,(LEN(B.VCHRNO)-2)),(LEN(RIGHT(B.VCHRNO,(LEN(B.VCHRNO)-2)))-10))) AS INT) BETWEEN @VCHR1 AND @VCHR2)))
	AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) AND ISNULL(B.COSTCENTER,'') LIKE @CCENTER
	AND ISNULL(B.RECEIVEBY,'') LIKE @ACID AND A.MCODE LIKE @MCODE AND C.MGROUP LIKE @ITEMGROUP
	AND ( @SALESTYPE=0   OR (@SALESTYPE=1 AND ISNULL(E.IsWholeSale,0)<>1) OR (@SALESTYPE=2 AND ISNULL(E.IsWholeSale,0)=1))
	AND ISNULL(B.TRNUSER,'') LIKE @TRNUSER
	GROUP BY C.MENUCODE, C.DESCA,C.BASEUNIT,C.In_Rate_A,A.REALRATE,B.VCHRNO,A.DIVISION,B.TRNDATE,B.BSDATE,B.REFBILL,B.VNUM,A.SNO,C.ISUNKNOWN,A.ITEMDESC,ISNULL(SG.[MAIN GROUP],''),ISNULL(SG.[SUB GROUP_A],''),ISNULL( SG.[SUB GROUP_B],''),ISNULL(SG.[SUB GROUP_C],''),ISNULL(SG.CATEGORY	,'')	,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.ACNAME ELSE ISNULL(X.CUSTNAME,ISNULL(Y.ACNAME,B.BILLTO)) END,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.VATNO ELSE ISNULL(X.PANNO,ISNULL(Y.VATNO,B.BILLTOTEL)) END,
	A.MCODE,C.MGROUP,B.STAMP,ISNULL(Z.costcentername, 'NA'),ISNULL(B.REMARKS,''),ISNULL(M.ACNAME,''),IIF(@SHOWUSERWISE=1,B.TRNUSER,'')
ELSE
	select C.MENUCODE, CASE WHEN C.ISUNKNOWN=1 THEN A.ITEMDESC
	ELSE C.DESCA
	END DESCA,ISNULL(SG.[MAIN GROUP],'')[MAIN GROUP],ISNULL(SG.[SUB GROUP_A],'')[SUB GROUP_A],ISNULL( SG.[SUB GROUP_B],'')[SUB GROUP_B],ISNULL(SG.[SUB GROUP_C],'')[SUB GROUP_C],ISNULL(SG.CATEGORY	,'')CATEGORY,	C.BASEUNIT,C.In_Rate_A MRP,
	SUM(A.REALQTY) SALESQTY,  SUM(A.REALQTY_IN) RETURNQTY,SUM(REALQTY) - SUM(REALQTY_IN) NETQTY,A.REALRATE AS RATE, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.AMOUNT *-1 ELSE  A.AMOUNT END) AS AMOUNT, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4)THEN A.DISCOUNT *-1 ELSE  A.DISCOUNT END) AS DISCOUNT, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.ECSAMOUNT *-1 ELSE  A.ECSAMOUNT END) AS ECSAMOUNT, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.SERVICETAX *-1 ELSE  A.SERVICETAX END) AS SERVICETAX, 
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.NONTAXABLE *-1 ELSE  A.NONTAXABLE END) AS NONTAXABLE,
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.TAXABLE *-1 ELSE  A.TAXABLE END) AS TAXABLE,
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN A.VAT *-1 ELSE  A.VAT END) AS VAT,
	SUM(CASE WHEN B.VOUCHERTYPE IN (@V2,@V4) THEN (A.TAXABLE+A.NONTAXABLE+A.VAT) *-1 ELSE  (A.TAXABLE+A.NONTAXABLE+A.VAT) END) AS NETAMNT,
	B.VCHRNO VNO,A.DIVISION,B.TRNDATE TDATE,B.BSDATE,B.REFBILL,B.VNUM,A.SNO,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.ACNAME ELSE ISNULL(X.CUSTNAME,ISNULL(Y.ACNAME,B.BILLTO)) END CUSTOMERNAME,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.VATNO ELSE ISNULL(X.PANNO,ISNULL(Y.VATNO,B.BILLTOTEL)) END VATNO,
	ISNULL(A.BC,'')BC, A.MCODE,C.MGROUP,B.STAMP,ISNULL(Z.costcentername, 'NA') AS CostCenter,ISNULL(B.REMARKS,'')REMARKS,ISNULL(M.ACNAME,'')SUPPLIER,IIF(@SHOWUSERWISE=1,B.TRNUSER,'') TRNUSER  INTO #TRNPROD_1
	FROM RMD_TRNPROD A WITH(NOLOCK)  INNER JOIN RMD_TRNMAIN B WITH(NOLOCK)  ON A.VCHRNO = B.VCHRNO AND A.DIVISION = B.DIVISION AND A.PHISCALID = B.PHISCALID AND A.COMPANYID = B.COMPANYID 
	INNER JOIN MENUITEM C WITH(NOLOCK)  ON A.MCODE = C.MCODE LEFT JOIN CUSTOMERPROFILE X  WITH(NOLOCK) ON ISNULL(B.RECEIVEBY,'') = X.CUSTID LEFT JOIN RMD_ACLIST Y  WITH(NOLOCK) ON ISNULL(B.PARAC,'') = Y.ACID
	LEFT JOIN COSTCENTER Z  WITH(NOLOCK) ON ISNULL(B.COSTCENTER,'') = CAST(Z.CCID AS VARCHAR(25))
	LEFT JOIN RMD_ACLIST M WITH(NOLOCK)  ON ISNULL(C.SUPCODE,'') = M.ACID
	LEFT JOIN vwTrnMain_AdditionalInfo E WITH(NOLOCK) ON B.VCHRNO=E.VCHRNO
	LEFT JOIN #SGROUP SG ON SG.MC=C.MCODE
	WHERE A.VOUCHERTYPE IN (@V1,@V2,@V3,@V4,@V5) AND A.DIVISION LIKE @DIV AND A.PhiscalID = @PHISCALID 
	AND ((@VCHRMODE =0 AND 1=1) OR  ((@VCHRMODE<> 0 AND CAST((LEFT(RIGHT(B.VCHRNO,(LEN(B.VCHRNO)-2)),(LEN(RIGHT(B.VCHRNO,(LEN(B.VCHRNO)-2)))-10))) AS INT) BETWEEN @VCHR1 AND @VCHR2)))
	AND (TRNDATE >=@DATE1 AND TRNDATE <= @DATE2) AND ISNULL(B.COSTCENTER,'') LIKE @CCENTER 
	AND ISNULL(B.RECEIVEBY,'') LIKE @ACID AND A.MCODE LIKE @MCODE AND C.MGROUP LIKE @ITEMGROUP
	AND ( @SALESTYPE=0   OR (@SALESTYPE=1 AND ISNULL(E.IsWholeSale,0)<>1) OR (@SALESTYPE=2 AND ISNULL(E.IsWholeSale,0)=1))
	AND ISNULL(B.TRNUSER,'') LIKE @TRNUSER
	GROUP BY C.MENUCODE, C.DESCA,	C.BASEUNIT,C.In_Rate_A,A.REALRATE,B.VCHRNO,A.DIVISION,B.TRNDATE,B.BSDATE,B.REFBILL,B.VNUM,A.SNO,C.ISUNKNOWN,A.ITEMDESC,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.ACNAME ELSE ISNULL(X.CUSTNAME,ISNULL(Y.ACNAME,B.BILLTO)) END,
	CASE WHEN B.TRNMODE = 'CREDIT' THEN Y.VATNO ELSE ISNULL(X.PANNO,ISNULL(Y.VATNO,B.BILLTOTEL)) END,
	A.MCODE,C.MGROUP,BC,B.STAMP,ISNULL(Z.costcentername, 'NA'),ISNULL(B.REMARKS,''), B.TRNMODE,ISNULL(M.ACNAME,''),IIF(@SHOWUSERWISE=1,B.TRNUSER,''),ISNULL(SG.[MAIN GROUP],''),ISNULL(SG.[SUB GROUP_A],''),ISNULL( SG.[SUB GROUP_B],''),ISNULL(SG.[SUB GROUP_C],''),ISNULL(SG.CATEGORY	,'')
	 
	 
IF @REPORT_TYPE = 0  -- ITEM WISE
BEGIN
	IF @SHOWDETAIL = 0
		BEGIN
		IF @SEGREGATEBYITEM = 0
			SELECT FORMAT(TDATE, 'MM-dd-yyyy') [DATE],BSDATE [MITI], VNO [BILL NO],REFBILL [REF NO],CUSTOMERNAME,VATNO,BASEUNIT [UNIT],QTY,FORMAT(RATE,'N2')RATE,FORMAT(AMOUNT,'N2') [AMOUNT],FORMAT(DISCOUNT,'N2')DISCOUNT,
			FORMAT(ECSAMOUNT,'N2') [ECS AMOUNT], FORMAT(SERVICETAX,'N2') [SERVICE CHARGE],FORMAT(NONTAXABLE+TAXABLE,'N2') NETSALES,FORMAT(NONTAXABLE,'N2') [NON TAXABLE],FORMAT(TAXABLE,'N2')TAXABLE,FORMAT(VAT,'N2') [VAT AMOUNT],
			FORMAT(NETAMNT,'N2') [NET AMOUNT],DIVNAME,DIVID,A.MCODE,A.FFLG,COSTCENTER,A.REMARKS,A.SUPPLIER,TRNUSER,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C]
			FROM 
			(
				SELECT DISTINCT NULL TDATE, DESCA + ' (' + MENUCODE + ')' BSDATE,  NULL VNO,NULL REFBILL,NULL CUSTOMERNAME,NULL VATNO,NULL BASEUNIT,NULL QTY, NULL RATE, NULL AMOUNT,NULL DISCOUNT,NULL ECSAMOUNT,NULL SERVICETAX,NULL NONTAXABLE, NULL TAXABLE, NULL VAT, NULL NETAMNT, NULL DIVNAME,NULL DIVID,MCODE,'A' FLG,'B' FFLG, NULL STAMP,DESCA INAME,NULL COSTCENTER,NULL REMARKS,NULL SUPPLIER,NULL TRNUSER,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C] FROM #TRNPROD
				UNION ALL
				SELECT A.TDATE,A.BSDATE,A.VNO,A.REFBILL,A.CUSTOMERNAME,A.VATNO,BASEUNIT,NETQTY QTY,RATE,AMOUNT,DISCOUNT,ECSAMOUNT,SERVICETAX,NONTAXABLE,TAXABLE,VAT,NETAMNT,B.NAME DIVNAME,A.DIVISION DIVID,A.MCODE,'B' FLG, 'R' FFLG,A.STAMP,A.DESCA INAME,A.COSTCENTER,ISNULL(A.REMARKS,'')REMARKS,A.SUPPLIER ,A.TRNUSER,null [MAIN GROUP],null [SUB GROUP_A],null [SUB GROUP_B],null [SUB GROUP_C]
				FROM #TRNPROD A INNER JOIN DIVISION B ON A.DIVISION = B.INITIAL
				UNION ALL
				SELECT NULL TDATE,NULL BSDATE,NULL VNO,NULL REFBILL,'                                                ITEM TOTAL :' SUPPLIERNAME,NULL,NULL BASEUNIT,SUM(NETQTY) QTY,NULL RATE,SUM(AMOUNT)AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(ECSAMOUNT)ECSAMOUNT,SUM(SERVICETAX)SERVICETAX,SUM(NONTAXABLE)NONTAXABLE,SUM(TAXABLE)TAXABLE,
				SUM(VAT)VAT,SUM(NETAMNT)NETAMNT,NULL DIVNAME,NULL DIVID,A.MCODE,'C' FLG, 'B' FFLG,NULL STAMP,A.DESCA INAME,NULL COSTCENTER,NULL REMARKS,NULL SUPPLIER,NULL TRNUSER ,null [MAIN GROUP],null [SUB GROUP_A],null [SUB GROUP_B],null [SUB GROUP_C] FROM #TRNPROD A GROUP BY MCODE,DESCA ,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C]
			) A ORDER BY INAME,FLG,TDATE, LEFT(VNO,2),A.STAMP,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C]
		ELSE
			SELECT A.MENUCODE,A.DESCA ITEMNAME, [MAIN GROUP], [SUB GROUP_A], [SUB GROUP_B], [SUB GROUP_C] ,FORMAT(A.TDATE, 'MM-dd-yyyy')TDATE,A.BSDATE,A.VNO,A.REFBILL,A.CUSTOMERNAME,A.VATNO,BASEUNIT,NETQTY QTY,FORMAT(RATE,'N2')RATE ,FORMAT(AMOUNT,'N2')AMOUNT,FORMAT(DISCOUNT,'N2')DISCOUNT,ECSAMOUNT,SERVICETAX,FORMAT(NONTAXABLE+TAXABLE,'N2')NETSALES,FORMAT(NONTAXABLE,'N2')NONTAXABLE,FORMAT(TAXABLE,'N2')TAXABLE,FORMAT(VAT,'N2')VAT,FORMAT(NETAMNT,'N2')NETAMNT,B.NAME DIVNAME,A.DIVISION DIVID,A.MCODE,'B' FLG, 'R' FFLG,A.STAMP,A.DESCA INAME,A.COSTCENTER,ISNULL(A.REMARKS,'')REMARKS,A.SUPPLIER,A.TRNUSER
			FROM #TRNPROD A INNER JOIN DIVISION B ON A.DIVISION = B.INITIAL ORDER BY A.DESCA,A.TDATE,A.STAMP

			SELECT NULL TDATE,NULL BSDATE,'   GRAND TOTAL   >>' ITEMNAME,NULL REFBILL,NULL MENUCODE,NULL DESCA,NULL BASEUNIT,SUM(NETQTY)QTY,NULL RATE,FORMAT(SUM(AMOUNT),'N2')AMOUNT,FORMAT(SUM(DISCOUNT),'N2')DISCOUNT,FORMAT(SUM(ECSAMOUNT),'N2')[ECS AMOUNT],
			FORMAT(SUM(SERVICETAX),'N2')[SERVICE CHARGE],FORMAT(SUM(NONTAXABLE)+SUM(TAXABLE),'N2')NETSALES,FORMAT(SUM(NONTAXABLE)+SUM(TAXABLE),'N2')[NON TAXABLE],FORMAT(SUM(NONTAXABLE),'N2')NONTAXABLE,FORMAT(SUM(TAXABLE),'N2')TAXABLE,FORMAT(SUM(VAT),'N2')[VAT AMOUNT],FORMAT(SUM(NETAMNT),'N2')[NET AMOUNT],NULL DIVNAME,NULL DIVID,NULL MCODE,'B' FLG, 'G' FFLG,0 STAMP FROM #TRNPROD

		END
	ELSE
		BEGIN		

			SELECT FORMAT(TDATE, 'MM-dd-yyyy') [DATE],BSDATE [MITI], VNO [BILL NO],REFBILL [REF NO],CUSTOMERNAME,VATNO,BASEUNIT [UNIT],BC [BARCODE],QTY,FORMAT(RATE,'N2')RATE,FORMAT(AMOUNT,'N2') [AMOUNT],FORMAT(DISCOUNT,'N2')DISCOUNT,
			FORMAT(ECSAMOUNT,'N2') [ECS AMOUNT], FORMAT(SERVICETAX,'N2') [SERVICE CHARGE],FORMAT(NONTAXABLE+TAXABLE,'N2') NETSALES,FORMAT(NONTAXABLE,'N2') [NON TAXABLE],FORMAT(TAXABLE,'N2')TAXABLE,FORMAT(VAT,'N2') [VAT AMOUNT],
			FORMAT(NETAMNT,'N2') [NET AMOUNT],DIVNAME,DIVID,A.MCODE,A.FFLG,COSTCENTER,REMARKS,A.SUPPLIER,A.TRNUSER,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C]
			FROM 
			(
				SELECT DISTINCT NULL TDATE, DESCA + ' (' + MENUCODE + ')' BSDATE,  NULL VNO,NULL REFBILL,NULL CUSTOMERNAME,NULL VATNO,NULL BASEUNIT,NULL BC,NULL QTY, NULL RATE, NULL AMOUNT,NULL DISCOUNT,NULL ECSAMOUNT,NULL SERVICETAX,NULL NONTAXABLE, NULL TAXABLE, NULL VAT, NULL NETAMNT, NULL DIVNAME,NULL DIVID,MCODE,'A' FLG,'B' FFLG, NULL STAMP,DESCA INAME,NULL COSTCENTER,NULL REMARKS,NULL SUPPLIER,NULL TRNUSER ,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C] FROM #TRNPROD_1
				UNION ALL
				SELECT A.TDATE,A.BSDATE,A.VNO,A.REFBILL,A.CUSTOMERNAME,A.VATNO,BASEUNIT,BC,NETQTY QTY,RATE,AMOUNT,DISCOUNT,ECSAMOUNT,SERVICETAX,NONTAXABLE,TAXABLE,VAT,NETAMNT,B.NAME DIVNAME,A.DIVISION DIVID,A.MCODE,'B' FLG, 'R' FFLG,A.STAMP,A.DESCA INAME,A.COSTCENTER,ISNULL(A.REMARKS,'')REMARKS,A.SUPPLIER ,A.TRNUSER,null [MAIN GROUP],null [SUB GROUP_A],null [SUB GROUP_B],null [SUB GROUP_C]
				FROM #TRNPROD_1 A INNER JOIN DIVISION B ON A.DIVISION = B.INITIAL
				UNION ALL
				SELECT NULL TDATE,NULL BSDATE,NULL VNO,NULL REFBILL,'                                                ITEM TOTAL :' SUPPLIERNAME,NULL,NULL BASEUNIT,NULL BC,SUM(NETQTY) QTY,NULL RATE,SUM(AMOUNT)AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(ECSAMOUNT)ECSAMOUNT,SUM(SERVICETAX)SERVICETAX,SUM(NONTAXABLE)NONTAXABLE,SUM(TAXABLE)TAXABLE,
				SUM(VAT)VAT,SUM(NETAMNT)NETAMNT,NULL DIVNAME,NULL DIVID,A.MCODE,'C' FLG, 'B' FFLG,NULL STAMP,A.DESCA INAME,NULL COSTCENTER,NULL REMARKS,NULL SUPPLIER,NULL TRNUSER ,null [MAIN GROUP],null [SUB GROUP_A],null [SUB GROUP_B],null [SUB GROUP_C]FROM #TRNPROD_1 A GROUP BY MCODE,DESCA
			) A ORDER BY INAME,FLG,TDATE, LEFT(VNO,2),A.STAMP

		
			SELECT NULL TDATE,NULL BSDATE,'   GRAND TOTAL   >>' [MITI],NULL REFBILL,NULL MENUCODE,NULL DESCA,NULL BASEUNIT,SUM(NETQTY)QTY,NULL RATE,FORMAT(SUM(AMOUNT),'N2')AMOUNT,FORMAT(SUM(DISCOUNT),'N2')DISCOUNT,FORMAT(SUM(ECSAMOUNT),'N2')[ECS AMOUNT],
			FORMAT(SUM(SERVICETAX),'N2')[SERVICE CHARGE],FORMAT(SUM(NONTAXABLE)+SUM(TAXABLE),'N2')NETSALES,FORMAT(SUM(NONTAXABLE),'N2')[NON TAXABLE],FORMAT(SUM(TAXABLE),'N2')TAXABLE,FORMAT(SUM(VAT),'N2')[VAT AMOUNT],FORMAT(SUM(NETAMNT),'N2')[NET AMOUNT],NULL DIVNAME,NULL DIVID,NULL MCODE,'B' FLG, 'G' FFLG,''BC,0 STAMP FROM #TRNPROD_1
		END
END
ELSE
	IF @SEGREGATEBYITEM = 0
		BEGIN
			SELECT FORMAT(TDATE, 'MM-dd-yyyy') [DATE],BSDATE [MITI],DESCA [ITEM NAME],BASEUNIT [UNIT],QTY,FORMAT(AMOUNT,'N2') [AMOUNT],FORMAT(DISCOUNT,'N2')DISCOUNT,
			FORMAT(ECSAMOUNT,'N2') [ECS AMOUNT], FORMAT(SERVICETAX,'N2') [SERVICE CHARGE],FORMAT(NONTAXABLE+TAXABLE,'N2')NETSALES,FORMAT(NONTAXABLE,'N2') [NON TAXABLE],FORMAT(TAXABLE,'N2')TAXABLE,FORMAT(VAT,'N2') [VAT AMOUNT],
			FORMAT(NETAMNT,'N2') [NET AMOUNT],A.MCODE,A.FFLG,SUPPLIER
			FROM 
			(
			SELECT DISTINCT NULL TDATE,DESCA + ' (' + MENUCODE + ')' BSDATE, NULL ITEMCODE,NULL DESCA,NULL BASEUNIT,NULL QTY, NULL AMOUNT,NULL DISCOUNT,NULL ECSAMOUNT, NULL SERVICETAX, NULL NONTAXABLE, NULL TAXABLE, NULL VAT, NULL NETAMNT, MCODE,'A' FLG,'B' FFLG, DESCA INAME,NULL SUPPLIER FROM #TRNPROD
			UNION ALL
			SELECT A.TDATE,A.BSDATE,NULL ITEMCODE,NULL ITEM_NAME,BASEUNIT,SUM(NETQTY) QTY,SUM(AMOUNT)AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(ECSAMOUNT)ECSAMOUNT,SUM(SERVICETAX)SERVICETAX,SUM(NONTAXABLE)NONTAXABLE,
			SUM(TAXABLE)TAXABLE,SUM(VAT)VAT,SUM(NETAMNT)NETAMNT, A.MCODE,'B' FLG, 'R' FFLG,DESCA INAME,A.SUPPLIER  FROM #TRNPROD A INNER JOIN DIVISION B ON A.DIVISION = B.INITIAL
			GROUP BY A.TDATE,A.BSDATE,DESCA,BASEUNIT, A.MCODE,A.SUPPLIER
			UNION ALL
			SELECT NULL TDATE,'                                                                   ITEM TOTAL :' BSDATE,NULL ITEMCODE, DESCA,NULL BASEUNIT,SUM(NETQTY) QTY,SUM(AMOUNT)AMOUNT,SUM(DISCOUNT)DISCOUNT,SUM(ECSAMOUNT)ECSAMOUNT,SUM(SERVICETAX)SERVICETAX,SUM(NONTAXABLE)NONTAXABLE,
			SUM(TAXABLE)TAXABLE,SUM(VAT)VAT,SUM(NETAMNT)NETAMNT, A.MCODE,'C' FLG, 'B' FFLG,DESCA INAME,NULL SUPPLIER  FROM #TRNPROD A 
			GROUP BY DESCA,A.MCODE
			) A ORDER BY INAME,FLG,TDATE

			SELECT NULL TDATE,NULL BSDATE,NULL MENUCODE,'   GRAND TOTAL   >>' [MITI],NULL BASEUNIT,SUM(NETQTY)QTY,NULL RATE,FORMAT(SUM(AMOUNT),'N2')AMOUNT,FORMAT(SUM(DISCOUNT),'N2')DISCOUNT,FORMAT(SUM(ECSAMOUNT),'N2')[ECS AMOUNT],
			FORMAT(SUM(SERVICETAX),'N2')[SERVICE CHARGE],FORMAT(SUM(NONTAXABLE)+SUM(TAXABLE),'N2')NETSALES,FORMAT(SUM(NONTAXABLE),'N2')[NON TAXABLE],FORMAT(SUM(TAXABLE),'N2')TAXABLE,FORMAT(SUM(VAT),'N2')[VAT AMOUNT],FORMAT(SUM(NETAMNT),'N2')[NET AMOUNT],NULL MCODE,'B' FLG, 'G' FFLG FROM #TRNPROD
	
		END
	ELSE
		BEGIN

			SELECT A.MENUCODE,A.DESCA ITEMNAME,[MAIN GROUP],[SUB GROUP_A],[SUB GROUP_B],[SUB GROUP_C],FORMAT(A.TDATE, 'MM-dd-yyyy')TDATE,A.BSDATE,BASEUNIT,SUM(NETQTY) QTY,FORMAT(SUM(AMOUNT),'N2')AMOUNT,FORMAT(SUM(DISCOUNT),'N2')DISCOUNT,SUM(ECSAMOUNT)ECSAMOUNT,SUM(SERVICETAX)SERVICETAX,FORMAT(SUM(NONTAXABLE)+SUM(TAXABLE),'N2')NETSALES,
			FORMAT(SUM(NONTAXABLE),'N2')NONTAXABLE,
			FORMAT(SUM(TAXABLE),'N2')TAXABLE,FORMAT(SUM(VAT),'N2')VAT,FORMAT(SUM(NETAMNT),'N2')NETAMNT, A.MCODE,'B' FLG, 'R' FFLG,DESCA INAME,A.SUPPLIER  FROM #TRNPROD A INNER JOIN DIVISION B ON A.DIVISION = B.INITIAL 
			GROUP BY A.TDATE,A.BSDATE,DESCA,BASEUNIT,A.MCODE,A.MENUCODE,A.SUPPLIER ORDER BY A.DESCA,A.TDATE		

			SELECT '   TOTAL   >>' ITEMNAME,NULL BASEUNIT,SUM(NETQTY)QTY,NULL RATE,FORMAT(SUM(AMOUNT),'N2')AMOUNT,FORMAT(SUM(DISCOUNT),'N2')DISCOUNT,FORMAT(SUM(ECSAMOUNT),'N2')[ECS AMOUNT],
			FORMAT(SUM(SERVICETAX),'N2')[SERVICE CHARGE],FORMAT(SUM(NONTAXABLE)+SUM(TAXABLE),'N2')NETSALES,FORMAT(SUM(NONTAXABLE),'N2')NONTAXABLE,FORMAT(SUM(TAXABLE),'N2')TAXABLE,FORMAT(SUM(VAT),'N2')VAT,FORMAT(SUM(NETAMNT),'N2')NETAMNT,NULL MCODE,'B' FLG, 'G' FFLG FROM #TRNPROD
	
		END
	

set nocount OFF

IF OBJECT_ID('TEMPDB..#TRNPROD') is not null drop table #TRNPROD
IF OBJECT_ID('TEMPDB..#TRNPROD_1') is not null drop table #TRNPROD_1

