CREATE OR ALTER   PROCEDURE [dbo].[WSP_DAYREPORT]
--DECLARE 
	@DATE1 DATE,
	@DATE2 DATE,
	@DIV VARCHAR(3) = '%',
	@COMID VARCHAR(25) = '%',
	@PHISCALID VARCHAR(15) = '%',
	@DETAILREPORT  TINYINT = 0,
	@USR VARCHAR(50) = '%',
	@VTYPE NVARCHAR(1000) = '%',
	@SHOWCASEOPENINGCLOSINGBL TINYINT =0
AS


SET NOCOUNT ON

IF OBJECT_ID('TEMPDB..#RESULT') IS NOT NULL DROP TABLE #RESULT
IF OBJECT_ID('TEMPDB..#RESULT1') IS NOT NULL DROP TABLE #RESULT1
IF OBJECT_ID('TEMPDB..#tblVTYPE') is not null drop table #tblVTYPE
IF OBJECT_ID('TEMPDB..#MAIN') IS NOT NULL DROP TABLE #MAIN


CREATE TABLE #tblVTYPE (VID varchar(100))
IF @VTYPE = '%'
	INSERT INTO #tblVTYPE SELECT VOUCHER_ID FROM VOUCHERTYPE WITH(NOLOCK)
ELSE
	INSERT INTO #tblVTYPE SELECT ITEMS FROM DBO.Split(@VTYPE ,',')

SELECT TRNDATE,LEFT(VCHRNO,2) VNO,VOUCHERTYPE VOUCHER_ID,VCHRNO,DIVISION,COMPANYID,PhiscalID,VOUCHERTYPE,TRNUSER,TRNTIME,REFBILL,Stamp 
INTO #MAIN 
FROM RMD_TRNMAIN WITH(NOLOCK)
WHERE (TRNDATE BETWEEN @DATE1 AND @DATE2) AND DIVISION LIKE @DIV AND PhiscalID LIKE @PHISCALID AND ISNULL(TRNUSER,'') LIKE @USR AND LEFT(VCHRNO,2) IN (SELECT VID FROM #tblVTYPE)

IF @DETAILREPORT  = 0
	BEGIN
		SELECT A.*,ROW_NUMBER() OVER (PARTITION BY TRNDATE,VOUCHERNAME,DIV ORDER BY TRNDATE,VOUCHERNAME,DIV,DRAMNT DESC) SN  INTO #RESULT FROM
		(
			SELECT A.TRNDATE,ISNULL(C.VOUCHER_TYPE,A.VNO)VOUCHERNAME,X.ACNAME,B.A_ACID,SUM(B.DRAMNT)DRAMNT,SUM(B.CRAMNT)CRAMNT, A.VNO,Y.NAME DIVISION,Y.INITIAL DIV, A.VOUCHER_ID
			FROM #MAIN A   INNER JOIN RMD_TRNTRAN B WITH(NOLOCK) ON A.VCHRNO = B.VCHRNO 
			LEFT JOIN VOUCHERTYPE C WITH(NOLOCK) ON A.VOUCHERTYPE = C.VOUCHER_ID 
			LEFT JOIN RMD_ACLIST X WITH(NOLOCK) ON B.A_ACID = X.ACID 
			LEFT JOIN DIVISION Y WITH(NOLOCK)  ON A.DIVISION = Y.INITIAL
			GROUP BY A.TRNDATE,ISNULL(C.VOUCHER_TYPE,A.VNO),X.ACNAME,B.A_ACID,Y.NAME,Y.INITIAL,VNO,A.VoucherType,A.VOUCHER_ID
		) A 

		SELECT BSDATE,VOUCHERNAME,ACNAME,DRAMNT,CRAMNT,DIVNAME,DIV,FFLG,VOUCHER_ID FROM 
		(
		SELECT NULL TRNDATE,NULL BSDATE,NULL VOUCHERNAME,'OPENING BL >> ' ACNAME,FORMAT(CASE WHEN BL >=0 THEN BL ELSE NULL END,'N2') DRAMNT, FORMAT(CASE WHEN BL<0 THEN BL ELSE NULL END,'N2') CRAMNT,NULL DIVNAME,NULL DIV,'B' FFLG,NULL VOUCHER_ID,1 ID,
		NULL TDATE,NULL VNAME,NULL DIVISION,NULL FLG,0 SN
		 FROM
		(
			SELECT SUM(DRAMNT)-SUM(CRAMNT) BL 
			FROM RMD_tRNTRAN A  WITH(NOLOCK) 
			INNER JOIN RMD_TRNMAIN B  WITH(NOLOCK) ON A.VCHRNO = B.VCHRNO 
			WHERE A_aCID IN (SELECT ACID FROM RMD_ACLIST WITH(NOLOCK) WHERE MAPID = 'C')  
			AND A.PhiscalID = @PHISCALID AND B.TRNDATE < @DATE1 OR A.VCHRNO LIKE 'OB%' AND @SHOWCASEOPENINGCLOSINGBL = 1
		) A 
		UNION ALL
		SELECT CASE WHEN SN = 1 THEN CONVERT(VARCHAR(10), cast(TRNDATE as date), 101) ELSE NULL END TRNDATE,CASE WHEN SN = 1 THEN MITI ELSE NULL END BSDATE,
		CASE WHEN SN = 1 THEN VOUCHERNAME ELSE NULL END VOUCHERNAME,ACNAME,FORMAT(DRAMNT,'N')DRAMNT,FORMAT(CRAMNT,'N')CRAMNT,
		CASE WHEN SN = 1 THEN DIVISION ELSE NULL END DIVNAME,DIV,FFLG,VOUCHER_ID,2 ID,TDATE,VNAME,ISNULL(DIVISION,'ZZZZZZZZZZZZ')DIVISION,FLG,SN
		FROM 
		(
		SELECT A.TRNDATE,X.MITI,A.VOUCHERNAME,A.ACNAME,A.DRAMNT,A.CRAMNT,A.VNO,A.DIVISION,A.DIV,A.SN,'A' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,'R' FFLG,A.VOUCHER_ID FROM #RESULT A LEFT JOIN DATEMITI X  WITH (NOLOCK) ON CONVERT(VARCHAR,A.TRNDATE,110) = CONVERT(VARCHAR,X.AD,110)
		UNION ALL
		SELECT NULL,NULL,NULL,'TOTAL >>',ROUND(SUM(DRAMNT),2),ROUND(SUM(CRAMNT),2),NULL,NULL,'ZZZZZZZ' DIVNAME,1 SN,'B' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,'B' FFLG,NULL FROM #RESULT GROUP BY TRNDATE,VOUCHERNAME
		UNION ALL
		SELECT DISTINCT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'ZZZZZZZ' DIV,100 SN,'C' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,'R' FFLG,NULL FROM #RESULT
		UNION ALL
		SELECT NULL,NULL,NULL,'TOTAL @ ' +  LEFT(CAST(TRNDATE AS VARCHAR(25)),11) + ' >>',ROUND(SUM(DRAMNT),2),ROUND(SUM(CRAMNT),2),NULL,NULL,'ZZZZZZZ' DIVNAME,1 SN,'D' FLG,TRNDATE TDATE,'ZZZZZZZZZZZZZZ' VNAME,'B' FFLG,NULL FROM #RESULT GROUP BY TRNDATE
		UNION ALL
		SELECT DISTINCT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,1 SN,'E' FLG,TRNDATE TDATE,'ZZZZZZZZZZZZZZ' VNAME,'R' FFLG,NULL FROM #RESULT GROUP BY TRNDATE
		) A 
		UNION ALL
		SELECT NULL TRNDATE,NULL BSDATE,NULL VOUCHERNAME,'CLOSING BL >> ' ACNAME,FORMAT(CASE WHEN BL >=0 THEN BL ELSE NULL END,'N2') DRAMNT, FORMAT(CASE WHEN BL<0 THEN BL ELSE NULL END,'N2') CRAMNT,NULL DIVNAME,NULL DIV,'B' FFLG,NULL VOUCHER_ID,3 ID,
		NULL TDATE,NULL VNAME,NULL DIVISION,NULL FLG,0 SN FROM
		(
			SELECT SUM(DRAMNT)-SUM(CRAMNT) BL 
			FROM RMD_tRNTRAN A WITH (NOLOCK) 
			INNER JOIN RMD_TRNMAIN B WITH  (NOLOCK)  ON A.VCHRNO = B.VCHRNO 
			WHERE A_aCID IN (SELECT ACID FROM RMD_ACLIST WITH(NOLOCK) WHERE MAPID = 'C')  
			AND A.PhiscalID = @PHISCALID AND B.TRNDATE <= @DATE2 AND  @SHOWCASEOPENINGCLOSINGBL = 1
		) A
		) A
		ORDER BY ID,TDATE,VNAME,ISNULL(DIVISION,'ZZZZZZZZZZZZ'),FLG,SN	--,ISNULL(DRAMNT,0) DESC

		SELECT NULL TRNDATE
	END
	
ELSE
	
	BEGIN
		SELECT A.TRNDATE,LEFT(A.VCHRNO,2)VNO,ISNULL(C.VOUCHER_TYPE,LEFT(A.VCHRNO,2))VOUCHERNAME,A.VCHRNO,B.A_ACID,SUM(B.DRAMNT)DRAMNT,SUM(B.CRAMNT)CRAMNT,X.ACNAME,A.DIVISION DIV,B.NARATION,B.COSTCENTER,B.CHEQUENO,B.CHEQUEDATE,A.TRNUSER,A.TRNTIME,Y.NAME DIVNAME,A.STAMP,A.REFBILL 
		INTO #RESULT1 
		FROM #MAIN A  
		INNER JOIN RMD_TRNTRAN B  WITH(NOLOCK) ON A.VCHRNO = B.VCHRNO
		LEFT JOIN VOUCHERTYPE C  WITH(NOLOCK) ON LEFT(A.VCHRNO,2) = ISNULL(C.VOUCHER_ID,'') 
		LEFT JOIN RMD_ACLIST X  WITH(NOLOCK) ON B.A_ACID = X.ACID 
		LEFT JOIN DIVISION Y  WITH(NOLOCK) ON A.DIVISION = Y.INITIAL
		GROUP BY  A.TRNDATE,LEFT(A.VCHRNO,2),ISNULL(C.VOUCHER_TYPE,LEFT(A.VCHRNO,2)),A.VCHRNO,B.A_ACID,X.ACNAME,A.DIVISION,B.NARATION,B.COSTCENTER,B.CHEQUENO,B.CHEQUEDATE,A.TRNUSER,A.TRNTIME,Y.NAME,A.STAMP,A.REFBILL

		SELECT * FROM 
		(
		SELECT NULL TRNDATE,NULL BSDATE,NULL VCHRNO,NULL REFNO,NULL VOUCHERNAME,'OPENING BL >> ' ACNAME,FORMAT(CASE WHEN BL >=0 THEN BL ELSE NULL END,'N2') DRAMNT, FORMAT(CASE WHEN BL<0 THEN BL ELSE NULL END,'N2') CRAMNT,
		NULL NARATION, NULL COSTCENTER,NULL CHEQUENO,NULL CHEQUEDATE,NULL TRNUSER,NULL TRNTIME,NULL DIVNAME,NULL VCHR,NULL FLG,0 SN,'B' FFLG,NULL [VOUCHER NO],1 ID,NULL TDATE,NULL VNAME,NULL STAMP,NULL SN1 FROM
		(
			SELECT SUM(DRAMNT)-SUM(CRAMNT) BL 
			FROM RMD_tRNTRAN A  WITH(NOLOCK) 
			INNER JOIN RMD_TRNMAIN B  WITH(NOLOCK) ON A.VCHRNO = B.VCHRNO
			WHERE A_aCID IN (SELECT ACID FROM RMD_ACLIST WITH(NOLOCK) WHERE MAPID = 'C') 
			AND A.PhiscalID = @PHISCALID AND B.TRNDATE < @DATE1 OR A.VCHRNO LIKE 'OB%' AND @SHOWCASEOPENINGCLOSINGBL = 1
		) A 

		UNION ALL

		SELECT CASE WHEN SN = 1 AND VOUCHERNAME NOT LIKE '%NAR%' THEN CONVERT(VARCHAR(10), cast(TRNDATE as date), 101) ELSE NULL END TRNDATE,CASE WHEN SN = 1 THEN X.MITI ELSE NULL END BSDATE,
		CASE WHEN SN = 1 THEN VCHRNO ELSE NULL END VCHRNO,CASE WHEN SN = 1 THEN REFNO ELSE NULL END REFNO,CASE WHEN SN = 1 OR VOUCHERNAME LIKE '%NAR%' THEN VOUCHERNAME ELSE NULL END VOUCHERNAME,
		ACNAME,FORMAT(DRAMNT,'N') DRAMNT,FORMAT(CRAMNT,'N')CRAMNT,NARATION,
		CASE WHEN SN = 1 THEN COSTCENTER ELSE NULL END COSTCENTER,
		CASE WHEN SN = 1 THEN CHEQUENO ELSE NULL END CHEQUENO,
		CASE WHEN SN = 1 THEN CHEQUEDATE ELSE NULL END CHEQUEDATE,
		CASE WHEN SN = 1 THEN TRNUSER ELSE NULL END TRNUSER,
		CASE WHEN SN = 1 THEN TRNTIME ELSE NULL END TRNTIME,
		CASE WHEN SN = 1 THEN DIVNAME ELSE NULL END DIVNAME,VCHR,FLG,SN,FFLG,CASE WHEN SN = 1 THEN VCHRNO ELSE NULL END  [VOUCHER NO],2 ID,TDATE,VNAME,STAMP,SN1
		FROM 
		(
		SELECT A.TRNDATE,A.VCHRNO,A.REFBILL REFNO,A.VOUCHERNAME,A.ACNAME,A.DRAMNT,A.CRAMNT,A.NARATION,X.COSTCENTERNAME COSTCENTER,A.CHEQUENO,A.CHEQUEDATE,A.TRNUSER,A.TRNTIME,A.DIVNAME,A.DIV,
		'A' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,VCHRNO VCHR,A.DRAMNT DR_AMNT,A.DIVNAME DIVISION,A.STAMP,ROW_NUMBER() OVER (PARTITION BY VCHRNO ORDER BY VCHRNO,DIV,DRAMNT DESC) SN,1 SN1,'R' FFLG FROM #RESULT1 A WITH(NOLOCK) 
		LEFT JOIN COSTCENTER X  WITH(NOLOCK) ON A.COSTCENTER = CAST(X.CCID AS varchar(50))
		UNION ALL
		SELECT NULL,NULL,NULL,NULL,'TOTAL >>',ROUND(SUM(DRAMNT),2),ROUND(SUM(CRAMNT),2),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'B' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,VCHRNO VCHR,0 DRAMNT,A.DIVNAME DIVISION,0 STAMP,100 SN,4 SN1,'B' FFLG FROM #RESULT1 A GROUP BY TRNDATE,VCHRNO,VOUCHERNAME,A.DIVNAME
		UNION ALL
		SELECT DISTINCT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'C' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,VCHRNO VCHR,0 DRAMNT,A.DIVNAME DIVISION,0 STAMP,101 SN,5 SN1,'R' FFLG  FROM #RESULT1 A
		UNION ALL
		SELECT NULL,NULL,NULL,NULL,'TOTAL OF ' + A.VOUCHERNAME + ' @ ' + CONVERT(VARCHAR,TRNDATE,110) + '  >>',ROUND(SUM(DRAMNT),2),ROUND(SUM(CRAMNT),2),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'D' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,'ZZZZ' VCHR, 0 DR_AMNT,'ZZZ' DIVISION,0 STAMP,102 SN, 6 SN1,'B' FFLG FROM #RESULT1 A GROUP BY TRNDATE,VOUCHERNAME
		UNION ALL
		SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'E' FLG,TRNDATE TDATE,VOUCHERNAME VNAME,'ZZZZ' VCHR, 0 DR_AMNT,'ZZZ' DIVISION,0 STAMP,103 SN, 7 SN1,'R' FFLG FROM #RESULT1 A GROUP BY TRNDATE,VOUCHERNAME
		UNION ALL
		SELECT NULL,NULL,NULL,NULL,'TOTAL OF DAY' +' @ ' + CONVERT(VARCHAR,TRNDATE,110) + '  >>',ROUND(SUM(DRAMNT),2),ROUND(SUM(CRAMNT),2),NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'F' FLG,TRNDATE TDATE,'ZZZZZZZ' VNAME,'ZZZZ' VCHR, 0 DR_AMNT,'ZZZ' DIVISION,0 STAMP,104 SN, 7 SN1,'B' FFLG FROM #RESULT1 A GROUP BY TRNDATE
		UNION ALL
		SELECT NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,NULL,'G' FLG,TRNDATE TDATE,'ZZZZZZZ' VNAME,'ZZZZ' VCHR, 0 DR_AMNT,'ZZZ' DIVISION,0 STAMP,105 SN,8 SN1,'R' FFLG FROM #RESULT1 A GROUP BY TRNDATE
		) A LEFT JOIN DATEMITI X  WITH(NOLOCK) ON CONVERT(VARCHAR,A.TRNDATE,110) = CONVERT(VARCHAR,X.AD,110)	

		UNION ALL

		SELECT NULL TRNDATE,NULL BSDATE,NULL VCHRNO,NULL REFNO,NULL VOUCHERNAME,'CLOSING BL >> ' ACNAME,FORMAT(CASE WHEN BL >=0 THEN BL ELSE NULL END,'N2') DRAMNT, FORMAT(CASE WHEN BL<0 THEN BL ELSE NULL END,'N2') CRAMNT,
		NULL NARATION, NULL COSTCENTER,NULL CHEQUENO,NULL CHEQUEDATE,NULL TRNUSER,NULL TRNTIME,NULL DIVNAME,NULL VCHR,NULL FLG,0 SN,'B' FFLG,NULL [VOUCHER NO],3 ID,NULL TDATE,NULL VNAME,NULL STAMP,NULL SN1 FROM
		(
			SELECT SUM(DRAMNT)-SUM(CRAMNT) BL 
			FROM RMD_tRNTRAN A  WITH(NOLOCK) 
			INNER JOIN RMD_TRNMAIN B  WITH(NOLOCK) ON A.VCHRNO = B.VCHRNO
			WHERE A_aCID IN (SELECT ACID FROM RMD_ACLIST WITH(NOLOCK) WHERE MAPID = 'C') 
			AND A.PhiscalID = @PHISCALID AND B.TRNDATE <= @DATE2 AND  @SHOWCASEOPENINGCLOSINGBL = 1
		) A 

		) A ORDER BY ID,TDATE,VNAME,LEFT(VCHR,2),VCHR,FLG,STAMP,SN,SN1

		SELECT NULL TRNDATE
	END
	
IF OBJECT_ID('TEMPDB..#RESULT') IS NOT NULL DROP TABLE #RESULT
IF OBJECT_ID('TEMPDB..#RESULT1') IS NOT NULL DROP TABLE #RESULT1
IF OBJECT_ID('TEMPDB..#tblVTYPE') is not null drop table #tblVTYPE
IF OBJECT_ID('TEMPDB..#MAIN') IS NOT NULL DROP TABLE #MAIN

SET NOCOUNT OFF