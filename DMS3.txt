 
ALTER       PROCEDURE [dbo].[DAB_SSMWISE_SALES]
--DECLARE
@DATE1	DATETIME ,
@DATE2	DATETIME ,
@PHISCALID	VARCHAR(10)	=	'%',
@MCODE	VARCHAR(MAX)	=	'%',
@STOCKIESTNAME VARCHAR(MAX)	=	'%',
@SALESMANID VARCHAR(MAX)	=	'%',
@REPMODE TINYINT= 0 ,--ALL 0 BEAT  1 , SALESMANWISE 2 ,STOCKIEST 3
@BEAT VARCHAR(MAX)		=	'%',
@REPCRITERIA VARCHAR(MAX)   output,
@REPORTNAME VARCHAR(MAX) output

AS
--select @DATE1='2023-03-31',@DATE2='2023-03-31',@REPMODE=3

SET @REPCRITERIA = '    ' +'@DATERANGE FROM :  ' + FORMAT(@DATE1, 'MM-dd-yyyy') + ' TO ' + FORMAT(@DATE2, 'MM-dd-yyyy') + '    @REPORTMODE :  ' + CASE  @REPMODE WHEN 0 THEN ' DETAIL ' WHEN 1 THEN ' BEAT WISE' WHEN 2 THEN ' SALESMAN WISE ' WHEN 3 THEN ' STOCKIST WISE ' END

SET @REPORTNAME = 'SSM WISE SALES REPORT'

SET NOCOUNT ON;


IF OBJECT_ID('TEMPDB..#DATA') IS NOT NULL DROP TABLE #DATA

SELECT  
		IIF(@REPMODE=0 , convert(varchar,TRNDATE,23),'') [TRNDATE],
		IIF(@REPMODE<=1 , isnull(G.RouteName,'') ,'')[BEAT_NAME],
		IIF(@REPMODE<=2 ,isnull(F.NAME,''),'')SALESMAN,
		IIF(@REPMODE<=3 ,isnull(C.ACNAME,''),'')[STOCKIEST NAME], 
		IIF(@REPMODE =0,X.ACNAME,'')[OUTLET NAME],
		D.MCAT DIVISION,
		DESCA [PRODUCT DESCRIPTION],
		IIF(E.CONFACTOR=0,SUM(REALQTY),SUM(REALQTY)/E.CONFACTOR) [SALES VOLUME],
		SUM(B.TAXABLE+B.NONTAXABLE) [SALES VALUE]

INTO
		#DATA
FROM 
		TRNMAIN A WITH(NOLOCK) 
JOIN 
		TRNPROD B WITH(NOLOCK)			ON A.VCHRNO = B.VCHRNO
JOIN
		RMD_ACLIST C WITH(NOLOCK)		ON A.COMPANYID = C.customerID
JOIN
		RMD_ACLIST X WITH(NOLOCK)		ON A.PARAC = X.ACID
JOIN
		MENUITEM D WITH(NOLOCK)			ON B.MCODE = D.MCODE
LEFT JOIN
		MULTIALTUNIT E WITH(NOLOCK)		ON B.MCODE = E.MCODE AND UPPER(E.ALTUNIT) = 'CASE'
LEFT JOIN
		SALESMAN F WITH(NOLOCK)			ON A.SALESMANID = F.SSMCODE
LEFT JOIN
		ROUTE_MASTER G WITH(NOLOCK)		ON A.RouteCode = G.RouteCode
WHERE
		TRNDATE BETWEEN @DATE1 AND @DATE2 AND A.VoucherType <> 'CN'
		AND (@MCODE = '%' OR (@MCODE <> '%' AND B.MCODE IN	(SELECT * FROM DBO.Split(@MCODE,','))))
		AND (@STOCKIESTNAME = '%' OR (@STOCKIESTNAME <> '%' AND A.COMPANYID IN (SELECT * FROM DBO.SPLIT(@STOCKIESTNAME,','))))
		AND (@SALESMANID = '%' OR (@SALESMANID <> '%' AND A.SALESMANID IN (SELECT * FROM DBO.SPLIT(@SALESMANID,','))))
		AND (@BEAT = '%' OR (@BEAT <> '%' AND A.RouteCode IN (SELECT * FROM DBO.SPLIT(@BEAT,','))))
GROUP BY  


D.MCAT,DESCA,  IIF(@REPMODE=0 , convert(varchar,TRNDATE,23),''),
		IIF(@REPMODE<=1 , isnull(G.RouteName,'') ,''),
		IIF(@REPMODE<=2 ,isnull(F.NAME,''),''),
		IIF(@REPMODE <=3 ,isnull(C.ACNAME,''),''), 
		IIF(@REPMODE =0,X.ACNAME,''),
	 E.CONFACTOR 

 




SELECT TRNDATE [DATE],BEAT_NAME [BEAT NAME],SALESMAN,[STOCKIEST NAME],[OUTLET NAME],DIVISION,[PRODUCT DESCRIPTION],[SALES VOLUME],[SALES VALUE],FFLG FROM (
SELECT 
		CONVERT(VARCHAR,TRNDATE,23)[TRNDATE],
		[BEAT_NAME],
		SALESMAN,
		[STOCKIEST NAME], 
		[OUTLET NAME],
		DIVISION,
		[PRODUCT DESCRIPTION],
		FORMAT([SALES VOLUME],'N2')[SALES VOLUME],
		FORMAT([SALES VALUE],'N0')[SALES VALUE],
		BEAT_NAME XBEAT,
		SALESMAN XSALESMAN,
		[STOCKIEST NAME] XSTOCKIST,
		'A' FLG,'R' FFLG
		FROM #DATA
 
UNION ALL
 
	
	 SELECT 
		IIF(@REPMODE=0,CONVERT(VARCHAR,TRNDATE,23),''),
		IIF(@REPMODE=1,[BEAT_NAME],''),
		IIF(@REPMODE IN(2,0),[SALESMAN],''),
		IIF(@REPMODE=3,[STOCKIEST NAME],''), 
		'' [OUTLET NAME],
		'' DIVISION,
		'' [PRODUCT DESCRIPTION],
		FORMAT(SUM([SALES VOLUME]),'N2') [SALES VOLUME],
		FORMAT(SUM([SALES VALUE]),'N0')[SALES VALUE] ,
		IIF(@REPMODE=1,[BEAT_NAME],'') XBEAT,
		IIF(@REPMODE IN(2,0),[SALESMAN],'') XSALESMAN,
		IIF(@REPMODE=3,[STOCKIEST NAME],'') XSTOCKIST,
		'ZZZZZZ' FLG ,'B' FFLG
		FROM #DATA
		
		GROUP BY IIF(@REPMODE=0,CONVERT(VARCHAR,TRNDATE,23),'') ,IIF(@REPMODE=1,[BEAT_NAME],''),IIF(@REPMODE IN(2,0),[SALESMAN],''),IIF(@REPMODE=3,[STOCKIEST NAME],'')

)SUMM
 ORDER BY 
 CASE @REPMODE WHEN 0 THEN TRNDATE WHEN 1 THEN XBEAT WHEN 2 THEN XSALESMAN WHEN 3 THEN XSTOCKIST END,IIF (@REPMODE<>0 ,FLG,'') ASC,
 CASE @REPMODE WHEN 0 THEN XSALESMAN  WHEN 1 THEN XSALESMAN WHEN 2 THEN XSTOCKIST END,IIF (@REPMODE=0 ,FLG,'') ASC,
 CASE @REPMODE WHEN 0 THEN XBEAT WHEN 1 THEN XSTOCKIST END,
 CASE @REPMODE WHEN 0 THEN XSTOCKIST END,
 IIF(@REPMODE=0,[OUTLET NAME],''),ISNULL([PRODUCT DESCRIPTION],'ZZZZZZZ') ASC

 IF @REPMODE = 0
  SELECT ' TOTAL :' [STOCKIEST NAME] , FORMAT(SUM([SALES VOLUME]),'N2') [SALES VOLUME] , FORMAT(SUM([SALES VALUE]),'N2') [SALES VALUE] FROM #DATA
ELSE 
  SELECT NULL