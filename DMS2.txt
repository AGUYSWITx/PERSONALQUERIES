CREATE OR ALTER   PROC [dbo].[DAB_ECO_BRAND_SKU_REPORT]
--DECLARE

@date DATETIME,
@date2 Datetime = '1900-01-01',
@MCODE VARCHAR(MAX)='%',
@MCAT VARCHAR(MAX)='%',
@REPORTTYPE  VARCHAR(100)='MTD' ,
@SALESMANID VARCHAR(MAX)='%',--SALESMANID
@STOCKIESTNAME VARCHAR(MAX)='%',--COMPANYID
@BEAT VARCHAR(MAX)='%',--ROUTECODE
@BRAND VARCHAR(MAX)='%'
,@REPCRITERIA VARCHAR(MAX)  OUTPUT,
@REPORTNAME VARCHAR(100)  OUTPUT
AS
--SELECT @DATE='2023-04-27' 

SET @REPCRITERIA = '@As On Dated : ' + FORMAT(@DATE, 'MM-dd-yyyy') +' Report Type: '+@REPORTTYPE 
IF @REPORTTYPE ='MTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-MTD';
IF @REPORTTYPE ='YTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-YTD';
IF @REPORTTYPE ='QTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-QTD';
IF @REPORTTYPE ='CUS'
SET @REPORTNAME = 'ECO-SKU-BRAND-CUSTOM';

if OBJECT_ID('tempdb..#DATA') is not null drop table #DATA

if OBJECT_ID('tempdb..#MAIN') is not null drop table #MAIN


if OBJECT_ID('tempdb..#RESULT') is not null drop table #RESULT
--
SELECT A.TRNDATE,A.PARAC,MI.MCODE MMCODE ,MI.DESCA,MI.MCAT ,G.RouteName [BEAT_NAME],F.NAME SALESMAN,C.ACNAME STOCKIESTNAME ,B.*  INTO #MAIN   FROM TRNPROD B JOIN (SELECT DISTINCT VCHRNO,PARAC,TRNDATE,SALESMANID,ROUTECODE,COMPANYID FROM TRNMAIN )A ON A.VCHRNO= B.VCHRNO AND B.VOUCHERTYPE='TI'
JOIN (SELECT DISTINCT MCODE,CATEGORYCODE,DESCA,MCAT,BRAND_MANUAL,SIZE_MANUAL FROM MENUITEM) MI ON MI.MCODE=B.MCODE
JOIN (SELECT DISTINCT BRANDID , BRANDNAME FROM BRAND) BR ON BR.BRANDID=MI.CATEGORYCODE
 LEFT JOIN 
		ROUTE_MASTER G WITH (NOLOCK) ON A.ROUTECODE=G.ROUTECODE
		LEFT JOIN SALESMAN F WITH (NOLOCK) ON A.SALESMANID=F.SSMCODE 
		LEFT JOIN RMD_ACLIST C WITH (NOLOCK) ON A.COMPANYID =C.customerID
		WHERE B.MCODE LIKE @MCODE 
		AND DIVISION LIKE @MCAT 
		AND A.SALESMANID LIKE @SALESMANID 
		AND A.RouteCode LIKE @BEAT
		AND A.COMPANYID LIKE @STOCKIESTNAME
		AND MI.BRAND_MANUAL LIKE @BRAND
			
		--DIVISION IS FOR FOOD (MCAT)
  
 ---RESULT QUERY
	SELECT * ,
		CASE WHEN OUTLET_LY=0 THEN 0 ELSE (CAST (ECO_LY AS float)*100)  /OUTLET_LY  END [ECO%LY],
		  	CASE WHEN OUTLET_LM=0 THEN 0 ELSE (CAST (ECO_LM AS float)/OUTLET_LM) *100  END [ECO%LM], 	CASE WHEN OUTLET_CM=0 THEN 0 ELSE (CAST (ECO_CM AS float) /OUTLET_CM)*100    END [ECO%CM]
		  INTO
		  #RESULT
		FROM 
		(
select   MCODE  MATERIALCODE , BEAT_NAME,SALESMAN,STOCKIESTNAME,
		--START OF ECO_LY
		COUNT( DISTINCT CASE 
        WHEN 
			(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1  AND TRNDATE<=@DATE  ) 
		THEN PARAC 
		
		 WHEN 
		(@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE), 0)) AND @DATE) 
	   THEN PARAC  
		WHEN 
		(@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @date) AND DATEADD(year, -1, @date2)) 
	   THEN PARAC  
 
	 
      ELSE NULL
    END) AS ECO_LY --END OF ECO_LY
	,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE)) AND TRNDATE<=@DATE)
		THEN PARAC
		 
            ELSE NULL --FOR QTD AND YTD
    END) AS ECO_LM,
	COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)   AND TRNDATE<=@DATE  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE), 0)) AND @DATE) 
	   THEN PARAC 
		 WHEN 
			(@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN     @date  AND   @date2 )
	   THEN PARAC  
 
	 
      ELSE NULL
            
    END) AS ECO_CM

	 
	from(

SELECT * FROM #MAIN
 

 )A  GROUP BY MCODE ,BEAT_NAME,SALESMAN,STOCKIESTNAME

 )EC
 CROSS APPLY
 (
 SELECT 
 COUNT( DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1  AND TRNDATE<=@DATE  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN 
	  ( DATEADD(qq, DATEDIFF(qq, 0, DATEADD(yy, -1, @DATE)), 0)) AND 
	  (DATEADD(yy, -1, @DATE)) )

   THEN PARAC  
  
  ELSE NULL
    END) AS OUTLET_LY,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE)) AND TRNDATE<=@DATE)
		THEN PARAC  
            ELSE NULL --FOR QTD AND YTD
    END) AS OUTLET_LM,
		COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)   AND TRNDATE<=@DATE  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE), 0)) AND @DATE) 
   THEN PARAC  
 
	 
      ELSE NULL

    END) AS OUTLET_CM

 FROM #MAIN) OL
 
 

 SELECT  A.MATERIALCODE,B.DESCA	MATERIALNAME,B.BRAND_MANUAL,B.SIZE_MANUAL,MCAT DIVISION,BEAT_NAME,	SALESMAN	,STOCKIESTNAME,	ECO_LY	,ECO_LM	,ECO_CM,	OUTLET_LM,	OUTLET_CM	,[ECO%LY],	[ECO%LM]	,[ECO%CM] FROM #RESULT A JOIN MENUITEM B ON A.MATERIALCODE=B.MCODE 
 order by STOCKIESTNAME asc , SALESMAN asc, BEAT_NAME asc,BRAND_MANUAL asc,b.DESCA asc


 SELECT  NULL MATERIALCODE,NULL  MATERIALNAME,NULL BRAND_MANUAL,NULL SIZE_MANUAL,NULL DIVISION,NULL BEAT_NAME,	NULL SALESMAN	,NULL STOCKIESTNAME,SUM	(ECO_LY) ECO_LY	,SUM(ECO_LM) ECO_LM	,SUM(ECO_CM) ECO_CM ,	NULL OUTLET_LY ,	NULL OUTLET_LM,	NULL OUTLET_CM,NULL [ECO%LY],
 NULL [ECO%LM],NULL [ECO%CM] FROM #RESULT
  