 
 
 ALTER   PROC [dbo].[DAB_ECO_BRAND_SKU_REPORT]
--DECLARE

@DATE1 DATETIME,
@DATE2 Datetime = '1900-01-01',
@MCODE VARCHAR(MAX)='%',
@MCAT VARCHAR(MAX)='%',
@REPORTTYPE  VARCHAR(100)='MTD' ,
@REPMODE TINYINT= 1 ,--BEAT  0 , SALESMANWISE 1 ,STOCKIEST 2
@SALESMANID VARCHAR(MAX)='%',--SALESMANID
@STOCKIESTNAME VARCHAR(MAX)='%',--COMPANYID
@BEAT VARCHAR(MAX)='%',--ROUTECODE
@BRAND VARCHAR(MAX)='%',
@SUMMARY TINYINT =0,--0 DETAIL,1 SUMMARY BRAND,2 SUMMARY SIZE
@REPCRITERIA VARCHAR(MAX)    OUTPUT,
@REPORTNAME VARCHAR(100)     OUTPUT

AS
--SELECT @DATE2='2023-04-27' ,@REPMODE=1,@SUMMARY=2



IF (@SUMMARY=0)
 BEGIN
SET @REPCRITERIA = '@As On Dated : ' + FORMAT(@DATE2, 'MM-dd-yyyy') +' Report Type: '+@REPORTTYPE 
IF @REPORTTYPE ='MTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-MTD';
IF @REPORTTYPE ='YTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-YTD';
IF @REPORTTYPE ='QTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-QTD';
IF @REPORTTYPE ='CUS'
SET @REPORTNAME = 'ECO-SKU-BRAND-CUSTOM';

if OBJECT_ID('tempdb..#DATA') is not null drop table #DATA

if OBJECT_ID('tempdb..#MAIN') is not null drop table #MAIN


if OBJECT_ID('tempdb..#RESULT') is not null drop table #RESULT 
if OBJECT_ID('tempdb..#RESULT2') is not null drop table #RESULT2
--
--
SELECT A.TRNDATE,A.PARAC,GRA.DRCP,MI.MCODE MMCODE ,MI.DESCA,MI.MCAT ,G.RouteName [BEAT_NAME],F.NAME SALESMAN,C.ACNAME STOCKIESTNAME ,B.*  INTO #MAIN   FROM TRNPROD B JOIN (SELECT DISTINCT VCHRNO,PARAC,TRNDATE,SALESMANID,ROUTECODE,COMPANYID,VoucherType FROM TRNMAIN )A ON A.VCHRNO= B.VCHRNO AND B.VOUCHERTYPE='TI'
JOIN (SELECT DISTINCT MCODE,CATEGORYCODE,DESCA,MCAT,BRAND_MANUAL,SIZE_MANUAL FROM MENUITEM) MI ON MI.MCODE=B.MCODE 
 LEFT JOIN 
		ROUTE_MASTER G WITH (NOLOCK) ON A.ROUTECODE=G.ROUTECODE
		LEFT JOIN SALESMAN F WITH (NOLOCK) ON A.SALESMANID=F.SSMCODE 
		LEFT JOIN RMD_ACLIST C WITH (NOLOCK) ON A.COMPANYID =C.customerID
		LEFT JOIN 
		(SELECT DISTINCT SSMCODE, COUNT(DISTINCT ACID)DRCP FROM RMD_ACLIST GROUP BY SSMCODE) GRA ON GRA.SSMCODE=F.SSMCODE
		WHERE 
		  A.VoucherType NOT IN ( 'CN','RE') AND
		A.VCHRNO NOT IN (SELECT REFBILL FROM TRNMAIN WHERE VoucherType   IN ( 'CN','RE'))and
		(@MCODE = '%' OR ( @MCODE <> '%' AND B.MCODE IN (SELECT * FROM DBO.SPLIT(@MCODE,',')))) 
		AND(@MCAT = '%' OR ( @MCAT <> '%' AND MI.MCAT IN (SELECT * FROM DBO.SPLIT(@MCAT,',')))) 
		AND(@SALESMANID = '%' OR (@SALESMANID <> '%' AND A.SALESMANID  IN (SELECT * FROM DBO.SPLIT(@SALESMANID,',')))) 
		AND(@BEAT = '%' OR ( @BEAT <> '%' AND A.RouteCode  IN (SELECT * FROM DBO.SPLIT(@BEAT,','))))
		AND(@STOCKIESTNAME = '%' OR ( @STOCKIESTNAME <> '%' AND A.COMPANYID  IN (SELECT * FROM DBO.SPLIT(@STOCKIESTNAME,','))))
		AND(@BRAND = '%' OR ( @BRAND <> '%' AND MI.BRAND_MANUAL  IN (SELECT * FROM DBO.SPLIT(@BRAND,','))))	
		--DIVISION IS FOR FOOD (MCAT)
  
   
 ---JOIN FOR DIFFERENT WISE




	SELECT  MATERIALCODE,	EC.BEAT_NAME,	EC.SALESMAN,	EC.STOCKIESTNAME,	EC.ECO_LY	,EC.ECO_LM	,EC.ECO_CM 	,
	COALESCE(OLSSM.DRCP,OLBEAT.DRCP,OLSTK.DRCP)DRCP,
	COALESCE(OLSSM.OUTLET_LY,OLBEAT.OUTLET_LY,OLSTK.OUTLET_LY)OUTLET_LY,
	COALESCE(OLSSM.OUTLET_LM,OLBEAT.OUTLET_LM,OLSTK.OUTLET_LM)	OUTLET_LM,
	COALESCE(OLSSM.OUTLET_CM,OLBEAT.OUTLET_CM,OLSTK.OUTLET_CM)	OUTLET_CM 	 INTO #RESULT		FROM 
		(
select   MCODE  MATERIALCODE , IIF(@REPMODE=0 ,BEAT_NAME,'')BEAT_NAME,IIF(@REPMODE<=1 ,SALESMAN,'')SALESMAN, IIF(@REPMODE <=2 ,STOCKIESTNAME,'')STOCKIESTNAME,
		--START OF ECO_LY
		COUNT( DISTINCT CASE 
        WHEN 
			(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
		 WHEN 
		(@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
	   THEN PARAC  
		WHEN 
		(@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2)) 
	   THEN PARAC  
 
	 
      ELSE NULL
    END) AS ECO_LY --END OF ECO_LY
	,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC
		 
            ELSE NULL --FOR QTD AND YTD
    END) AS ECO_LM,
	COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2 ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
	   THEN PARAC 
		 WHEN 
			(@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN     @DATE1  AND   @date2 )
	   THEN PARAC  
 
	 
      ELSE NULL
            
    END) AS ECO_CM

	 
	from(

SELECT * FROM #MAIN
 

 )A  GROUP BY MCODE , IIF(@REPMODE=0 ,BEAT_NAME,''),
	 IIF(@REPMODE<=1 ,SALESMAN,''),
	 IIF(@REPMODE <=2 ,STOCKIESTNAME,'') 


 )EC
LEFT join
 (
 SELECT SALESMAN  ,DRCP,
 COUNT( DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN 
	  ( DATEADD(qq, DATEDIFF(qq, 0, DATEADD(yy, -1, @DATE2)), 0)) AND 
	  (DATEADD(yy, -1, @DATE2)) )

   THEN PARAC  
  
  ELSE NULL
    END) AS OUTLET_LY,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC  
            ELSE NULL --FOR QTD AND YTD
    END) AS OUTLET_LM,
		COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN PARAC  
 
	 
      ELSE NULL

    END) AS OUTLET_CM

 FROM #MAIN  group by SALESMAN ,DRCP ) OLSSM
 on
 OLSSM.SALESMAN=ec.SALESMAN AND @REPMODE=1
 LEFT join
 (
 SELECT BEAT_NAME ,DRCP,
 COUNT( DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN 
	  ( DATEADD(qq, DATEDIFF(qq, 0, DATEADD(yy, -1, @DATE2)), 0)) AND 
	  (DATEADD(yy, -1, @DATE2)) )

   THEN PARAC  
  
  ELSE NULL
    END) AS OUTLET_LY,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC  
            ELSE NULL --FOR QTD AND YTD
    END) AS OUTLET_LM,
		COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2 ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN PARAC  
 
	 
      ELSE NULL

    END) AS OUTLET_CM

 FROM #MAIN  group by BEAT_NAME,DRCP  ) OLBEAT
 on
 OLBEAT.BEAT_NAME=ec.BEAT_NAME AND @REPMODE=0

 LEFT join
 (
 SELECT STOCKIESTNAME , SUM(DRCP ) DRCP ,
 COUNT( DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2 ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN 
	  ( DATEADD(qq, DATEDIFF(qq, 0, DATEADD(yy, -1, @DATE2)), 0)) AND 
	  (DATEADD(yy, -1, @DATE2)) )

   THEN PARAC  
  
  ELSE NULL
    END) AS OUTLET_LY,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC  
            ELSE NULL --FOR QTD AND YTD
    END) AS OUTLET_LM,
		COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2 ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN PARAC  
 
	 
      ELSE NULL

    END) AS OUTLET_CM

 FROM #MAIN  group by STOCKIESTNAME) OLSTK
 on
 OLSTK.STOCKIESTNAME=ec.STOCKIESTNAME AND @REPMODE=2
 
  
   

 SELECT   MATERIALCODE,	BEAT_NAME,B.DESCA MATERIALNAME ,B.BRAND_MANUAL,B.SIZE_MANUAL,MCAT DIVISION,	SALESMAN,	STOCKIESTNAME,	ECO_LY	,ECO_LM	,ECO_CM	,DRCP,	OUTLET_LY,	OUTLET_LM,	OUTLET_CM  ,CASE WHEN OUTLET_LY=0 THEN 0 ELSE (CAST (ECO_LY AS float)*100)  /OUTLET_LY  END [ECO%LY],
		  	CASE WHEN OUTLET_LM=0 THEN 0 ELSE (CAST (ECO_LM AS float)/OUTLET_LM) *100  END [ECO%LM], 	CASE WHEN OUTLET_CM=0 THEN 0 ELSE (CAST (ECO_CM AS float) /OUTLET_CM)*100    END [ECO%CM]
		  INTO
		  #RESULT2 FROM #RESULT A LEFT JOIN MENUITEM B ON A.MATERIALCODE=B.MCODE 
  
 
  

 
 --RESULT QUERY
 SELECT   MATERIALCODE	,MATERIALNAME,	NULLIF(BRAND_MANUAL,	'ZZZZZZZZZZ')BRAND_MANUAL,NULLIF (SIZE_MANUAL,'ZZZZZZZZZZ')SIZE_MANUAL,DIVISION	,BEAT_NAME,	SALESMAN	,STOCKIESTNAME,	DRCP	,ECO_LY	,ECO_LM,	ECO_CM,	OUTLET_LY,	OUTLET_LM	,OUTLET_CM	,[ECO%LY] 	,[ECO%LM],	[ECO%CM],	FLG,	FFLG  FROM (
 SELECT   MATERIALCODE,  	MATERIALNAME, BRAND_MANUAL, SIZE_MANUAL,  DIVISION,
		 BEAT_NAME,
		 SALESMAN	,
		 STOCKIESTNAME,
		 DRCP,
		 ECO_LY	,
		 ECO_LM	,
		 ECO_CM, 
		 OUTLET_LY,	
		 OUTLET_LM,
		 OUTLET_CM	,
		 format([ECO%LY],'n2') [ECO%LY],
		 format([ECO%LM],'n2') [ECO%LM],
		 format([ECO%CM],'n2')[ECO%CM],
		 'A'FLG ,'R'FFLG
 FROM #RESULT2 

 UNION ALL

 SELECT  'TOTAL' MATERIALCODE,NULL  MATERIALNAME,  'ZZZZZZZZZZ' BRAND_MANUAL,
	   'ZZZZZZZZZZ'SIZE_MANUAL	 ,NULL DIVISION,
		 IIF(@REPMODE=0,BEAT_NAME,NULL)BEAT,
		 IIF(@REPMODE=1,SALESMAN,NULL)SALESMAN,
		 IIF(@REPMODE=2,STOCKIESTNAME,NULL)STOCKEISTNAME,
		 NULL DRCP,
		 SUM	(ECO_LY) ECO_LY	,
		 SUM(ECO_LM) ECO_LM	,
		 SUM(ECO_CM) ECO_CM ,
		 NULL OUTLET_LY ,
		 NULL OUTLET_LM,
		 NULL OUTLET_CM,
		 NULL [ECO%LY],
		 NULL [ECO%LM],
		 NULL [ECO%CM],
		 'C'FLG ,'B'FFLG
		 FROM #RESULT2 GROUP BY IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL)
  
  UNION ALL
  
  SELECT 
	 NULL MATERIALCODE	,
	 NULL MATERIALNAME	,
	  BRAND_MANUAL,
	 SIZE_MANUAL	,
	 NULL DIVISION	,
	 IIF(@REPMODE=0,BEAT_NAME,NULL)BEAT,
	 IIF(@REPMODE=1,SALESMAN,NULL)SALESMAN,
	 IIF(@REPMODE=2,STOCKIESTNAME,NULL)STOCKEISTNAME, 
	 NULL DRCP,
		 SUM (ECO_LY) ECO_LY	,
		 SUM(ECO_LM) ECO_LM	,
		 SUM(ECO_CM) ECO_CM ,
		 NULL OUTLET_LY ,
		 NULL OUTLET_LM,
		 NULL OUTLET_CM,
		 NULL [ECO%LY],
		 NULL [ECO%LM],
		 NULL [ECO%CM],
		 'B'FLG ,'B'FFLG 
		 FROM #RESULT2 GROUP BY BRAND_MANUAL ,SIZE_MANUAL,IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL)


  )SUUM
  ORDER BY CASE @REPMODE WHEN 0 THEN BEAT_NAME WHEN 1 THEN SALESMAN  WHEN 2 THEN STOCKIESTNAME END ,  SUUM.BRAND_MANUAL  ,   SUUM.SIZE_MANUAL  ,FLG


SELECT NULL

END

ELSE
BEGIN


SET @REPCRITERIA = '@As On Dated : ' + FORMAT(@DATE2, 'MM-dd-yyyy') +' Report Type: '+@REPORTTYPE 
IF @REPORTTYPE ='MTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-MTD-SUMMARY';
IF @REPORTTYPE ='YTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-YTD-SUMMARY';
IF @REPORTTYPE ='QTD'
SET @REPORTNAME = 'ECO-SKU-BRAND-QTD-SUMMARY';
IF @REPORTTYPE ='CUS'
SET @REPORTNAME = 'ECO-SKU-BRAND-CUSTOM-SUMMARY';


if OBJECT_ID('tempdb..#DATA2') is not null drop table #DATA2

if OBJECT_ID('tempdb..#MAIN2') is not null drop table #MAIN2


if OBJECT_ID('tempdb..#RESULTX') is not null drop table #RESULTX 
if OBJECT_ID('tempdb..#RESULT2X') is not null drop table #RESULT2X

SELECT A.TRNDATE,A.PARAC ,MI.MCODE MMCODE ,MI.BRAND_MANUAL,MI.SIZE_MANUAL,MI.DESCA,MI.MCAT ,G.RouteName [BEAT_NAME],F.NAME SALESMAN,C.ACNAME STOCKIESTNAME ,B.*  INTO #MAIN2  FROM TRNPROD B JOIN (SELECT DISTINCT VCHRNO,PARAC,TRNDATE,SALESMANID,ROUTECODE,COMPANYID FROM TRNMAIN )A ON A.VCHRNO= B.VCHRNO AND B.VOUCHERTYPE='TI'
JOIN (SELECT DISTINCT MCODE,CATEGORYCODE,DESCA,MCAT,BRAND_MANUAL,SIZE_MANUAL FROM MENUITEM) MI ON MI.MCODE=B.MCODE 
 LEFT JOIN 
		ROUTE_MASTER G WITH (NOLOCK) ON A.ROUTECODE=G.ROUTECODE
		LEFT JOIN SALESMAN F WITH (NOLOCK) ON A.SALESMANID=F.SSMCODE 
		LEFT JOIN RMD_ACLIST C WITH (NOLOCK) ON A.COMPANYID =C.customerID
		LEFT JOIN 
		(SELECT DISTINCT SSMCODE, COUNT(DISTINCT ACID)DRCP FROM RMD_ACLIST GROUP BY SSMCODE) GRA ON GRA.SSMCODE=F.SSMCODE
		WHERE 
		(@MCODE = '%' OR ( @MCODE <> '%' AND B.MCODE IN (SELECT * FROM DBO.SPLIT(@MCODE,',')))) 
		AND(@MCAT = '%' OR ( @MCAT <> '%' AND MI.MCAT IN (SELECT * FROM DBO.SPLIT(@MCAT,',')))) 
		AND(@SALESMANID = '%' OR (@SALESMANID <> '%' AND A.SALESMANID  IN (SELECT * FROM DBO.SPLIT(@SALESMANID,',')))) 
		AND(@BEAT = '%' OR ( @BEAT <> '%' AND A.RouteCode  IN (SELECT * FROM DBO.SPLIT(@BEAT,','))))
		AND(@STOCKIESTNAME = '%' OR ( @STOCKIESTNAME <> '%' AND A.COMPANYID  IN (SELECT * FROM DBO.SPLIT(@STOCKIESTNAME,','))))
		AND(@BRAND = '%' OR ( @BRAND <> '%' AND MI.BRAND_MANUAL  IN (SELECT * FROM DBO.SPLIT(@BRAND,','))))	


		 
   

 SELECT    	EC.BRAND_MANUAL, EC.SIZE_MANUAL,	EC.MCAT,EC.SALESMAN,	EC.ECO_LY	,EC.ECO_LM	,EC.ECO_CM 	 , 
	COALESCE(OLBR.OUTLET_LY,OLSZ.OUTLET_LY,OLSSM.OUTLET_LY)OUTLET_LY,
	COALESCE(OLBR.OUTLET_LM,OLSZ.OUTLET_LM,OLSSM.OUTLET_LM)	OUTLET_LM,
	COALESCE(OLBR.OUTLET_CM,OLSZ.OUTLET_CM,OLSSM.OUTLET_CM)	OUTLET_CM 
	
	INTO #RESULTX		FROM 
		(
select     MCAT,IIF(@SUMMARY=1 ,BRAND_MANUAL,'')BRAND_MANUAL,IIF(@SUMMARY=2 ,SIZE_MANUAL,'')SIZE_MANUAL, IIF(@SUMMARY  =3 ,SALESMAN,'')SALESMAN,
		--START OF ECO_LY
		COUNT( DISTINCT CASE 
        WHEN 
			(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
		 WHEN 
		(@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
	   THEN PARAC  
		WHEN 
		(@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2)) 
	   THEN PARAC  
 
	 
      ELSE NULL
    END) AS ECO_LY --END OF ECO_LY
	,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC
		 
            ELSE NULL --FOR QTD AND YTD
    END) AS ECO_LM,
	COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2 ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
	   THEN PARAC 
		 WHEN 
			(@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN     @DATE1  AND   @date2 )
	   THEN PARAC  
 
	 
      ELSE NULL
            
    END) AS ECO_CM

	 
	from(

SELECT * FROM #MAIN2
 

 )A   GROUP BY MCAT,IIF(@SUMMARY=1 ,A.BRAND_MANUAL,''),
	 IIF(@SUMMARY=2 ,SIZE_MANUAL,''),
	 IIF(@SUMMARY=3 ,SALESMAN,'') 

	 )EC
	 
LEFT join
 (
 SELECT BRAND_MANUAL  , 
 COUNT( DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN 
	  ( DATEADD(qq, DATEDIFF(qq, 0, DATEADD(yy, -1, @DATE2)), 0)) AND 
	  (DATEADD(yy, -1, @DATE2)) )

   THEN PARAC  
  
  ELSE NULL
    END) AS OUTLET_LY,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC  
            ELSE NULL --FOR QTD AND YTD
    END) AS OUTLET_LM,
		COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN PARAC  
 
	 
      ELSE NULL

    END) AS OUTLET_CM

 FROM #MAIN2  group by BRAND_MANUAL   ) OLBR
 on
 OLBR.BRAND_MANUAL=ec.BRAND_MANUAL AND @SUMMARY=1
 
 LEFT join
 (
 SELECT SIZE_MANUAL , 
 COUNT( DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @date2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN 
	  ( DATEADD(qq, DATEDIFF(qq, 0, DATEADD(yy, -1, @DATE2)), 0)) AND 
	  (DATEADD(yy, -1, @DATE2)) )

   THEN PARAC  
  
  ELSE NULL
    END) AS OUTLET_LY,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC  
            ELSE NULL --FOR QTD AND YTD
    END) AS OUTLET_LM,
		COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2 ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN PARAC  
 
	 
      ELSE NULL

    END) AS OUTLET_CM

 FROM #MAIN2  group by SIZE_MANUAL   ) OLSZ
 on
 OLSZ.SIZE_MANUAL=ec.SIZE_MANUAL AND @SUMMARY=2

 LEFT join
 (
 SELECT SALESMAN  ,
 COUNT( DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN PARAC  

		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2 ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN 
	  ( DATEADD(qq, DATEDIFF(qq, 0, DATEADD(yy, -1, @DATE2)), 0)) AND 
	  (DATEADD(yy, -1, @DATE2)) )

   THEN PARAC  
  
  ELSE NULL
    END) AS OUTLET_LY,
	
	COUNT(DISTINCT CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN PARAC  
            ELSE NULL --FOR QTD AND YTD
    END) AS OUTLET_LM,
		COUNT(DISTINCT CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN PARAC 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2 ) 
		THEN PARAC 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN PARAC  
 
	 
      ELSE NULL

    END) AS OUTLET_CM

 FROM #MAIN2  group by SALESMAN) OLSSM
 on
 OLSSM.SALESMAN=ec.SALESMAN AND @SUMMARY=3
 
  
  ---ADDING ECO 
  
 SELECT    BRAND_MANUAL ,  SIZE_MANUAL,SALESMAN, MCAT DIVISIONS  ,	ECO_LY	,ECO_LM	,ECO_CM	  ,	OUTLET_LY,	OUTLET_LM,	OUTLET_CM  ,CASE WHEN OUTLET_LY=0 THEN 0 ELSE (CAST (ECO_LY AS float)*100)  /OUTLET_LY  END [ECO%LY],
		  	CASE WHEN OUTLET_LM=0 THEN 0 ELSE (CAST (ECO_LM AS float)/OUTLET_LM) *100  END [ECO%LM], 	CASE WHEN OUTLET_CM=0 THEN 0 ELSE (CAST (ECO_CM AS float) /OUTLET_CM)*100    END [ECO%CM]
		  INTO
		  #RESULT2X FROM #RESULTX A 

		    


		   --RESULT QUERY

		    SELECT   BRAND_MANUAL	,SIZE_MANUAL, 	SALESMAN,	 DIVISIONS,ECO_LY	,ECO_LM,	ECO_CM,	OUTLET_LY,	OUTLET_LM	,OUTLET_CM	,[ECO%LY] 	,[ECO%LM],	[ECO%CM],	FLG,	FFLG  FROM (
 SELECT   BRAND_MANUAL,  	SIZE_MANUAL,SALESMAN,   DIVISIONS,
	 
		 ECO_LY	,
		 ECO_LM	,
		 ECO_CM, 
		 OUTLET_LY,	
		 OUTLET_LM,
		 OUTLET_CM	,
		 format([ECO%LY],'n2') [ECO%LY],
		 format([ECO%LM],'n2') [ECO%LM],
		 format([ECO%CM],'n2')[ECO%CM],
		 'A'FLG ,'R'FFLG
 FROM #RESULT2X 
 union all

 SELECT   'Total' BRAND_MANUAL, NULL SIZE_MANUAL, NULL SALESMAN,      DIVISIONS,
	 
		 SUM	(ECO_LY) ECO_LY	,
		 SUM(ECO_LM) ECO_LM	,
		 SUM(ECO_CM) ECO_CM ,
		 NULL OUTLET_LY ,
		 NULL OUTLET_LM,
		 NULL OUTLET_CM,
		 NULL [ECO%LY],
		 NULL [ECO%LM],
		 NULL [ECO%CM],
		 'B'FLG ,'B'FFLG
 FROM #RESULT2X  GROUP BY divisions 
 )SUUM
  ORDER BY DIVISIONS, FLG,CASE @SUMMARY WHEN 1 THEN BRAND_MANUAL WHEN 2 THEN SIZE_MANUAL  WHEN 3 THEN SALESMAN END    

  SELECT NULL
END
 
 