 

  CREATE OR ALTER   PROC [dbo].[DAB_SKU_REPORT]
 --DECLARE

@DATE1 DATETIME,
@DATE2 DATETIME ,
@MCODE VARCHAR(MAX)='%',
@MCAT VARCHAR(MAX)='%',
@REPORTTYPE VARCHAR(100)='MTD',
@SALESMANID VARCHAR(MAX)='%',--SALESMANID
@STOCKIESTNAME VARCHAR(MAX)='%',--COMPANYID
@BEAT VARCHAR(MAX)='%',--ROUTECODE
@BRAND VARCHAR(MAX)='%',--
@SUMMARY TINYINT =0,--0 DETAIL,1 SUMMARY BRAND,2 SUMMARY SIZE,3 salesman
@REPMODE TINYINT= 1 ,--BEAT  0 , SALESMANWISE 1 ,STOCKIEST 2
@REPCRITERIA VARCHAR(MAX)   output  ,
@REPORTNAME VARCHAR(100)   output

AS


--SELECT @date1='2023-03-01' ,@date2 ='2023-04-05',@REPMODE=1,@SUMMARY=3

 IF (@SUMMARY=0)
 BEGIN

SET @REPCRITERIA = '@As On Dated : ' + FORMAT(@DATE2, 'MM-dd-yyyy')   

	IF OBJECT_ID('tempdb..#DATA') is not null drop table #DATA
	IF OBJECT_ID('TEMPDB..#MAIN') is not null drop table #MAIN
	IF OBJECT_ID('TEMPDB..#SUMDATA') is not null drop table #SUMDATA
	IF @REPORTTYPE ='MTD'
	SET @REPORTNAME = 'SKU-REPORT-MTD';
	IF @REPORTTYPE ='YTD'
	SET @REPORTNAME = 'SKU-REPORT-YTD';
	IF @REPORTTYPE ='QTD'
	SET @REPORTNAME = 'SKU-REPORT-QTD';
	IF @REPORTTYPE ='CUS'
	SET @REPORTNAME = 'SKU-REPORT-CUSTOM';
 


	SELECT A.TRNDATE, ISNULL(G.RouteName,'N/A') [BEAT_NAME],ISNULL(F.NAME,'N/A') SALESMAN,C.ACNAME STOCKIESTNAME ,B.*  INTO #MAIN FROM TRNPROD B WITH (NOLOCK) JOIN (SELECT DISTINCT SALESMANID,COMPANYID,BILLTO,RouteCode,VCHRNO,TRNDATE,vouchertype FROM TRNMAIN WITH (NOLOCK))A ON A.VCHRNO= B.VCHRNO AND B.VOUCHERTYPE='TI' LEFT JOIN 
		ROUTE_MASTER G WITH (NOLOCK) ON A.ROUTECODE=G.ROUTECODE
		JOIN (SELECT DISTINCT MCODE,CATEGORYCODE,DESCA,MCAT,BRAND_MANUAL,SIZE_MANUAL FROM MENUITEM) MI ON MI.MCODE=B.MCODE
		LEFT JOIN SALESMAN F WITH (NOLOCK) ON A.SALESMANID=F.SSMCODE 
		LEFT JOIN RMD_ACLIST C WITH (NOLOCK) ON A.COMPANYID =C.customerID
		WHERE 
		NOT a.vouchertype IN ( 'CN','RE') AND
		A.VCHRNO NOT IN (SELECT REFBILL FROM TRNMAIN WHERE VoucherType   IN ( 'CN','RE')) and
		(@MCODE = '%' OR ( @MCODE <> '%' AND B.MCODE IN (SELECT * FROM DBO.SPLIT(@MCODE,',')))) 
		AND(@MCAT = '%' OR ( @MCAT <> '%' AND MI.MCAT IN (SELECT * FROM DBO.SPLIT(@MCAT,',')))) 
		AND(@SALESMANID = '%' OR (@SALESMANID <> '%' AND A.SALESMANID  IN (SELECT * FROM DBO.SPLIT(@SALESMANID,',')))) 
		AND(@BEAT = '%' OR ( @BEAT <> '%' AND A.RouteCode  IN (SELECT * FROM DBO.SPLIT(@BEAT,','))))
		AND(@STOCKIESTNAME = '%' OR ( @STOCKIESTNAME <> '%' AND A.COMPANYID  IN (SELECT * FROM DBO.SPLIT(@STOCKIESTNAME,','))))
	 

--SELECT * FROM #MAIN

 
	select MCODE, IIF(@REPMODE=0 ,BEAT_NAME,'')BEAT_NAME,IIF(@REPMODE<=1 ,SALESMAN,'')SALESMAN, IIF(@REPMODE <=2 ,STOCKIESTNAME,'')STOCKIESTNAME,
		--START OF LY_VOL
		SUM(CASE 
				WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1 
				AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
				THEN RealQty  

				 WHEN (@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=DATEADD(year, -1, @date2)  ) 
				THEN RealQty
	
				 WHEN  (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND DATEADD(year, -1, @DATE2)) 
				 THEN RealQty
				  WHEN  (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2)) 
				 THEN RealQty
			ELSE 0 
		END)
	AS LY_VOL 
	--END OF LY_VOL
	,	convert(numeric(32,2),SUM(  
	CASE  
		WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN 
			AMOUNT  

		 WHEN (@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		 THEN 
			AMOUNT
	
		 WHEN  (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
		 THEN 
			AMOUNT  

		 WHEN  (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2)) 
		 THEN 
			AMOUNT
        ELSE 0 
    END)) AS LY_VALUE
	,SUM(CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN RealQty  
        ELSE 0 --FOR QTD AND YTD AND CUS
    END) AS LM_VOL
	,convert(numeric(32,2),SUM(CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN AMOUNT  
        ELSE 0 --FOR QTD AND YTD AND CUS
    END)) AS LM_VALUE
	,SUM(CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN RealQty 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN RealQty 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN RealQty 
     	 WHEN 
      (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   @DATE1 AND @DATE2) 
   THEN RealQty    
        ELSE 0 
    END) AS CM_VOL
	,convert(numeric(32,2),SUM( CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN AMOUNT 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN AMOUNT 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN AMOUNT   
   	 WHEN 
      (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   @DATE1 AND @DATE2) 
   THEN AMOUNT    
        ELSE 0 
    END)) AS CM_VALUE
	INTO #DATA
	from(

 SELECT * FROM #MAIN
 )A group by mcode , 
	 IIF(@REPMODE=0 ,BEAT_NAME,''),
	 IIF(@REPMODE<=1 ,SALESMAN,''),
	 IIF(@REPMODE <=2 ,STOCKIESTNAME,'') 



 SELECT A.MCODE AS MATERIALCODE,BEAT_NAME,SALESMAN,STOCKIESTNAME,B.DESCA AS MATERIALNAME,B.BRAND_MANUAL,B.SIZE_MANUAL,B.MCAT AS DIVISION,	LY_VOL	,LY_VALUE	,LM_VOL	,LM_VALUE	,CM_VOL,	CM_VALUE,
 

 CASE WHEN LY_VOL=0 THEN 0 ELSE CAST ((CM_VOL-LY_VOL)/LY_VOL AS numeric(32,12))*100   END GOLY_VOL,
 
 CASE WHEN LY_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LY_VALUE)/LY_VALUE AS numeric(32,12))*100  END GOLY_VALUE,
 
 CASE WHEN LM_VOL=0 THEN 0 ELSE CAST((CM_VOL-LM_VOL)/LM_VOL AS numeric(32,12))*100  END GOLM_VOL,
 
 CASE WHEN LM_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LM_VALUE)/LM_VALUE AS numeric(32,12))*100  END GOLM_VALUE  


 INTO #SUMDATA
 FROM #DATA A JOIN MENUITEM B ON A.MCODE=B.MCODE
 WHERE BRAND_MANUAL LIKE @BRAND

 SELECT  MATERIALCODE	,BEAT_NAME,	SALESMAN	,STOCKIESTNAME,	MATERIALNAME,	NULLIF(BRAND_MANUAL,	'ZZZZZZZZZZ') BRAND_MANUAL,NULLIF (SIZE_MANUAL,'ZZZZZZZZZZ')	SIZE_MANUAL,DIVISION	,LY_VOL	,LY_VALUE,	LM_VOL,	LM_VALUE	,CM_VOL	,CM_VALUE,	GOLY_VOL,	GOLY_VALUE	GOLM_VOL	,GOLM_VALUE,	FLG,	FFLG FROM 
 (
 SELECT *,'A'FLG ,'R'FFLG  FROM #SUMDATA 


 UNION ALL

 SELECT  'TOTAL' MATERIALCODE,	IIF(@REPMODE=0,BEAT_NAME,NULL)BEAT,IIF(@REPMODE=1,SALESMAN,NULL)SALESMAN,IIF(@REPMODE=2,STOCKIESTNAME,NULL)STOCKEISTNAME,	NULL  MATERIALNAME,	
 'ZZZZZZZZZZ'  BRAND_MANUAL,'ZZZZZZZZZZ' SIZE_MANUAL,NULL DIVISION,
 SUM(LY_VOL)LY_VOL, SUM(LY_VALUE)LY_VALUE,SUM(LM_VOL)LM_VOL
 ,
 SUM(LM_VALUE)LM_VALUE,
 SUM(CM_VOL)CM_VOL,
 SUM(CM_VALUE)CM_VALUE,
 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 
 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 
 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 
 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE ,
 'C'FLG,'B'FFLG
FROM #SUMDATA

 GROUP BY IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL)

 UNION ALL
 SELECT 
 NULL,	IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL)	,	NULL MATERIALNAME,	 	BRAND_MANUAL,	  	SIZE_MANUAL	,	NULL DIVISION	,
	 SUM(LY_VOL)LY_VOL, 
	 SUM(LY_VALUE)LY_VALUE,
	 SUM(LM_VOL)LM_VOL,
	 SUM(LM_VALUE)LM_VALUE,
	 SUM(CM_VOL)CM_VOL,
	 SUM(CM_VALUE)CM_VALUE,
	 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 
	 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 
	 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 
	 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE ,
	
	'B' FLG	,	'B' FFLG --for brand and size total


 FROM #SUMDATA group by BRAND_MANUAL ,SIZE_MANUAL
 ,IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL)


 ) SUUM

 ORDER BY    CASE @REPMODE WHEN 0 THEN BEAT_NAME WHEN 1 THEN SALESMAN  WHEN 2 THEN STOCKIESTNAME END  , SUUM. BRAND_MANUAL  ,   SUUM.SIZE_MANUAL ,FLG
SELECT NULL
  
	  

 END


 ELSE


 BEGIN
 SET @REPCRITERIA = '@As On Dated : ' + FORMAT(@DATE2, 'MM-dd-yyyy')  

	IF OBJECT_ID('tempdb..#DATA2') is not null drop table #DATA2
	IF OBJECT_ID('TEMPDB..#MAIN2') is not null drop table #MAIN2
	IF OBJECT_ID('TEMPDB..#SUMDATA2') is not null drop table #SUMDATA2
	IF @REPORTTYPE ='MTD'
	SET @REPORTNAME = 'SKU-REPORT-MTD SUMMARY';
	IF @REPORTTYPE ='YTD'
	SET @REPORTNAME = 'SKU-REPORT-YTD SUMMARY';
	IF @REPORTTYPE ='QTD'
	SET @REPORTNAME = 'SKU-REPORT-QTD SUMMARY';
	IF @REPORTTYPE ='CUS'
	SET @REPORTNAME = 'SKU-REPORT-CUSTOM SUMMARY';



	
	SELECT A.TRNDATE, ISNULL(G.RouteName,'N/A') [BEAT_NAME],ISNULL(F.NAME,'N/A') SALESMAN,C.ACNAME STOCKIESTNAME ,BRAND_MANUAL,SIZE_MANUAL,MI.MCAT DIVISIONS  ,B.*  INTO #MAIN2 FROM TRNPROD B WITH (NOLOCK) JOIN (SELECT DISTINCT SALESMANID,COMPANYID,BILLTO,RouteCode,VCHRNO,TRNDATE FROM TRNMAIN WITH (NOLOCK))A ON A.VCHRNO= B.VCHRNO AND B.VOUCHERTYPE='TI' LEFT JOIN 
		ROUTE_MASTER G WITH (NOLOCK) ON A.ROUTECODE=G.ROUTECODE
		JOIN (SELECT DISTINCT MCODE,CATEGORYCODE,DESCA,MCAT,BRAND_MANUAL,SIZE_MANUAL FROM MENUITEM) MI ON MI.MCODE=B.MCODE
		LEFT JOIN SALESMAN F WITH (NOLOCK) ON A.SALESMANID=F.SSMCODE 
		LEFT JOIN RMD_ACLIST C WITH (NOLOCK) ON A.COMPANYID =C.customerID
		WHERE 
		(@MCODE = '%' OR ( @MCODE <> '%' AND B.MCODE IN (SELECT * FROM DBO.SPLIT(@MCODE,',')))) 
		AND(@MCAT = '%' OR ( @MCAT <> '%' AND MI.MCAT IN (SELECT * FROM DBO.SPLIT(@MCAT,',')))) 
		AND(@SALESMANID = '%' OR (@SALESMANID <> '%' AND A.SALESMANID  IN (SELECT * FROM DBO.SPLIT(@SALESMANID,',')))) 
		AND(@BEAT = '%' OR ( @BEAT <> '%' AND A.RouteCode  IN (SELECT * FROM DBO.SPLIT(@BEAT,','))))
		AND(@STOCKIESTNAME = '%' OR ( @STOCKIESTNAME <> '%' AND A.COMPANYID  IN (SELECT * FROM DBO.SPLIT(@STOCKIESTNAME,','))))


		 
 
		
	select   IIF(@SUMMARY=1 ,A.BRAND_MANUAL,'')BRAND_MANUAL,
	IIF(@SUMMARY =2 ,SIZE_MANUAL,'')SIZE_MANUAL,
	IIF(@SUMMARY  =3 ,SALESMAN,'')SALESMAN,
	 DIVISIONS ,
		--START OF LY_VOL
		SUM(CASE 
				WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1 
				AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
				THEN RealQty  

				 WHEN (@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=DATEADD(year, -1, @date2)  ) 
				THEN RealQty
	
				 WHEN  (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND DATEADD(year, -1, @DATE2)) 
				 THEN RealQty
				  WHEN  (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2)) 
				 THEN RealQty
			ELSE 0 
		END)
	AS LY_VOL 
	--END OF LY_VOL
	,	convert(numeric(32,2),SUM(  
	CASE  
		WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN 
			AMOUNT  

		 WHEN (@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)-1  AND TRNDATE<=@DATE2  ) 
		 THEN 
			AMOUNT
	
		 WHEN  (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
		 THEN 
			AMOUNT  

		 WHEN  (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2)) 
		 THEN 
			AMOUNT
        ELSE 0 
    END)) AS LY_VALUE
	,SUM(CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN RealQty  
        ELSE 0 --FOR QTD AND YTD AND CUS
    END) AS LM_VOL
	,convert(numeric(32,2),SUM(CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE2))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE2)) AND TRNDATE<=@DATE2)
		THEN AMOUNT  
        ELSE 0 --FOR QTD AND YTD AND CUS
    END)) AS LM_VALUE
	,SUM(CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN RealQty 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN RealQty 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN RealQty 
     	 WHEN 
      (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   @DATE1 AND @DATE2) 
   THEN RealQty    
        ELSE 0 
    END) AS CM_VOL
	,convert(numeric(32,2),SUM( CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE2) AND TRNDATE <=  @DATE2  ) 
		THEN AMOUNT 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE2)   AND TRNDATE<=@DATE2  ) 
		THEN AMOUNT 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE2), 0)) AND @DATE2) 
   THEN AMOUNT   
   	 WHEN 
      (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   @DATE1 AND @DATE2) 
   THEN AMOUNT    
        ELSE 0 
    END)) AS CM_VALUE
	INTO #DATA2
	from(

 SELECT * FROM #MAIN2
 )A group by   
	 IIF(@SUMMARY=1 ,A.BRAND_MANUAL,''),
	 IIF(@SUMMARY =2 ,SIZE_MANUAL,''),
	 IIF(@SUMMARY  =3 ,SALESMAN,'') ,
	   DIVISIONS
  


 

 SELECT   BRAND_MANUAL,SIZE_MANUAL,SALESMAN ,  DIVISIONS,	LY_VOL	,LY_VALUE	,LM_VOL	,LM_VALUE	,CM_VOL,	CM_VALUE,
 

 CASE WHEN LY_VOL=0 THEN 0 ELSE CAST ((CM_VOL-LY_VOL)/LY_VOL AS numeric(32,12))*100   END GOLY_VOL,
 
 CASE WHEN LY_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LY_VALUE)/LY_VALUE AS numeric(32,12))*100  END GOLY_VALUE,
 
 CASE WHEN LM_VOL=0 THEN 0 ELSE CAST((CM_VOL-LM_VOL)/LM_VOL AS numeric(32,12))*100  END GOLM_VOL,
 
 CASE WHEN LM_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LM_VALUE)/LM_VALUE AS numeric(32,12))*100  END GOLM_VALUE  


 INTO #SUMDATA2
 FROM #DATA2 A  


 ---RESULT QUERY
 SELECT  BRAND_MANUAL,SIZE_MANUAL,SALESMAN ,DIVISIONS, LY_VOL	,LY_VALUE,	LM_VOL,	LM_VALUE	,CM_VOL	,CM_VALUE,	GOLY_VOL,	GOLY_VALUE	GOLM_VOL	,GOLM_VALUE,	FLG,	FFLG FROM 
 (
 SELECT *,'A'FLG ,'R'FFLG  FROM #SUMDATA2


 UNION ALL

  SELECT 
 'TOTAL' BRAND_MANUAL,	NULL SIZE_MANUAL ,NULL SALESMAN ,DIVISIONS	,	  
	 SUM(LY_VOL)LY_VOL, 
	 SUM(LY_VALUE)LY_VALUE,
	 SUM(LM_VOL)LM_VOL,
	 SUM(LM_VALUE)LM_VALUE,
	 SUM(CM_VOL)CM_VOL,
	 SUM(CM_VALUE)CM_VALUE,
	 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 
	 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 
	 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 
	 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE ,
	
	'B' FLG	,	'B' FFLG --for brand and size total


 FROM #SUMDATA2 group by DIVISIONS

 ) SUUM

 ORDER BY    DIVISIONS  ,FLG
SELECT NULL
 
 END