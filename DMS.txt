 
CREATE OR ALTER   PROC [dbo].[DAB_SKU_REPORT]
 --DECLARE

@date DATETIME,
@date2 DATETIME = '1900-01-01',
@MCODE VARCHAR(MAX)='%',
@MCAT VARCHAR(MAX)='%',
@REPORTTYPE VARCHAR(100)='MTD',
@SALESMANID VARCHAR(MAX)='%',--SALESMANID
@STOCKIESTNAME VARCHAR(MAX)='%',--COMPANYID
@BEAT VARCHAR(MAX)='%',--ROUTECODE
@BRAND VARCHAR(MAX)='%',--
@REPCRITERIA VARCHAR(MAX)     output  ,
@REPORTNAME VARCHAR(100)   output

AS

--SELECT @date='2023-03-01' ,@date2 ='2023-04-05'

 
SET @REPCRITERIA = '@As On Dated : ' + FORMAT(@DATE, 'MM-dd-yyyy')   

	IF OBJECT_ID('tempdb..#DATA') is not null drop table #DATA
	IF OBJECT_ID('TEMPDB..#MAIN') is not null drop table #MAIN
	IF OBJECT_ID('TEMPDB..#SUMDATA') is not null drop table #SUMDATA
	IF @REPORTTYPE ='MTD'
	SET @REPORTNAME = 'SKU-REPORT-MTD';
	IF @REPORTTYPE ='YTD'
	SET @REPORTNAME = 'SKU-REPORT-YTD';
	IF @REPORTTYPE ='QTD'
	SET @REPORTNAME = 'SKU-REPORT-QTD';
	IF @REPORTTYPE ='CUS'
	SET @REPORTNAME = 'SKU-REPORT-CUSTOM';
 


	SELECT A.TRNDATE,G.RouteName [BEAT_NAME],F.NAME SALESMAN,C.ACNAME STOCKIESTNAME ,B.*  INTO #MAIN FROM TRNPROD B WITH (NOLOCK) JOIN (SELECT DISTINCT SALESMANID,COMPANYID,BILLTO,RouteCode,VCHRNO,TRNDATE FROM TRNMAIN WITH (NOLOCK))A ON A.VCHRNO= B.VCHRNO AND B.VOUCHERTYPE='TI' LEFT JOIN 
		ROUTE_MASTER G WITH (NOLOCK) ON A.ROUTECODE=G.ROUTECODE
		LEFT JOIN SALESMAN F WITH (NOLOCK) ON A.SALESMANID=F.SSMCODE 
		LEFT JOIN RMD_ACLIST C WITH (NOLOCK) ON A.COMPANYID =C.customerID
		WHERE MCODE LIKE @MCODE 
		AND DIVISION LIKE @MCAT 
		AND A.SALESMANID LIKE @SALESMANID 
		AND A.RouteCode LIKE @BEAT
		AND A.COMPANYID LIKE @STOCKIESTNAME
	 

--SELECT * FROM #MAIN

 
	select MCODE,BEAT_NAME,SALESMAN,STOCKIESTNAME,
		--START OF LY_VOL
		SUM(CASE 
				WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1 
				AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
				THEN RealQty  

				 WHEN (@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1  AND TRNDATE<=DATEADD(year, -1, @date)  ) 
				THEN RealQty
	
				 WHEN  (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE), 0)) AND DATEADD(year, -1, @date)) 
				 THEN RealQty
				  WHEN  (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @date) AND DATEADD(year, -1, @date2)) 
				 THEN RealQty
			ELSE 0 
		END)
	AS LY_VOL 
	--END OF LY_VOL
	,	convert(numeric(32,2),SUM(  
	CASE  
		WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
		THEN 
			AMOUNT  

		 WHEN (@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)-1  AND TRNDATE<=@DATE  ) 
		 THEN 
			AMOUNT
	
		 WHEN  (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE), 0)) AND @DATE) 
		 THEN 
			AMOUNT  

		 WHEN  (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   DATEADD(year, -1, @date) AND DATEADD(year, -1, @date2)) 
		 THEN 
			AMOUNT
        ELSE 0 
    END)) AS LY_VALUE
	,SUM(CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE)) AND TRNDATE<=@DATE)
		THEN RealQty  
        ELSE 0 --FOR QTD AND YTD AND CUS
    END) AS LM_VOL
	,convert(numeric(32,2),SUM(CASE 
        WHEN (@REPORTTYPE='MTD' AND DATEPART(YEAR,TRNDATE) =DATEPART(YEAR,DATEADD (MM,-1,  @DATE))  AND DATEPART(MONTH,TRNDATE)=DATEPART(MONTH,DATEADD (MM,-1,  @DATE)) AND TRNDATE<=@DATE)
		THEN AMOUNT  
        ELSE 0 --FOR QTD AND YTD AND CUS
    END)) AS LM_VALUE
	,SUM(CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
		THEN RealQty 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)   AND TRNDATE<=@DATE  ) 
		THEN RealQty 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE), 0)) AND @DATE) 
   THEN RealQty 
     	 WHEN 
      (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   @date AND @date2) 
   THEN RealQty    
        ELSE 0 
    END) AS CM_VOL
	,convert(numeric(32,2),SUM( CASE 
        WHEN(@REPORTTYPE='MTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)  AND DATEPART(MONTH, TRNDATE) = DATEPART(MONTH, @DATE) AND TRNDATE <=  @date  ) 
		THEN AMOUNT 
		
		
		WHEN 
			(@REPORTTYPE='YTD' AND DATEPART(YEAR, TRNDATE) = DATEPART(YEAR, @DATE)   AND TRNDATE<=@DATE  ) 
		THEN AMOUNT 
		
	 WHEN 
      (@REPORTTYPE = 'QTD' AND TRNDATE BETWEEN  (  DATEADD(qq, DATEDIFF(qq, 0, @DATE), 0)) AND @DATE) 
   THEN AMOUNT   
   	 WHEN 
      (@REPORTTYPE = 'CUS' AND TRNDATE BETWEEN   @date AND @date2) 
   THEN AMOUNT    
        ELSE 0 
    END)) AS CM_VALUE
	INTO #DATA
	from(

 SELECT * FROM #MAIN
 )A group by mcode,BEAT_NAME,SALESMAN,STOCKIESTNAME



 SELECT A.MCODE AS MATERIALCODE,BEAT_NAME,SALESMAN,STOCKIESTNAME,B.DESCA AS MATERIALNAME,B.BRAND_MANUAL,B.SIZE_MANUAL,B.MCAT AS DIVISION,	LY_VOL	,LY_VALUE	,LM_VOL	,LM_VALUE	,CM_VOL,	CM_VALUE,
 

 CASE WHEN LY_VOL=0 THEN 0 ELSE CAST ((CM_VOL-LY_VOL)/LY_VOL AS numeric(32,12))*100   END GOLY_VOL,
 
 CASE WHEN LY_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LY_VALUE)/LY_VALUE AS numeric(32,12))*100  END GOLY_VALUE,
 
 CASE WHEN LM_VOL=0 THEN 0 ELSE CAST((CM_VOL-LM_VOL)/LM_VOL AS numeric(32,12))*100  END GOLM_VOL,
 
 CASE WHEN LM_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LM_VALUE)/LM_VALUE AS numeric(32,12))*100  END GOLM_VALUE 

 INTO #SUMDATA
 FROM #DATA A JOIN MENUITEM B ON A.MCODE=B.MCODE
 WHERE BRAND_MANUAL LIKE @BRAND

 SELECT * FROM #SUMDATA 


 

 SELECT  NULL MATERIALCODE	,NULL BEAT_NAME	,NULL SALESMAN	,NULL STOCKIESTNAME,	NULL  MATERIALNAME,	NULL  BRAND_MANUAL,NULL  SIZE_MANUAL,NULL DIVISION,
 SUM(LY_VOL)LY_VOL, SUM(LY_VALUE)LY_VALUE,SUM(LM_VOL)LM_VOL
 ,SUM(LM_VALUE)LM_VALUE,SUM(CM_VOL)CM_VOL,SUM(CM_VALUE)CM_VALUE,SUM(GOLY_VOL)GOLY_VOL,SUM(GOLY_VALUE)GOLY_VALUE,SUM(GOLM_VOL)GOLM_VOL,SUM(GOLM_VALUE) GOLM_VALUE FROM #SUMDATA
  
  	 
	  
 