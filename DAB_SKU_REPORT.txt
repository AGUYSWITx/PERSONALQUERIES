 
ALTER           PROC [dbo].[DAB_SKU_REPORT]
--DECLARE
@DATE1 DATETIME,
@DATE2 DATETIME ,
@MCODE VARCHAR(MAX)='%',
@MCAT VARCHAR(MAX)='%',
@REPORTTYPE VARCHAR(100)='MTD',
@SALESMANID VARCHAR(MAX)='%',--SALESMANID
@STOCKIESTNAME VARCHAR(MAX)='%',--COMPANYID
@BEAT VARCHAR(MAX)='%',--ROUTECODE
@BRAND VARCHAR(MAX)='%',--
@SUMMARY TINYINT =0,--0 DETAIL,1 SUMMARY BRAND,2 SUMMARY SIZE,3 salesman
@REPMODE TINYINT= 1,  --BEAT  0 , SALESMANWISE 1 ,STOCKIEST 2
@BRAND_CHECK TINYINT = 0,
@SIZE_CHECK TINYINT = 0
 ,@REPCRITERIA VARCHAR(MAX)     output  ,
 @REPORTNAME VARCHAR(100)     output

AS

--select @DATE1='2023-05-01',@DATE2='2023-06-30',@REPMODE=2,@SALESMANID='%',@STOCKIESTNAME='%',@MCODE='%',@SUMMARY=3,@REPORTTYPE='MTD'
IF(@REPORTTYPE <> 'CUS')
	SET @DATE1 = (SELECT dbo.fn_GetStartDate(@DATE2,@REPORTTYPE))

SET @REPCRITERIA = '@Daterange from : ' +FORMAT(@DATE1, 'MM-dd-yyyy') + ' To ' + FORMAT(@DATE2, 'MM-dd-yyyy')   + '  @Mode : ' + iif(@SUMMARY in (0,4),case @repmode when 0 then ' Beat wise -' when 1 then ' Salesman Wise -' when 2 then ' Stockist Wise -' end + iif(@summary=4 , ' Summary','Detail'),case @summary when 1 then 'DNPL Summary - Brand Wise' when 2 then 'DNPL Summary - Size Wise' when 3 then 'DNPL Summary - Salesman WIse' end)
	IF @REPORTTYPE ='MTD'
	SET @REPORTNAME = 'SKU-REPORT-MTD';
	IF @REPORTTYPE ='YTD'
	SET @REPORTNAME = 'SKU-REPORT-YTD';
	IF @REPORTTYPE ='QTD'
	SET @REPORTNAME = 'SKU-REPORT-QTD';
	IF @REPORTTYPE ='CUS'
	SET @REPORTNAME = 'SKU-REPORT-CUSTOM'; 
IF OBJECT_ID('TEMPDB..#MAIN') is not null drop table #MAIN
IF OBJECT_ID('TEMPDB..#VCHR') is not null drop table #VCHR
	CREATE TABLE #VCHR (VNO VARCHAR(30))

INSERT INTO #VCHR
	SELECT VCHRNO FROM TRNMAIN A WITH (NOLOCK) 
	WHERE
	A.VoucherType = 'TI'
	AND	(@STOCKIESTNAME = '%' OR ( @STOCKIESTNAME <> '%' AND A.COMPANYID  IN (SELECT * FROM DBO.SPLIT(@STOCKIESTNAME,','))))
	AND	(@SALESMANID = '%' OR (@SALESMANID <> '%' AND A.SALESMANID  IN (SELECT * FROM DBO.SPLIT(@SALESMANID,','))))
	AND	(@BEAT = '%' OR ( @BEAT <> '%' AND A.RouteCode  IN (SELECT * FROM DBO.SPLIT(@BEAT,','))))
	EXCEPT
	SELECT DISTINCT ISNULL(REFBILL,'') FROM TRNMAIN WITH (NOLOCK)
	WHERE VOUCHERTYPE ='RE'

	SELECT A.TRNDATE, ISNULL(G.RouteName,'N/A') [BEAT_NAME],ISNULL(F.NAME,'N/A') SALESMAN,C.ACNAME STOCKIESTNAME ,BRAND_MANUAL,SIZE_MANUAL,MI.MCAT DIVISIONS 
	,CASE WHEN E.CONFACTOR=0 THEN  
	IIF(A.VOUCHERTYPE= 'CN',b.REALQTY* -1,B.REALQTY) ELSE (cast ( IIF(A.VOUCHERTYPE= 'CN',b.REALQTY* -1,B.REALQTY)as float)/ E.CONFACTOR) END REALQTY
	,IIF(A.VOUCHERTYPE='CN',(B.TAXABLE+B.NONTAXABLE)*-1, (B.TAXABLE+B.NONTAXABLE))AMOUNT ,b.MCODE,MI.DESCA,MI.MCAT
	INTO #MAIN 
	FROM #VCHR X 
	JOIN TRNPROD B WITH (NOLOCK) ON X.VNO = B.VCHRNO
	JOIN TRNMAIN A WITH (NOLOCK) ON X.VNO= A.VCHRNO  
	LEFT JOIN ROUTE_MASTER G WITH (NOLOCK) ON A.ROUTECODE=G.ROUTECODE
	JOIN (SELECT DISTINCT MCODE,CATEGORYCODE,DESCA,MCAT,BRAND_MANUAL,SIZE_MANUAL FROM MENUITEM) MI ON MI.MCODE=B.MCODE
	LEFT JOIN SALESMAN F WITH (NOLOCK) ON A.SALESMANID=F.SSMCODE 
	LEFT JOIN RMD_ACLIST C WITH (NOLOCK) ON A.COMPANYID = C.customerID
	LEFT JOIN MULTIALTUNIT E WITH(NOLOCK)		ON B.MCODE = E.MCODE AND UPPER(E.ALTUNIT) = 'CASE'
	WHERE 
	(@MCODE = '%' OR ( @MCODE <> '%' AND B.MCODE IN (SELECT * FROM DBO.SPLIT(@MCODE,',')))) 
	AND	(@MCAT = '%' OR ( @MCAT <> '%' AND MI.MCAT IN (SELECT * FROM DBO.SPLIT(@MCAT,','))))
	AND	(@BRAND = '%' OR (@BRAND <>'%' AND BRAND_MANUAL IN (SELECT * FROM DBO.SPLIT(@BRAND,','))))

 IF (@SUMMARY IN (0,4))
 BEGIN

	IF OBJECT_ID('tempdb..#DATA') is not null drop table #DATA
	IF OBJECT_ID('TEMPDB..#SUMDATA') is not null drop table #SUMDATA

	select MCODE,DESCA,iif(@SUMMARY=0 OR @BRAND_CHECK=1,BRAND_MANUAL,'') BRAND_MANUAL,IIF(@SUMMARY=0 OR @SIZE_CHECK=1,SIZE_MANUAL,'') SIZE_MANUAL,mcat, IIF(@REPMODE=0 ,BEAT_NAME,'')BEAT_NAME,IIF(@REPMODE<=1 ,SALESMAN,'')SALESMAN, IIF(@REPMODE <=2 ,STOCKIESTNAME,'')STOCKIESTNAME,
		SUM(IIF(TRNDATE BETWEEN  DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2),RealQty,0))	AS LY_VOL,
		SUM(IIF(TRNDATE BETWEEN  DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2),AMOUNT,0))		AS LY_VALUE,
		SUM(IIF(TRNDATE BETWEEN  DATEADD (MM,-1, @DATE1) AND DATEADD (MM,-1, @DATE2),RealQty,0))		AS LM_VOL,
		SUM(IIF(TRNDATE BETWEEN  DATEADD (MM,-1, @DATE1) AND DATEADD (MM,-1, @DATE2),AMOUNT,0))			AS LM_VALUE,
		SUM(IIF(TRNDATE BETWEEN @DATE1 AND @DATE2,RealQty,0))		AS CM_VOL,
		SUM(IIF(TRNDATE BETWEEN @DATE1 AND @DATE2,AMOUNT,0))		AS CM_VALUE
	INTO #DATA
	from #MAIN A group by mcode , DESCA,BRAND_MANUAL,SIZE_MANUAL,mcat,
	 IIF(@REPMODE=0 ,BEAT_NAME,''),
	 IIF(@REPMODE<=1 ,SALESMAN,''),
	 IIF(@REPMODE <=2 ,STOCKIESTNAME,'') 
	   
	    

 SELECT A.MCODE AS MATERIALCODE,BEAT_NAME,SALESMAN,STOCKIESTNAME,DESCA AS MATERIALNAME,BRAND_MANUAL,SIZE_MANUAL,MCAT AS DIVISION,	LY_VOL	,LY_VALUE	,LM_VOL	,LM_VALUE	,CM_VOL,	CM_VALUE,
 

 CASE WHEN LY_VOL=0 THEN 0 ELSE (CAST (CM_VOL-LY_VOL AS float)/LY_VOL )*100   END GOLY_VOL,
 
 CASE WHEN LY_VALUE=0 THEN 0 ELSE (CAST (CM_VALUE-LY_VALUE as FLOAT)/LY_VALUE  )*100  END GOLY_VALUE,
 
 CASE WHEN LM_VOL=0 THEN 0 ELSE (CAST(CM_VOL-LM_VOL as FLOAT)/LM_VOL  )*100  END GOLM_VOL,
 
 CASE WHEN LM_VALUE=0 THEN 0 ELSE (CAST (CM_VALUE-LM_VALUE as FLOAT)/LM_VALUE )*100  END GOLM_VALUE  


 INTO #SUMDATA
 FROM #DATA A 

 

 SELECT  MATERIALCODE	,BEAT_NAME,	SALESMAN	,STOCKIESTNAME,	MATERIALNAME,	BRAND_MANUAL,SIZE_MANUAL,DIVISION	, 
	 CONVERT(NUMERIC(32,2)	,LY_VOL)LY_VOL, 
	 CONVERT(NUMERIC(32,0),LY_VALUE)LY_VALUE,
	 CONVERT(NUMERIC(32,2),LM_VOL)LM_VOL,	
	 CONVERT(NUMERIC(32,0),LM_VALUE)	LM_VALUE,
	 CONVERT(NUMERIC(32,2),CM_VOL)CM_VOL,
	 CONVERT(NUMERIC(32,0),CM_VALUE)CM_VALUE,
	 CONVERT(NUMERIC(32,2),GOLY_VOL)GOLY_VOL,	
	 CONVERT(NUMERIC(32,0),GOLY_VALUE)GOLY_VALUE,
	 CONVERT(NUMERIC(32,2),GOLM_VOL)GOLM_VOL	,
	 CONVERT(NUMERIC(32,0),GOLM_VALUE)GOLM_VALUE,
 FLG,	FFLG FROM 
 (
 SELECT iif(@SUMMARY=4,'',MATERIALCODE) MATERIALCODE,BEAT_NAME,SALESMAN,STOCKIESTNAME,BEAT_NAME xbeat_name,SALESMAN xsalesman,STOCKIESTNAME xSTOCKIESTNAME,iif(@SUMMARY=4,'',MATERIALNAME) MATERIALNAME,BRAND_MANUAL,SIZE_MANUAL,BRAND_MANUAL xBRAND_MANUAL,SIZE_MANUAL xSIZE_MANUAL,DIVISION,
 SUM(LY_VOL)LY_VOL, SUM(LY_VALUE)LY_VALUE,SUM(LM_VOL)LM_VOL, SUM(LM_VALUE)LM_VALUE, SUM(CM_VOL)CM_VOL, SUM(CM_VALUE)CM_VALUE,
 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE,
 'A'FLG ,'R'FFLG  
 FROM #SUMDATA 
 group by iif(@SUMMARY=4,'',MATERIALCODE),iif(@SUMMARY=4,'',MATERIALNAME),BEAT_NAME,SALESMAN,STOCKIESTNAME,BRAND_MANUAL,SIZE_MANUAL,DIVISION

 UNION ALL

 SELECT  '' MATERIALCODE,	'  Total  '+IIF(@REPMODE=0,BEAT_NAME,NULL)BEAT,'  Total '+IIF(@REPMODE=1,SALESMAN,NULL)SALESMAN,'  Total '+IIF(@REPMODE=2,STOCKIESTNAME,NULL)STOCKEISTNAME,IIF(@REPMODE=0,BEAT_NAME,NULL)xBEAT,IIF(@REPMODE=1,SALESMAN,NULL)xSALESMAN,IIF(@REPMODE=2,STOCKIESTNAME,NULL)xSTOCKEISTNAME,	NULL  MATERIALNAME,	
 ''  BRAND_MANUAL,'' SIZE_MANUAL,'ZZZZZZZZZZ'  xBRAND_MANUAL,'ZZZZZZZZZZ' xSIZE_MANUAL, NULL DIVISION,
	 SUM(LY_VOL)LY_VOL, SUM(LY_VALUE)LY_VALUE,SUM(LM_VOL)LM_VOL, SUM(LM_VALUE)LM_VALUE, SUM(CM_VOL)CM_VOL, SUM(CM_VALUE)CM_VALUE,
 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE,
 'C'FLG,'B'FFLG
 FROM #SUMDATA
 GROUP BY IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL)

 UNION ALL
 SELECT  NULL,IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL),IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL),NULL MATERIALNAME,'   Total     '+BRAND_MANUAL,'   Total     '+SIZE_MANUAL,BRAND_MANUAL xBRAND_MANUAL,SIZE_MANUAL xSIZE_MANUAL,NULL DIVISION,
 SUM(LY_VOL)LY_VOL, SUM(LY_VALUE)LY_VALUE,SUM(LM_VOL)LM_VOL, SUM(LM_VALUE)LM_VALUE, SUM(CM_VOL)CM_VOL, SUM(CM_VALUE)CM_VALUE,
 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE,
'B' FLG	,	'B' FFLG --for brand and size total
 FROM #SUMDATA 
 WHERE @SUMMARY <> 4
 group by BRAND_MANUAL ,SIZE_MANUAL,IIF(@REPMODE=0,BEAT_NAME,NULL),IIF(@REPMODE=1,SALESMAN,NULL),IIF(@REPMODE=2,STOCKIESTNAME,NULL)

 ) SUUM

 ORDER BY    CASE @REPMODE WHEN 0 THEN XBEAT_NAME WHEN 1 THEN XSALESMAN  WHEN 2 THEN XSTOCKIESTNAME END  , SUUM.xBRAND_MANUAL  ,   SUUM.xSIZE_MANUAL ,FLG

 SELECT STOCKIESTNAME,	CONVERT(NUMERIC(32,2)	,LY_VOL)LY_VOL,
	 CONVERT(NUMERIC(32,0),LY_VALUE)LY_VALUE,
	 CONVERT(NUMERIC(32,2),LM_VOL)LM_VOL,	
	 CONVERT(NUMERIC(32,0),LM_VALUE)	LM_VALUE,
	 CONVERT(NUMERIC(32,2),CM_VOL)CM_VOL,
	 CONVERT(NUMERIC(32,0),CM_VALUE)CM_VALUE,
	 CONVERT(NUMERIC(32,2),GOLY_VOL)GOLY_VOL,	
	 CONVERT(NUMERIC(32,0),GOLY_VALUE)GOLY_VALUE,
	 CONVERT(NUMERIC(32,2),GOLM_VOL)GOLM_VOL	,
	 CONVERT(NUMERIC(32,0),GOLM_VALUE)GOLM_VALUE 
	 FROM (
 SELECT  'DNPL TOTAL :' STOCKIESTNAME,SUM(LY_VOL)LY_VOL, SUM(LY_VALUE)LY_VALUE,SUM(LM_VOL)LM_VOL, SUM(LM_VALUE)LM_VALUE, SUM(CM_VOL)CM_VOL, SUM(CM_VALUE)CM_VALUE,
 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE,'A' FLG
 FROM #SUMDATA
 UNION ALL
  SELECT  DIVISION +' TOTAL :' STOCKIESTNAME,SUM(LY_VOL)LY_VOL, SUM(LY_VALUE)LY_VALUE,SUM(LM_VOL)LM_VOL, SUM(LM_VALUE)LM_VALUE, SUM(CM_VOL)CM_VOL, SUM(CM_VALUE)CM_VALUE,
 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE,'B' FLG
 FROM #SUMDATA
 GROUP BY DIVISION
 ) A
 ORDER BY FLG ASC
	  

 END


 ELSE


 BEGIN

	IF OBJECT_ID('tempdb..#DATA2') is not null drop table #DATA2
	IF OBJECT_ID('TEMPDB..#SUMDATA2') is not null drop table #SUMDATA2

	select   IIF(@SUMMARY=1 ,BRAND_MANUAL,'')BRAND_MANUAL,
	IIF(@SUMMARY =2 ,SIZE_MANUAL,'')SIZE_MANUAL,
	IIF(@SUMMARY =3 ,SALESMAN,'')SALESMAN,
	IIF(@SUMMARY = 3,STOCKIESTNAME,'')STOCKIESTNAME,
	 DIVISIONS ,
		SUM(IIF(TRNDATE BETWEEN  DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2),RealQty,0))	AS LY_VOL,
		SUM(IIF(TRNDATE BETWEEN  DATEADD(year, -1, @DATE1) AND DATEADD(year, -1, @date2),AMOUNT,0))		AS LY_VALUE,
		SUM(IIF(TRNDATE BETWEEN  DATEADD (MM,-1, @DATE1) AND DATEADD (MM,-1, @DATE2),RealQty,0))		AS LM_VOL,
		SUM(IIF(TRNDATE BETWEEN  DATEADD (MM,-1, @DATE1) AND DATEADD (MM,-1, @DATE2),AMOUNT,0))			AS LM_VALUE,
		SUM(IIF(TRNDATE BETWEEN @DATE1 AND @DATE2,RealQty,0))		AS CM_VOL,
		SUM(IIF(TRNDATE BETWEEN @DATE1 AND @DATE2,AMOUNT,0))		AS CM_VALUE
	INTO #DATA2
	from #MAIN 
	 group by   
	 IIF(@SUMMARY=1 ,BRAND_MANUAL,''),
	 IIF(@SUMMARY =2 ,SIZE_MANUAL,''),
	 IIF(@SUMMARY  =3 ,SALESMAN,'') ,IIF(@SUMMARY = 3,STOCKIESTNAME,''),
	   DIVISIONS
  

 SELECT   STOCKIESTNAME,BRAND_MANUAL,SIZE_MANUAL,SALESMAN ,  DIVISIONS,	LY_VOL	,LY_VALUE	,LM_VOL	,LM_VALUE	,CM_VOL,	CM_VALUE,
 CASE WHEN LY_VOL=0 THEN 0 ELSE CAST ((CM_VOL-LY_VOL)/LY_VOL AS numeric(32,12))*100   END GOLY_VOL,
 CASE WHEN LY_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LY_VALUE)/LY_VALUE AS numeric(32,12))*100  END GOLY_VALUE,
 CASE WHEN LM_VOL=0 THEN 0 ELSE CAST((CM_VOL-LM_VOL)/LM_VOL AS numeric(32,12))*100  END GOLM_VOL,
 CASE WHEN LM_VALUE=0 THEN 0 ELSE CAST ((CM_VALUE-LM_VALUE)/LM_VALUE AS numeric(32,12))*100  END GOLM_VALUE  
 INTO #SUMDATA2
 FROM #DATA2 A  


 ---RESULT QUERY
 SELECT  NULL MATERIALCODE,
NULL BEAT,STOCKIESTNAME,NULL MATERIALNAME, BRAND_MANUAL,SIZE_MANUAL,SALESMAN ,DIVISIONS DIVISION,NULL DRCP, CONVERT(NUMERIC(32,2)	,LY_VOL)LY_VOL, 
	 CONVERT(NUMERIC(32,0),LY_VALUE)LY_VALUE,
	 CONVERT(NUMERIC(32,2),LM_VOL)LM_VOL,	
	 CONVERT(NUMERIC(32,0),LM_VALUE)	LM_VALUE,
	 CONVERT(NUMERIC(32,2),CM_VOL)CM_VOL,
	 CONVERT(NUMERIC(32,0),CM_VALUE)CM_VALUE,
	 CONVERT(NUMERIC(32,2),GOLY_VOL)GOLY_VOL,	
	 CONVERT(NUMERIC(32,0),GOLY_VALUE)GOLY_VALUE,
	 CONVERT(NUMERIC(32,2),GOLM_VOL)GOLM_VOL	,
	 CONVERT(NUMERIC(32,0),GOLM_VALUE)GOLM_VALUE ,	FLG,	FFLG FROM 
 (
 SELECT *,'A'FLG ,'R'FFLG  FROM #SUMDATA2


 UNION ALL

  SELECT 'TOTAL' STOCKIESTNAME,NULL BRAND_MANUAL,	NULL SIZE_MANUAL ,NULL SALESMAN ,DIVISIONS	,	  
	 SUM(LY_VOL)LY_VOL, 
	 SUM(LY_VALUE)LY_VALUE,
	 SUM(LM_VOL)LM_VOL,
	 SUM(LM_VALUE)LM_VALUE,
	 SUM(CM_VOL)CM_VOL,
	 SUM(CM_VALUE)CM_VALUE,
	 CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END GOLY_VOL,
	 CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END GOLY_VALUE,
	 CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END GOLM_VOL,
	 CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END GOLM_VALUE ,
	'B' FLG	,	'B' FFLG --for brand and size total
 FROM #SUMDATA2 group by DIVISIONS
 ) SUUM
 ORDER BY    DIVISIONS  ,FLG

 SELECT  'DNPL TOTAL : ' STOCKIESTNAME,
 CONVERT(NUMERIC(32,2),SUM(LY_VOL))LY_VOL, CONVERT(NUMERIC(32,0),SUM(LY_VALUE))LY_VALUE,CONVERT(NUMERIC(32,2),SUM(LM_VOL))LM_VOL,CONVERT(NUMERIC(32,0),SUM(LM_VALUE))LM_VALUE,CONVERT(NUMERIC(32,2),SUM(CM_VOL))CM_VOL,CONVERT(NUMERIC(32,0),SUM(CM_VALUE))CM_VALUE,
 CONVERT(NUMERIC(32,2),CASE WHEN SUM(LY_VOL)=0 THEN 0 ELSE CAST ((SUM(CM_VOL)-SUM(LY_VOL))/SUM(LY_VOL) AS numeric(32,12))*100   END) GOLY_VOL,
 CONVERT(NUMERIC(32,0),CASE WHEN SUM(LY_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LY_VALUE))/SUM(LY_VALUE) AS numeric(32,12))*100  END)GOLY_VALUE,
 CONVERT(NUMERIC(32,2),CASE WHEN SUM(LM_VOL)=0 THEN 0 ELSE CAST((SUM(CM_VOL)-SUM(LM_VOL))/SUM(LM_VOL) AS numeric(32,12))*100  END)GOLM_VOL,
 CONVERT(NUMERIC(32,0),CASE WHEN SUM(LM_VALUE)=0 THEN 0 ELSE CAST ((SUM(CM_VALUE)-SUM(LM_VALUE))/SUM(LM_VALUE) AS numeric(32,12))*100  END)GOLM_VALUE 
 FROM #SUMDATA2 
 
 END
